<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayaan's Advanced Timetable Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Firebase Initialization -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCt2oEmJIvovlTBauKdOvU5yOKeI5akejk",
            authDomain: "ayaan-b2447.firebaseapp.com",
            databaseURL: "https://ayaan-b2447-default-rtdb.firebaseio.com",
            projectId: "ayaan-b2447",
            storageBucket: "ayaan-b2447.firebasestorage.app",
            messagingSenderId: "889637045136",
            appId: "1:889637045136:web:e4e427e4466c7b5fb6a915",
            measurementId: "G-83MKS8WJHR"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // License key validation
        let isLicenseValid = false;
        let currentLicenseKey = null;
        let licensePollIntervalId = null;

        // Simple obfuscation helpers (not real encryption)
        function obfuscate(str) {
            const key = 173; // fixed XOR key for obfuscation
            const bytes = Array.from(str).map(c => c.charCodeAt(0) ^ key);
            return btoa(String.fromCharCode(...bytes));
        }
        function deobfuscate(str) {
            try {
                const decoded = atob(str);
                const key = 173;
                return Array.from(decoded).map(c => String.fromCharCode(c.charCodeAt(0) ^ key)).join('');
            } catch (e) {
                return null;
            }
        }
        function setSavedKey(key) {
            try { localStorage.setItem('lk', obfuscate(key)); } catch (_) {}
        }
        function getSavedKey() {
            try {
                const v = localStorage.getItem('lk');
                return v ? deobfuscate(v) : null;
            } catch (_) { return null; }
        }
        function clearSavedKey() {
            try { localStorage.removeItem('lk'); } catch (_) {}
        }
        
        function validateLicenseKey(key) {
            return database.ref('keys/' + key).once('value')
                .then((snapshot) => {
                    const licenseData = snapshot.val();
                    if (!licenseData) {
                        isLicenseValid = false;
                        clearSavedKey();
                        return false;
                    }
                    const status = licenseData.status;
                    const now = new Date();
                    const expiry = licenseData.expiry ? new Date(licenseData.expiry) : null;
                    const isExpired = !expiry || isNaN(expiry.getTime()) || expiry < now;
                    const isActive = status === 'active' && !isExpired;
                    if (isActive) {
                        isLicenseValid = true;
                        currentLicenseKey = key;
                        setSavedKey(key);
                        return true;
                    } else {
                        // Remove saved key if banned/blocked/expired/invalid
                        isLicenseValid = false;
                        clearSavedKey();
                        return false;
                    }
                })
                .catch((error) => {
                    console.error("Error validating license key:", error);
                    return false;
                });
        }

        function startLicensePolling() {
            if (licensePollIntervalId) return;
            // Re-check every 30 seconds
            licensePollIntervalId = setInterval(() => {
                if (!currentLicenseKey) return;
                validateLicenseKey(currentLicenseKey).then(valid => {
                    if (!valid) {
                        // Fail closed: show modal overlay again
                        showLicenseModal(true);
                    }
                });
            }, 30000);
        }
        
        // Check for saved license key on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedKey = getSavedKey();
            if (savedKey) {
                validateLicenseKey(savedKey)
                    .then(isValid => {
                        if (!isValid) {
                            showLicenseModal(true);
                        } else {
                            currentLicenseKey = savedKey;
                            startLicensePolling();
                        }
                    });
            } else {
                showLicenseModal(true);
            }
        });
        
        function showLicenseModal(force = false) {
            const modal = document.createElement('div');
            modal.className = 'license-modal';
            modal.id = 'licenseModal';
            
            modal.innerHTML = `
                <div class="license-modal-content">
                    <h2 class="text-3xl font-bold mb-6">License Verification Required</h2>
                    <div class="w-full max-w-md mx-auto">
                        <p class="mb-6 text-center">Please enter your license key to access Ayaan's Advanced Timetable Maker.</p>
                        <input type="password" id="licenseKeyInput" class="w-full p-3 border border-gray-600 rounded mb-6 bg-gray-800 text-white" placeholder="Enter your license key">
                        <div class="flex justify-center">
                            <button id="validateLicenseBtn" class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700 w-full">Validate License</button>
                        </div>
                        <p id="licenseMessage" class="mt-4 text-red-400 text-center"></p>
                    </div>
                </div>
            `;
            
            // Prevent duplicate modals
            const existing = document.getElementById('licenseModal');
            if (!existing || force) {
                if (existing) existing.remove();
                document.body.appendChild(modal);
            }
            
            // Mutation observer to re-add modal if removed while invalid
            const observer = new MutationObserver(() => {
                const present = document.getElementById('licenseModal');
                if (!present && !isLicenseValid) {
                    // Re-create modal
                    showLicenseModal(true);
                }
            });
            observer.observe(document.body, { childList: true, subtree: true });
            
            document.getElementById('validateLicenseBtn').addEventListener('click', function() {
                const licenseKey = document.getElementById('licenseKeyInput').value.trim();
                if (!licenseKey) {
                    document.getElementById('licenseMessage').textContent = 'Please enter a license key';
                    return;
                }
                
                validateLicenseKey(licenseKey)
                    .then(isValid => {
                        if (isValid) {
                            document.getElementById('licenseModal').remove();
                            currentLicenseKey = licenseKey;
                            startLicensePolling();
                        } else {
                            document.getElementById('licenseMessage').textContent = 'Invalid, expired, banned or blocked license key';
                        }
                    });
            });
            
            // Basic devtools detection; re-enforce overlay if devtools open and invalid
            let lastCheck = Date.now();
            setInterval(() => {
                const widthDiff = Math.abs((window.outerWidth || 0) - (window.innerWidth || 0));
                const heightDiff = Math.abs((window.outerHeight || 0) - (window.innerHeight || 0));
                const devtoolsLikely = widthDiff > 160 || heightDiff > 160; // heuristic
                if (devtoolsLikely && !isLicenseValid) {
                    const exists = document.getElementById('licenseModal');
                    if (!exists) showLicenseModal(true);
                }
                lastCheck = Date.now();
            }, 5000);
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* License key modal styles */
        .license-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .license-modal-content {
            background-color: #1a1a1a;
            padding: 2rem;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Shimmer animation for progress bar */
        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        .animate-shimmer {
            animation: shimmer 2s infinite;
        }
        
        /* Fade in animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Smooth bounce for dots */
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-8px);
            }
        }
        /* Alt theme: subtle full-app color shift */
        .alt-theme {
            filter: hue-rotate(165deg) saturate(1.15) contrast(1.02);
            transition: filter 200ms ease-in-out;
        }
        
        /* Highlight effect for redirected cards */
        @keyframes highlight-pulse {
          0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
          70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
          100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .highlight-card {
          animation: highlight-pulse 1.5s ease-out;
          border: 2px solid #3b82f6 !important;
          transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef, useCallback } = React;

        // --- LOCAL STORAGE HELPERS ---
        const APP_STORAGE_KEY = 'ayaan_timetable_app_state_v6'; // Updated version for new features

        const loadState = () => {
            try {
                const serializedState = localStorage.getItem(APP_STORAGE_KEY);
                if (serializedState === null) return undefined;
                return JSON.parse(serializedState);
            } catch (e) {
                console.warn("Could not load state from localStorage", e);
                return undefined;
            }
        };

        const saveState = (state) => {
            try {
                const serializedState = JSON.stringify(state);
                localStorage.setItem(APP_STORAGE_KEY, serializedState);
            } catch (e) {
                console.warn("Could not save state to localStorage", e);
            }
        };
        // --- END LOCAL STORAGE HELPERS ---


        // Custom UI components to simulate shadcn/ui and lucide-react
        const Button = ({ children, onClick, variant = 'default', className = '', ...props }) => {
          const baseClasses = 'px-4 py-2 rounded-md font-semibold transition-colors duration-200';
          const variantClasses = {
            default: 'bg-blue-600 text-white hover:bg-blue-700',
            secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300',
            outline: 'bg-transparent border border-gray-400 text-gray-800 hover:bg-gray-100',
            success: 'bg-green-600 text-white hover:bg-green-700',
            danger: 'bg-red-600 text-white hover:bg-red-700'
          };
          return (
            <button onClick={onClick} className={`${baseClasses} ${variantClasses[variant]} ${className}`} {...props}>
              {children}
            </button>
          );
        };

        const Input = ({ type = 'text', value, onChange, placeholder, className = '', ...props }) => {
          const baseClasses = 'w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
          return (
            <input
              type={type}
              value={value}
              onChange={onChange}
              placeholder={placeholder}
              className={`${baseClasses} ${className}`}
              {...props}
            />
          );
        };

        const Select = ({ value, onChange, options = [], className = '', ...props }) => { 
          const baseClasses = 'w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white';
          return (
            <select value={value} onChange={onChange} className={`${baseClasses} ${className}`} {...props} style={{minHeight: '38px'}}>
              {options.map((option, index) => (
                <option key={index} value={option.value} style={{padding: '8px', backgroundColor: 'white'}}>{option.label}</option>
              ))}
            </select>
          );
        };

        const Card = ({ children, className = '' }) => {
          return (
            <div className={`bg-white p-6 rounded-xl shadow-md ${className}`}>
              {children}
            </div>
          );
        };
        
        // Custom SVG icons to replace lucide-react to prevent errors
        const ToggleLeftIcon = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <rect x="2" y="6" width="20" height="12" rx="6" />
            <circle cx="8" cy="12" r="4" />
          </svg>
        );

        const ToggleRightIcon = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <rect x="2" y="6" width="20" height="12" rx="6" />
            <circle cx="16" cy="12" r="4" />
          </svg>
        );

        // Loading spinner component
        const LoadingSpinner = () => (
          <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        );

        const DownloadIcon = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" x2="12" y1="15" y2="3" />
          </svg>
        );

        const FileTextIcon = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14 2 14 8 20 8" />
            <line x1="16" y1="13" x2="8" y2="13" />
            <line x1="16" y1="17" x2="8" y2="17" />
            <line x1="10" y1="9" x2="8" y2="9" />
          </svg>
        );

        const HomeIcon = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
            <polyline points="9 22 9 12 15 12 15 22" />
          </svg>
        );
        
        const MenuIcon = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <line x1="4" y1="12" x2="20" y2="12" />
            <line x1="4" y1="6" x2="20" y2="6" />
            <line x1="4" y1="18" x2="20" y2="18" />
          </svg>
        );

        const XIcon = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        );
        
        const TrashIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 6h18" />
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" />
                <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
            </svg>
        );
        
        const CheckIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="20 6 9 17 4 12" />
            </svg>
        );
        
        const UserIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
                <circle cx="12" cy="7" r="4" />
            </svg>
        );

        const CalendarIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                <line x1="16" y1="2" x2="16" y2="6" />
                <line x1="8" y1="2" x2="8" y2="6" />
                <line x1="3" y1="10" x2="21" y2="10" />
            </svg>
        );

        const AlertCircleIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="8" x2="12" y2="12" />
                <line x1="12" y1="16" x2="12.01" y2="16" />
            </svg>
        );

        const BarChartIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="20" x2="12" y2="10" />
                <line x1="18" y1="20" x2="18" y2="4" />
                <line x1="6" y1="20" x2="6" y2="16" />
            </svg>
        );


        // Helper function to determine the content and styling for a period cell
        const getCellContent = (lesson, periodIndex, day, periodsPerDay, halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, absentTeachers, proxyAssignments, originalTimetable, freeClassReasons) => {
            const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
            const isHalfDayOvershot = periodIndex >= periodsForDay;
            const isLunchPeriod = periodIndex === lunchBreakPeriod - 1;

            if (isHalfDayOvershot) {
                return { subject: 'Not Scheduled', teacher: null, className: 'Not Scheduled', isBreak: false, isFree: false, bgClass: 'bg-red-50 text-red-800' };
            }

            if (isLunchPeriod) {
                return { subject: breakLabel, teacher: null, className: breakLabel, isBreak: true, isFree: false, bgClass: 'bg-yellow-100 text-yellow-800 font-bold' };
            }

            // Determine if this is a class view or teacher view
            const isClassView = lesson.subject !== undefined;
            
            // For class view, construct the proxy key directly
            let proxyKey = null;
            let assignedProxy = null;
            
            if (isClassView && lesson.className) {
                // Class view - check if there's a proxy for this class at this slot
                proxyKey = `${lesson.className}-${day}-${periodIndex}`;
                assignedProxy = proxyAssignments[proxyKey];
                
                // Get the original teacher for this class slot
                const originalLesson = originalTimetable?.[lesson.className]?.[day]?.[periodIndex];
                const originalTeacher = originalLesson?.teacher;
                
                // If there's a proxy assigned, show it
                if (assignedProxy) {
                    return {
                        subject: lesson.subject || originalLesson?.subject,
                        teacher: assignedProxy,
                        originalTeacher: originalTeacher, // Include original teacher info
                        className: lesson.className,
                        isBreak: false,
                        isFree: false,
                        isProxy: true,
                        bgClass: 'bg-purple-200 text-purple-900 font-bold'
                    };
                }
                
                // If the original teacher is absent and no proxy assigned
                if (originalTeacher && absentTeachers.includes(originalTeacher)) {
                    return {
                        subject: 'ABSENT',
                        teacher: originalTeacher,
                        className: lesson.className,
                        isBreak: false,
                        isFree: false,
                        isAbsent: true,
                        bgClass: 'bg-red-200 text-red-800 font-bold'
                    };
                }
            } else {
                // Teacher view - check if this teacher is assigned as a proxy somewhere
                const teacherName = lesson.teacher || lesson.className;
                
                // Check if this teacher is assigned as a proxy for any class at this slot
                for (const [key, proxyTeacher] of Object.entries(proxyAssignments)) {
                    const [cls, assignedDay, assignedPeriodStr] = key.split('-');
                    const assignedPeriod = parseInt(assignedPeriodStr);
                    
                    if (assignedDay === day && assignedPeriod === periodIndex && proxyTeacher === teacherName) {
                        // This teacher is assigned as a proxy
                        const originalLesson = originalTimetable?.[cls]?.[day]?.[periodIndex];
                        return {
                            subject: originalLesson?.subject || 'Proxy Assignment',
                            teacher: null,
                            className: cls,
                            isBreak: false,
                            isFree: false,
                            isProxy: true,
                            bgClass: 'bg-purple-200 text-purple-900 font-bold'
                        };
                    }
                }
                
                // Check if this teacher is absent
                if (teacherName && absentTeachers.includes(teacherName)) {
                    // Find which class this teacher was supposed to teach
                    let classForSlot = null;
                    for (const cls of Object.keys(originalTimetable || {})) {
                        const originalLesson = originalTimetable[cls]?.[day]?.[periodIndex];
                        if (originalLesson && originalLesson.teacher === teacherName) {
                            classForSlot = cls;
                            break;
                        }
                    }
                    
                    // Check if there's a proxy assigned for this slot
                    const proxyKeyForTeacher = classForSlot ? `${classForSlot}-${day}-${periodIndex}` : null;
                    const assignedProxyForTeacher = proxyKeyForTeacher ? proxyAssignments[proxyKeyForTeacher] : null;
                    
                    return {
                        subject: 'ABSENT',
                        teacher: teacherName,
                        className: classForSlot || lesson.className,
                        isBreak: false,
                        isFree: false,
                        isAbsent: true,
                        assignedProxy: assignedProxyForTeacher,
                        bgClass: 'bg-red-200 text-red-800 font-bold'
                    };
                }
            }

            // Normal lesson logic (fallback for non-absent, non-proxy cases)
            const subjectOrClass = isClassView ? lesson.subject : lesson.className;
            const isFree = subjectOrClass === 'Free' || subjectOrClass === null;
            const isEvent = isClassView && lesson.teacher === 'Event Coordinator';
            const isConflict = subjectOrClass && subjectOrClass.includes('CONFLICT');
            
            let bgClass = '';
            let freeReason = null;
            
            if (isFree) {
                bgClass = 'bg-gray-100 text-gray-500';
                // Check if there's a reason for this free class
                if (isClassView && lesson.className && freeClassReasons) {
                    const reasonKey = `${lesson.className}-${day}-${periodIndex}`;
                    freeReason = freeClassReasons[reasonKey];
                }
            } else if (isEvent) {
                bgClass = 'bg-purple-100 text-purple-800 font-bold';
            } else if (isConflict) {
                bgClass = 'bg-red-200 text-red-800 font-bold';
            } else if (isClassView) {
                bgClass = 'bg-blue-50 text-blue-800';
            } else {
                bgClass = 'bg-green-50 text-green-800';
            }

            return {
                subject: isClassView ? subjectOrClass : lesson.subject,
                teacher: isClassView ? lesson.teacher : null,
                className: isClassView ? null : subjectOrClass,
                isBreak: false,
                isFree: isFree,
                freeReason: freeReason,
                bgClass: bgClass
            };
        };

        // Modal for Proxy Assignment
        const ProxyAssignmentModal = ({ isOpen, onClose, availableTeachers, onAssignProxy, periodInfo, onRemoveProxy }) => {
            const [selectedProxy, setSelectedProxy] = useState('');

            useEffect(() => {
                if (isOpen && periodInfo) {
                    const currentProxy = periodInfo.currentProxy;
                    setSelectedProxy(currentProxy || ''); // Set current proxy if exists
                }
            }, [isOpen, periodInfo]);

            if (!isOpen || !periodInfo) return null;

            const handleAssign = () => {
                if (selectedProxy) {
                    onAssignProxy(periodInfo.className, periodInfo.day, periodInfo.periodIndex, selectedProxy);
                    onClose();
                } else {
                    alert('Please select a proxy teacher.');
                }
            };

            const handleRemove = () => {
                if (confirm('Are you sure you want to remove this proxy assignment?')) {
                    onRemoveProxy(periodInfo.className, periodInfo.day, periodInfo.periodIndex);
                    onClose();
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <Card className="w-full max-w-md space-y-4">
                        <h3 className="text-xl font-bold text-gray-900">Assign Proxy for {periodInfo.className} - {periodInfo.day}, P{periodInfo.periodIndex + 1}</h3>
                        <p className="text-sm text-gray-600">Original Teacher: <span className="font-semibold text-red-700">{periodInfo.originalTeacher}</span></p>
                        <p className="text-sm text-gray-600">Subject: <span className="font-semibold">{periodInfo.subject}</span></p>
                        {periodInfo.currentProxy && (
                            <p className="text-sm text-purple-700 font-semibold">Currently assigned: {periodInfo.currentProxy}</p>
                        )}

                        <div>
                            <label htmlFor="proxy-teacher-select" className="block text-sm font-medium text-gray-700 mb-1">Select Proxy Teacher:</label>
                            <Select
                                id="proxy-teacher-select"
                                value={selectedProxy}
                                onChange={(e) => setSelectedProxy(e.target.value)}
                                options={[{ value: '', label: 'Choose a teacher' }, ...availableTeachers.map(t => ({ value: t, label: t }))]}
                            />
                        </div>

                        <div className="flex justify-end space-x-3">
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            {periodInfo.currentProxy && (
                                <Button variant="danger" onClick={handleRemove}>Remove Proxy</Button>
                            )}
                            <Button variant="default" onClick={handleAssign}>Assign Proxy</Button>
                        </div>
                    </Card>
                </div>
            );
        };


        // Manual Placement Modal (enhanced validation and guidance)
        const ManualPlacementModal = ({ isOpen, onClose, classes, subjects, teachers, workingDayLabels, periodsPerDay, onApply, onClear, timetable, subjectPeriodsPerWeek, assignments, halfDayPeriods, halfDays, lunchBreakPeriod, teacherStartPeriod, lastPeriodSubjectRestrictions, ensureTeacherFreePeriod }) => {
            const [selectedClass, setSelectedClass] = useState('');
            const [selectedDay, setSelectedDay] = useState('');
            const [selectedPeriod, setSelectedPeriod] = useState(1);
            const [selectedSubject, setSelectedSubject] = useState('');
            const [selectedTeacher, setSelectedTeacher] = useState('');

            // Helper: compute requested and scheduled counts for current selection
            const requestedCount = useMemo(() => {
                return subjectPeriodsPerWeek?.[selectedClass]?.[selectedSubject] || 0;
            }, [subjectPeriodsPerWeek, selectedClass, selectedSubject]);

            const scheduledCount = useMemo(() => {
                if (!timetable || !selectedClass || !selectedSubject) return 0;
                let count = 0;
                workingDayLabels.forEach(day => {
                    const pForDay = halfDays?.includes(day) ? halfDayPeriods : periodsPerDay;
                    for (let p = 0; p < pForDay; p++) {
                        if (p === (lunchBreakPeriod - 1)) continue;
                        const lesson = timetable[selectedClass]?.[day]?.[p];
                        if (lesson && lesson.subject === selectedSubject) count++;
                    }
                });
                return count;
            }, [timetable, selectedClass, selectedSubject, workingDayLabels, periodsPerDay, halfDays, halfDayPeriods, lunchBreakPeriod]);

            // Enforce assigned teacher for subject (minimize misplacements)
            const assignedTeacher = useMemo(() => assignments?.[selectedClass]?.[selectedSubject] || '', [assignments, selectedClass, selectedSubject]);

            useEffect(() => {
                if (assignedTeacher) {
                    setSelectedTeacher(assignedTeacher);
                }
            }, [assignedTeacher]);

            // Helper: validate if a slot is placeable for current selection
            const canPlaceHere = (day, periodIndex) => {
                if (!selectedClass || !selectedSubject || !selectedTeacher) return false;
                const pForDay = halfDays?.includes(day) ? (halfDayPeriods) : periodsPerDay;
                if (periodIndex < 0 || periodIndex >= pForDay) return false;
                if (periodIndex === (lunchBreakPeriod - 1)) return false;
                const startP = (teacherStartPeriod?.[selectedTeacher] || 1) - 1;
                if (periodIndex < startP) return false;
                const isLast = periodIndex === pForDay - 1;
                const restricted = lastPeriodSubjectRestrictions?.some(r => r.className === selectedClass && r.subject === selectedSubject);
                if (isLast && restricted) return false;
                const tSlot = timetable && timetable[selectedClass]?.[day]?.[periodIndex];
                // teacher availability needs teacher timetable, but approximate: block if class slot already occupied by non-free
                if (tSlot && tSlot.subject && tSlot.subject !== 'Free') return false;
                // respect teacher free period constraint softly by not checking here; applyManualPlacement revalidates strictly
                return true;
            };

            // Find next valid slot for current selection
            const findNextValidSlot = () => {
                if (!selectedClass || !selectedSubject || !selectedTeacher) return;
                // Iterate days then periods to find first placeable
                for (const day of workingDayLabels) {
                    const pForDay = halfDays?.includes(day) ? (halfDayPeriods) : periodsPerDay;
                    for (let p = 0; p < pForDay; p++) {
                        if (canPlaceHere(day, p)) {
                            setSelectedDay(day);
                            setSelectedPeriod(p + 1);
                            return;
                        }
                    }
                }
                alert('No immediately valid slot found for this subject/teacher with current constraints.');
            };

            useEffect(() => {
                if (isOpen) {
                    setSelectedClass(classes[0] || '');
                    setSelectedDay(workingDayLabels[0] || '');
                    setSelectedPeriod(1);
                    setSelectedSubject(subjects[0] || '');
                    // prefer the assigned teacher for the first subject
                    const firstAssigned = assignments?.[classes[0]]?.[subjects[0]] || teachers[0] || '';
                    setSelectedTeacher(firstAssigned);
                }
            }, [isOpen, classes, subjects, teachers, workingDayLabels, assignments]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <Card className="w-full max-w-xl space-y-4">
                        <h3 className="text-xl font-bold text-gray-900">Manual Placement</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Class</label>
                                <Select value={selectedClass} onChange={(e) => setSelectedClass(e.target.value)} options={classes.map(c => ({ value: c, label: c }))} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Day</label>
                                <Select value={selectedDay} onChange={(e) => setSelectedDay(e.target.value)} options={workingDayLabels.map(d => ({ value: d, label: d }))} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Period</label>
                                <Select value={selectedPeriod} onChange={(e) => setSelectedPeriod(parseInt(e.target.value))} options={Array.from({ length: periodsPerDay }).map((_, i) => ({ value: i + 1, label: `P${i + 1}` }))} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                                <Select value={selectedSubject} onChange={(e) => setSelectedSubject(e.target.value)} options={subjects.map(s => ({ value: s, label: s }))} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Teacher</label>
                                <Select value={selectedTeacher} onChange={(e) => setSelectedTeacher(e.target.value)} options={assignedTeacher ? [{ value: assignedTeacher, label: assignedTeacher }] : teachers.map(t => ({ value: t, label: t }))} />
                            </div>
                        </div>
                        {/* Subject Demand Indicator */}
                        {selectedClass && selectedSubject && (
                          <div className="p-2 bg-gray-50 rounded border text-sm flex items-center justify-between">
                            <span className="text-gray-700">{selectedSubject} for {selectedClass}</span>
                            <span className="font-semibold">{scheduledCount}/{requestedCount} scheduled</span>
                          </div>
                        )}
                        <div className="flex items-center gap-3">
                            <Button variant="secondary" onClick={findNextValidSlot}>Find Next Valid Slot</Button>
                            {requestedCount > 0 && scheduledCount >= requestedCount && (
                              <span className="text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-800 font-semibold">Max reached</span>
                            )}
                        </div>
                        <div className="flex justify-end gap-3">
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button variant="danger" onClick={() => onClear(selectedClass, selectedDay, selectedPeriod - 1)}>Clear Slot</Button>
                            <Button onClick={() => onApply({ className: selectedClass, day: selectedDay, periodIndex: selectedPeriod - 1, subject: selectedSubject, teacher: selectedTeacher })}>Apply</Button>
                        </div>
                    </Card>
                </div>
            );
        };
        // Component for Analytics View
        const AnalyticsView = ({ teachers, classes, timetable, teacherTimetable, workingDayLabels, periodsPerDay, halfDayPeriods, halfDays, lunchBreakPeriod, absentTeachers, proxyAssignments, originalTimetable, freeClassReasons }) => {
            // Calculate analytics data
            const analytics = useMemo(() => {
                if (!timetable || !teacherTimetable) {
                    return null;
                }

                // Teacher analytics
                const teacherStats = teachers.map(teacher => {
                    let totalPeriods = 0;
                    let freePeriods = 0;
                    let proxyPeriods = 0;
                    const subjectsTaught = new Set();
                    const classesHandled = new Set();

                    workingDayLabels.forEach(day => {
                        const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                        
                        for (let periodIndex = 0; periodIndex < periodsForDay; periodIndex++) {
                            // Skip lunch period
                            if (periodIndex === lunchBreakPeriod - 1) continue;

                            const lesson = teacherTimetable[teacher]?.[day]?.[periodIndex];
                            
                            if (lesson) {
                                totalPeriods++;
                                
                                if (lesson.className === 'Free' || lesson.className === null) {
                                    freePeriods++;
                                } else {
                                    classesHandled.add(lesson.className);
                                    if (lesson.subject) {
                                        subjectsTaught.add(lesson.subject);
                                    }
                                }
                            }

                            // Check if teaching as proxy
                            for (const [key, proxyTeacher] of Object.entries(proxyAssignments)) {
                                const [cls, assignedDay, assignedPeriodStr] = key.split('-');
                                const assignedPeriod = parseInt(assignedPeriodStr);
                                
                                if (assignedDay === day && assignedPeriod === periodIndex && proxyTeacher === teacher) {
                                    proxyPeriods++;
                                }
                            }
                        }
                    });

                    const workload = totalPeriods > 0 ? ((totalPeriods - freePeriods) / totalPeriods * 100).toFixed(1) : 0;

                    return {
                        name: teacher,
                        totalPeriods,
                        freePeriods,
                        teachingPeriods: totalPeriods - freePeriods,
                        proxyPeriods,
                        workload: parseFloat(workload),
                        subjectsTaught: Array.from(subjectsTaught),
                        classesHandled: Array.from(classesHandled),
                        isAbsent: absentTeachers.includes(teacher)
                    };
                });

                // Class analytics
                const classStats = classes.map(className => {
                    let totalPeriods = 0;
                    let freePeriods = 0;
                    let eventPeriods = 0;
                    let proxyPeriods = 0;
                    const teachersAssigned = new Set();
                    const subjectsScheduled = new Set();

                    workingDayLabels.forEach(day => {
                        const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                        
                        for (let periodIndex = 0; periodIndex < periodsForDay; periodIndex++) {
                            // Skip lunch period
                            if (periodIndex === lunchBreakPeriod - 1) continue;

                            const lesson = timetable[className]?.[day]?.[periodIndex];
                            
                            if (lesson) {
                                totalPeriods++;
                                
                                if (lesson.subject === 'Free' || lesson.subject === null) {
                                    freePeriods++;
                                } else {
                                    if (lesson.teacher === 'Event Coordinator') {
                                        eventPeriods++;
                                    } else {
                                        subjectsScheduled.add(lesson.subject);
                                        if (lesson.teacher) {
                                            teachersAssigned.add(lesson.teacher);
                                        }
                                    }
                                }
                            }

                            // Check if has proxy assigned
                            const proxyKey = `${className}-${day}-${periodIndex}`;
                            if (proxyAssignments[proxyKey]) {
                                proxyPeriods++;
                            }
                        }
                    });

                    const utilization = totalPeriods > 0 ? ((totalPeriods - freePeriods) / totalPeriods * 100).toFixed(1) : 0;

                    return {
                        name: className,
                        totalPeriods,
                        freePeriods,
                        scheduledPeriods: totalPeriods - freePeriods,
                        eventPeriods,
                        proxyPeriods,
                        utilization: parseFloat(utilization),
                        teachersAssigned: Array.from(teachersAssigned),
                        subjectsScheduled: Array.from(subjectsScheduled)
                    };
                });

                // Teacher overall statistics
                const totalTeachingPeriods = teacherStats.reduce((sum, t) => sum + t.teachingPeriods, 0);
                const totalTeacherFreePeriods = teacherStats.reduce((sum, t) => sum + t.freePeriods, 0);
                const totalTeacherProxyPeriods = teacherStats.reduce((sum, t) => sum + t.proxyPeriods, 0);
                const avgTeacherWorkload = teacherStats.length > 0 
                    ? (teacherStats.reduce((sum, t) => sum + t.workload, 0) / teacherStats.length).toFixed(1)
                    : 0;
                const maxTeacherWorkload = teacherStats.length > 0 
                    ? Math.max(...teacherStats.map(t => t.workload))
                    : 0;
                const minTeacherWorkload = teacherStats.length > 0 
                    ? Math.min(...teacherStats.map(t => t.workload))
                    : 0;

                // Class overall statistics
                const totalClassScheduledPeriods = classStats.reduce((sum, c) => sum + c.scheduledPeriods, 0);
                const totalClassFreePeriods = classStats.reduce((sum, c) => sum + c.freePeriods, 0);
                const totalClassEventPeriods = classStats.reduce((sum, c) => sum + c.eventPeriods, 0);
                const totalClassProxyPeriods = classStats.reduce((sum, c) => sum + c.proxyPeriods, 0);
                const avgClassUtilization = classStats.length > 0 
                    ? (classStats.reduce((sum, c) => sum + c.utilization, 0) / classStats.length).toFixed(1)
                    : 0;

                return {
                    teacherStats,
                    classStats,
                    teacherOverall: {
                        totalTeachers: teachers.length,
                        totalTeachingPeriods,
                        totalFreePeriods: totalTeacherFreePeriods,
                        totalProxyPeriods: totalTeacherProxyPeriods,
                        avgWorkload: parseFloat(avgTeacherWorkload),
                        maxWorkload: maxTeacherWorkload,
                        minWorkload: minTeacherWorkload,
                        absentTeachersCount: absentTeachers.length,
                        activeTeachersCount: teachers.length - absentTeachers.length
                    },
                    classOverall: {
                        totalClasses: classes.length,
                        totalScheduledPeriods: totalClassScheduledPeriods,
                        totalFreePeriods: totalClassFreePeriods,
                        totalEventPeriods: totalClassEventPeriods,
                        totalProxyPeriods: totalClassProxyPeriods,
                        avgUtilization: parseFloat(avgClassUtilization),
                        workingDays: workingDayLabels.length
                    }
                };
            }, [teachers, classes, timetable, teacherTimetable, workingDayLabels, periodsPerDay, halfDayPeriods, halfDays, lunchBreakPeriod, absentTeachers, proxyAssignments]);

            if (!analytics) {
                return (
                    <Card className="text-center p-8">
                        <p className="text-2xl font-bold text-red-600">No Timetable Generated</p>
                        <p className="mt-2 text-gray-600">Please generate a timetable to view analytics.</p>
                    </Card>
                );
            }

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-xl sm:text-3xl font-bold text-gray-900">Timetable Analytics</h2>
                    </div>

                    {/* Teacher Overall Statistics */}
                    <Card>
                        <h3 className="text-lg font-bold text-gray-900 mb-4">Teacher Overview</h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="text-center p-4 bg-blue-50 rounded-lg">
                                <div className="text-3xl font-bold text-blue-600">{analytics.teacherOverall.totalTeachers}</div>
                                <div className="text-sm text-gray-600 mt-1">Total Teachers</div>
                            </div>
                            <div className="text-center p-4 bg-green-50 rounded-lg">
                                <div className="text-3xl font-bold text-green-600">{analytics.teacherOverall.activeTeachersCount}</div>
                                <div className="text-sm text-gray-600 mt-1">Active Teachers</div>
                            </div>
                            <div className="text-center p-4 bg-red-50 rounded-lg">
                                <div className="text-3xl font-bold text-red-600">{analytics.teacherOverall.absentTeachersCount}</div>
                                <div className="text-sm text-gray-600 mt-1">Absent Teachers</div>
                            </div>
                            <div className="text-center p-4 bg-purple-50 rounded-lg">
                                <div className="text-3xl font-bold text-purple-600">{analytics.teacherOverall.avgWorkload}%</div>
                                <div className="text-sm text-gray-600 mt-1">Avg Workload</div>
                            </div>
                            <div className="text-center p-4 bg-indigo-50 rounded-lg">
                                <div className="text-3xl font-bold text-indigo-600">{analytics.teacherOverall.totalTeachingPeriods}</div>
                                <div className="text-sm text-gray-600 mt-1">Total Teaching Periods</div>
                            </div>
                            <div className="text-center p-4 bg-teal-50 rounded-lg">
                                <div className="text-3xl font-bold text-teal-600">{analytics.teacherOverall.totalFreePeriods}</div>
                                <div className="text-sm text-gray-600 mt-1">Total Free Periods</div>
                            </div>
                            <div className="text-center p-4 bg-orange-50 rounded-lg">
                                <div className="text-3xl font-bold text-orange-600">{analytics.teacherOverall.totalProxyPeriods}</div>
                                <div className="text-sm text-gray-600 mt-1">Proxy Periods</div>
                            </div>
                            <div className="text-center p-4 bg-yellow-50 rounded-lg">
                                <div className="text-xl font-bold text-yellow-600">{analytics.teacherOverall.minWorkload.toFixed(1)}% - {analytics.teacherOverall.maxWorkload.toFixed(1)}%</div>
                                <div className="text-sm text-gray-600 mt-1">Workload Range</div>
                            </div>
                        </div>
                    </Card>

                    {/* Teacher Analytics */}
                    <Card>
                        <h3 className="text-lg font-bold text-gray-900 mb-4">Teacher Analytics</h3>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teacher</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teaching Periods</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Free Periods</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proxy Periods</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Workload</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Classes</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subjects</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {analytics.teacherStats.map(teacher => (
                                        <tr key={teacher.name} className={teacher.isAbsent ? 'bg-red-50' : ''}>
                                            <td className="px-4 py-3 whitespace-nowrap font-medium text-gray-900">
                                                {teacher.name}
                                                {teacher.isAbsent && <span className="ml-2 text-xs bg-red-200 text-red-800 px-2 py-1 rounded">ABSENT</span>}
                                            </td>
                                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{teacher.teachingPeriods}</td>
                                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{teacher.freePeriods}</td>
                                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{teacher.proxyPeriods}</td>
                                            <td className="px-4 py-3 whitespace-nowrap">
                                                <div className="flex items-center">
                                                    <div className="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                                        <div 
                                                            className={`h-2 rounded-full ${
                                                                teacher.workload > 80 ? 'bg-red-500' : 
                                                                teacher.workload > 60 ? 'bg-yellow-500' : 
                                                                'bg-green-500'
                                                            }`}
                                                            style={{ width: `${teacher.workload}%` }}
                                                        ></div>
                                                    </div>
                                                    <span className="text-sm text-gray-700">{teacher.workload}%</span>
                                                </div>
                                            </td>
                                            <td className="px-4 py-3 text-sm text-gray-700">{teacher.classesHandled.join(', ') || '-'}</td>
                                            <td className="px-4 py-3 text-sm text-gray-700">{teacher.subjectsTaught.join(', ') || '-'}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>

                    {/* Class Overall Statistics */}
                    <Card>
                        <h3 className="text-lg font-bold text-gray-900 mb-4">Class Overview</h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="text-center p-4 bg-green-50 rounded-lg">
                                <div className="text-3xl font-bold text-green-600">{analytics.classOverall.totalClasses}</div>
                                <div className="text-sm text-gray-600 mt-1">Total Classes</div>
                            </div>
                            <div className="text-center p-4 bg-indigo-50 rounded-lg">
                                <div className="text-3xl font-bold text-indigo-600">{analytics.classOverall.totalScheduledPeriods}</div>
                                <div className="text-sm text-gray-600 mt-1">Scheduled Periods</div>
                            </div>
                            <div className="text-center p-4 bg-teal-50 rounded-lg">
                                <div className="text-3xl font-bold text-teal-600">{analytics.classOverall.totalFreePeriods}</div>
                                <div className="text-sm text-gray-600 mt-1">Free Periods</div>
                            </div>
                            <div className="text-center p-4 bg-purple-50 rounded-lg">
                                <div className="text-3xl font-bold text-purple-600">{analytics.classOverall.totalEventPeriods}</div>
                                <div className="text-sm text-gray-600 mt-1">Event Periods</div>
                            </div>
                            <div className="text-center p-4 bg-orange-50 rounded-lg">
                                <div className="text-3xl font-bold text-orange-600">{analytics.classOverall.totalProxyPeriods}</div>
                                <div className="text-sm text-gray-600 mt-1">Proxy Periods</div>
                            </div>
                            <div className="text-center p-4 bg-blue-50 rounded-lg">
                                <div className="text-3xl font-bold text-blue-600">{analytics.classOverall.avgUtilization}%</div>
                                <div className="text-sm text-gray-600 mt-1">Avg Utilization</div>
                            </div>
                            <div className="text-center p-4 bg-gray-50 rounded-lg">
                                <div className="text-3xl font-bold text-gray-600">{analytics.classOverall.workingDays}</div>
                                <div className="text-sm text-gray-600 mt-1">Working Days</div>
                            </div>
                            <div className="text-center p-4 bg-pink-50 rounded-lg">
                                <div className="text-3xl font-bold text-pink-600">{periodsPerDay}</div>
                                <div className="text-sm text-gray-600 mt-1">Periods Per Day</div>
                            </div>
                        </div>
                    </Card>

                    {/* Class Analytics */}
                    <Card>
                        <h3 className="text-lg font-bold text-gray-900 mb-4">Class Analytics</h3>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scheduled Periods</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Free Periods</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event Periods</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proxy Periods</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Utilization</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teachers</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subjects</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {analytics.classStats.map(cls => (
                                        <tr key={cls.name}>
                                            <td className="px-4 py-3 whitespace-nowrap font-medium text-gray-900">{cls.name}</td>
                                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{cls.scheduledPeriods}</td>
                                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{cls.freePeriods}</td>
                                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{cls.eventPeriods}</td>
                                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{cls.proxyPeriods}</td>
                                            <td className="px-4 py-3 whitespace-nowrap">
                                                <div className="flex items-center">
                                                    <div className="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                                        <div 
                                                            className="bg-blue-500 h-2 rounded-full"
                                                            style={{ width: `${cls.utilization}%` }}
                                                        ></div>
                                                    </div>
                                                    <span className="text-sm text-gray-700">{cls.utilization}%</span>
                                                </div>
                                            </td>
                                            <td className="px-4 py-3 text-sm text-gray-700">{cls.teachersAssigned.length}</td>
                                            <td className="px-4 py-3 text-sm text-gray-700">{cls.subjectsScheduled.join(', ') || '-'}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            );
        };

        // Component for Proxy Management
        const ProxyManagementView = ({ teachers, teacherTimetable, workingDayLabels, periodsPerDay, halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, absentTeachers, proxyTeachers, proxyAssignments, onAssignProxy, onRemoveProxy, originalTimetable, getAvailableProxyTeachersForPeriod, onExportPDF, onExportCSV, onExportHTML, isExporting }) => {
            const [selectedDay, setSelectedDay] = useState(workingDayLabels[0] || 'Monday');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalPeriodInfo, setModalPeriodInfo] = useState(null);

            const periodLabels = useMemo(() => Array.from({ length: periodsPerDay }).map((_, i) => `P${i + 1}`), [periodsPerDay]);

            if (!teacherTimetable || !originalTimetable) {
                return (
                    <Card className="text-center p-8">
                        <p className="text-2xl font-bold text-red-600">No Timetable Generated</p>
                        <p className="mt-2 text-gray-600">Please click a 'Generate Timetable' button to view teacher availability for proxy assignment.</p>
                    </Card>
                );
            }

            const teachersOnSelectedDay = teachers.filter(teacher => teacherTimetable[teacher] && teacherTimetable[teacher][selectedDay]);
            const periodsForSelectedDay = halfDays.includes(selectedDay) ? halfDayPeriods : periodsPerDay;

            const handleCellClick = (teacher, day, periodIndex) => {
                // Find the class that this teacher was supposed to teach at this slot
                let classNameForSlot = null;
                for (const cls of Object.keys(originalTimetable)) {
                    const lesson = originalTimetable[cls]?.[day]?.[periodIndex];
                    if (lesson && lesson.teacher === teacher) {
                        classNameForSlot = cls;
                        break;
                    }
                }

                if (!classNameForSlot) {
                    // If the teacher wasn't originally assigned to a class at this slot,
                    // or if it's a free period for them, we can't assign a proxy for a specific class.
                    // This view is primarily for assigning proxies to *absent* teachers' classes.
                    console.log(`Teacher ${teacher} was not originally assigned to a class at ${day}, P${periodIndex}. Cannot assign proxy via this cell.`);
                    return;
                }

                const originalLesson = originalTimetable[classNameForSlot]?.[day]?.[periodIndex];
                const proxyKey = `${classNameForSlot}-${day}-${periodIndex}`;
                const currentProxy = proxyAssignments[proxyKey];

                setModalPeriodInfo({
                    className: classNameForSlot,
                    day: day,
                    periodIndex: periodIndex,
                    originalTeacher: teacher,
                    subject: originalLesson?.subject || 'N/A',
                    currentProxy: currentProxy
                });
                setIsModalOpen(true);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-xl sm:text-3xl font-bold text-gray-900">Proxy Management: Teacher Availability</h2>
                        <div className="flex gap-2">
                            <Button variant="secondary" onClick={() => onExportCSV && onExportCSV()} className="flex items-center space-x-1 text-xs px-3 py-2">
                                <FileTextIcon className="w-4 h-4" />
                                <span>CSV</span>
                            </Button>
                            <Button variant="secondary" onClick={() => onExportHTML && onExportHTML()} className="flex items-center space-x-1 text-xs px-3 py-2">
                                <FileTextIcon className="w-4 h-4" />
                                <span>HTML</span>
                            </Button>
                            <Button variant="secondary" onClick={() => onExportPDF && onExportPDF()} disabled={isExporting} className="flex items-center space-x-1 text-xs px-3 py-2">
                                {isExporting ? <LoadingSpinner /> : <DownloadIcon className="w-4 h-4" />}
                                <span>{isExporting ? 'Exporting...' : 'PDF'}</span>
                            </Button>
                        </div>
                    </div>
                    <div className="flex justify-center">
                        <Select 
                            value={selectedDay}
                            onChange={(e) => setSelectedDay(e.target.value)}
                            options={workingDayLabels.map(d => ({ value: d, label: `View Schedule for ${d}` }))}
                            className="w-full max-w-sm"
                        />
                    </div>

                    <Card className="overflow-x-auto" id="proxy-management-view">
                        <table className="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-3 py-3 sm:px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teacher</th>
                                    {periodLabels.slice(0, periodsForSelectedDay).map((label, index) => (
                                        <th key={index} className="px-3 py-3 sm:px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            {label}
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {teachersOnSelectedDay.map(teacher => (
                                    <tr key={teacher}>
                                        <td className="px-3 py-4 sm:px-6 whitespace-nowrap font-medium text-gray-900 text-sm sticky left-0 bg-white z-10 border-r">{teacher}</td>
                                        {Array.from({ length: periodsForSelectedDay }).map((_, periodIndex) => {
                                            const lesson = teacherTimetable[teacher]?.[selectedDay]?.[periodIndex] || { className: 'Unavailable' };
                                            const cellData = getCellContent(lesson, periodIndex, selectedDay, periodsPerDay, halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, absentTeachers, proxyAssignments, originalTimetable, null);
                                            
                                            const isFree = cellData.className === 'Free';
                                            const isAbsent = absentTeachers.includes(teacher);
                                            
                                            // Check if THIS teacher is assigned as a proxy for any class at this slot
                                            let isProxyFor = null;
                                            let proxySubject = null;
                                            for (const [key, proxyTeacher] of Object.entries(proxyAssignments)) {
                                                const [cls, assignedDay, assignedPeriodStr] = key.split('-');
                                                const assignedPeriod = parseInt(assignedPeriodStr);
                                                
                                                if (assignedDay === selectedDay && assignedPeriod === periodIndex && proxyTeacher === teacher) {
                                                    isProxyFor = cls;
                                                    const originalLesson = originalTimetable?.[cls]?.[selectedDay]?.[periodIndex];
                                                    proxySubject = originalLesson?.subject;
                                                    break;
                                                }
                                            }
                                            
                                            // Determine if this specific slot for this teacher has a proxy assigned (for absent teachers)
                                            let classNameForSlot = null;
                                            for (const cls of Object.keys(originalTimetable)) {
                                                const originalLesson = originalTimetable[cls]?.[selectedDay]?.[periodIndex];
                                                if (originalLesson && originalLesson.teacher === teacher) {
                                                    classNameForSlot = cls;
                                                    break;
                                                }
                                            }
                                            const proxyKey = classNameForSlot ? `${classNameForSlot}-${selectedDay}-${periodIndex}` : null;
                                            const assignedProxy = proxyKey ? proxyAssignments[proxyKey] : null;

                                            let bgColor = cellData.bgClass;
                                            let text1 = cellData.className;
                                            let text2 = lesson.subject && lesson.subject !== 'Free' ? `(${lesson.subject})` : '';
                                            let clickable = false;

                                            if (isAbsent && classNameForSlot) {
                                                // Absent teacher who was teaching a class - can assign proxy
                                                bgColor = 'bg-red-200 text-red-800 font-bold';
                                                text1 = 'ABSENT';
                                                text2 = assignedProxy ? `Proxy: ${assignedProxy}` : 'No Proxy Assigned';
                                                clickable = true; // Can click to assign/reassign proxy for absent teacher
                                            } else if (isAbsent && !classNameForSlot) {
                                                // Absent teacher who was free at this slot - cannot assign proxy
                                                bgColor = 'bg-red-100 text-red-600';
                                                text1 = 'ABSENT (Free Period)';
                                                text2 = '';
                                                clickable = false;
                                            } else if (isProxyFor) {
                                                // This teacher is assigned as a proxy for another class
                                                bgColor = 'bg-purple-200 text-purple-900 font-bold';
                                                text1 = `PROXY FOR: ${isProxyFor}`;
                                                text2 = proxySubject ? `(${proxySubject})` : '';
                                                clickable = false;
                                            } else if (assignedProxy) {
                                                bgColor = 'bg-purple-200 text-purple-900 font-bold';
                                                text1 = `PROXY: ${assignedProxy}`;
                                                text2 = cellData.className ? `(${cellData.className})` : '';
                                                clickable = true; // Can click to re-assign proxy
                                            } else if (isFree) {
                                                bgColor = 'bg-green-500 text-white';
                                                text1 = 'FREE';
                                                text2 = '';
                                            }

                                            return (
                                                <td key={periodIndex} className="px-3 py-4 sm:px-6 whitespace-nowrap">
                                                    <div 
                                                        className={`p-2 rounded-md ${bgColor} ${clickable ? 'cursor-pointer hover:shadow-lg' : ''}`}
                                                        onClick={clickable ? () => handleCellClick(teacher, selectedDay, periodIndex) : null}
                                                    >
                                                        <div className="font-semibold text-sm">{text1}</div>
                                                        <div className="text-xs">{text2}</div>
                                                    </div>
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </Card>

                    <ProxyAssignmentModal
                        isOpen={isModalOpen}
                        onClose={() => setIsModalOpen(false)}
                        availableTeachers={modalPeriodInfo ? getAvailableProxyTeachersForPeriod(modalPeriodInfo.day, modalPeriodInfo.periodIndex) : []}
                        onAssignProxy={onAssignProxy}
                        onRemoveProxy={onRemoveProxy}
                        periodInfo={modalPeriodInfo}
                    />
                </div>
            );
        };
        // A separate component for the class timetable table, to be used for both display and PDF export
        const ClassTimetableTable = ({ className, timetableData, workingDayLabels, periodsPerDay, onExport, onExportCSV, onExportHTML, isExporting, halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, absentTeachers, proxyAssignments, onCellClick, originalTimetable, freeClassReasons, subjectPeriodsPerWeek, showLectureStats }) => {
          return (
            <div className="space-y-4 overflow-x-auto">
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                <h3 className="text-xl font-bold text-blue-800 mb-2 sm:mb-0">{className}</h3>
                <div className="flex flex-wrap gap-2">
                  <Button
                    variant="secondary"
                    onClick={() => onExportCSV(className, 'class')}
                    className="flex items-center space-x-1 text-xs px-3 py-2"
                  >
                    <FileTextIcon className="w-4 h-4" />
                    <span>CSV</span>
                  </Button>
                  <Button
                    variant="secondary"
                    onClick={() => onExportHTML(className, 'class')}
                    className="flex items-center space-x-1 text-xs px-3 py-2"
                  >
                    <FileTextIcon className="w-4 h-4" />
                    <span>HTML</span>
                  </Button>
                  <Button
                    variant="secondary"
                    onClick={() => onExport(className)}
                    disabled={isExporting}
                    className="flex items-center space-x-1 text-xs px-3 py-2"
                  >
                    {isExporting ? <LoadingSpinner /> : <DownloadIcon className="w-4 h-4" />}
                    <span>{isExporting ? 'Exporting...' : 'PDF'}</span>
                  </Button>
                </div>
              </div>
              <table className="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-3 py-3 sm:px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                    {workingDayLabels.map(day => (
                      <th key={day} className="px-3 py-3 sm:px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {day}
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {Array.from({ length: periodsPerDay }).map((_, periodIndex) => {
                    return (
                        <tr key={periodIndex}>
                            <td className="px-3 py-4 sm:px-6 whitespace-nowrap font-medium text-gray-900 text-sm">{periodIndex + 1}</td>
                            {workingDayLabels.map(day => {
                                const lesson = timetableData[className]?.[day]?.[periodIndex] || { subject: 'Free', teacher: null };
                                // Add className to lesson object for getCellContent to work properly
                                const lessonWithClass = { ...lesson, className: className };
                                
                                const cellData = getCellContent(lessonWithClass, periodIndex, day, periodsPerDay, halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, absentTeachers, proxyAssignments, originalTimetable, freeClassReasons);
                                
                                const isClickable = cellData.isAbsent || cellData.isProxy;
                                const proxyKey = `${className}-${day}-${periodIndex}`;
                                const currentProxy = proxyAssignments[proxyKey];

                                return (
                                <td key={day} className="px-3 py-4 sm:px-6 whitespace-nowrap">
                                    <div 
                                        className={`p-2 rounded-md ${cellData.bgClass} ${isClickable ? 'cursor-pointer hover:shadow-lg' : ''}`}
                                        onClick={isClickable ? () => onCellClick(className, day, periodIndex, lesson, currentProxy) : null}
                                    >
                                    {cellData.isProxy ? (
                                        <div>
                                            <div className="font-bold text-sm">{cellData.subject}</div>
                                            <div className="text-xs font-semibold mt-1">({cellData.originalTeacher})</div>
                                            <div className="text-xs font-bold text-purple-900">Proxy: {cellData.teacher}</div>
                                        </div>
                                    ) : cellData.isAbsent ? (
                                        <div>
                                            <div className="font-bold text-sm">ABSENT</div>
                                            <div className="text-xs font-semibold mt-1">Teacher: {cellData.teacher}</div>
                                            <div className="text-xs">No Proxy Assigned</div>
                                        </div>
                                    ) : cellData.isFree && cellData.freeReason ? (
                                        <div>
                                            <div className="font-semibold text-sm text-red-600">FREE CLASS</div>
                                            <div className="text-xs mt-1 border-t border-gray-300 pt-1">
                                                <div className="font-bold text-red-700">Reason:</div>
                                                <div className="text-red-600 italic">{cellData.freeReason.reasons[0]}</div>
                                                {cellData.freeReason.affectedSubjects && cellData.freeReason.affectedSubjects.length > 0 && (
                                                    <div className="mt-1">
                                                        <div className="font-bold text-orange-700">Under-scheduled:</div>
                                                        {cellData.freeReason.affectedSubjects.map(s => (
                                                            <div key={s.subject} className="text-orange-600 text-xs">
                                                                {s.subject}: {s.placed}/{s.requested} (-{s.deficit})
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ) : (
                                        <div>
                                            <div className="font-semibold text-sm">{cellData.subject}</div>
                                            <div className="text-xs">
                                                {!cellData.isBreak && !cellData.isFree && cellData.teacher && cellData.teacher !== 'Event Coordinator' && (
                                                    <span>({cellData.teacher})</span>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                    </div>
                                </td>
                                );
                            })}
                        </tr>
                    );
                  })}
                </tbody>
              </table>
              
              {/* Subject-wise Lecture Count */}
              {showLectureStats && (() => {
                // Count actual scheduled lectures per subject
                const subjectCounts = {};
                let totalLectures = 0;
                let freePeriods = 0;
                let eventPeriods = 0;
                
                workingDayLabels.forEach(day => {
                  const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                  for (let periodIndex = 0; periodIndex < periodsForDay; periodIndex++) {
                    const isLunchPeriod = periodIndex === lunchBreakPeriod - 1;
                    if (!isLunchPeriod) {
                      const lesson = timetableData[className]?.[day]?.[periodIndex];
                      if (lesson && lesson.subject) {
                        if (lesson.subject === 'Free' || lesson.subject === null) {
                          freePeriods++;
                        } else if (lesson.teacher === 'Event Coordinator') {
                          eventPeriods++;
                          subjectCounts[lesson.subject] = (subjectCounts[lesson.subject] || 0) + 1;
                        } else {
                          subjectCounts[lesson.subject] = (subjectCounts[lesson.subject] || 0) + 1;
                          totalLectures++;
                        }
                      }
                    }
                  }
                });
                
                // Get requested periods from settings
                const requestedPeriods = subjectPeriodsPerWeek?.[className] || {};
                
                // Calculate deficits
                const subjectAnalysis = Object.keys({...subjectCounts, ...requestedPeriods}).map(subject => {
                  const scheduled = subjectCounts[subject] || 0;
                  const requested = requestedPeriods[subject] || 0;
                  const deficit = requested - scheduled;
                  return { subject, scheduled, requested, deficit };
                }).filter(s => s.requested > 0 || s.scheduled > 0);
                
                // Sort by deficit (largest deficit first)
                subjectAnalysis.sort((a, b) => b.deficit - a.deficit);
                
                const hasDeficit = subjectAnalysis.some(s => s.deficit > 0);
                
                return (
                  <div className="mt-4 space-y-4">
                    {/* Total Summary */}
                    <div className="p-4 bg-gradient-to-r from-blue-100 to-blue-50 border-2 border-blue-300 rounded-lg shadow-md">
                      <div className="flex items-center justify-between">
                        <span className="text-lg font-bold text-blue-900">Total Lectures in the Week:</span>
                        <span className="text-2xl font-extrabold text-blue-600 bg-white px-4 py-2 rounded-md shadow">{totalLectures}</span>
                      </div>
                      {freePeriods > 0 && (
                        <div className="flex items-center justify-between mt-2 pt-2 border-t border-blue-200">
                          <span className="text-sm font-semibold text-gray-700">Free Periods:</span>
                          <span className="text-lg font-bold text-gray-600">{freePeriods}</span>
                        </div>
                      )}
                      {eventPeriods > 0 && (
                        <div className="flex items-center justify-between mt-2 pt-2 border-t border-blue-200">
                          <span className="text-sm font-semibold text-purple-700">Event Periods:</span>
                          <span className="text-lg font-bold text-purple-600">{eventPeriods}</span>
                        </div>
                      )}
                    </div>
                    
                    {/* Subject-wise Breakdown */}
                    {subjectAnalysis.length > 0 && (
                      <div className="p-4 bg-white border-2 border-gray-300 rounded-lg shadow-md">
                        <h4 className="text-lg font-bold text-gray-900 mb-3 flex items-center">
                          <span>Subject-wise Lecture Distribution</span>
                          {hasDeficit && (
                            <span className="ml-2 text-xs bg-red-100 text-red-700 px-2 py-1 rounded">Deficit Alert</span>
                          )}
                        </h4>
                        <div className="overflow-x-auto">
                          <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                              <tr>
                                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Subject</th>
                                <th className="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Scheduled</th>
                                <th className="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Requested</th>
                                <th className="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                              </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                              {subjectAnalysis.map(({ subject, scheduled, requested, deficit }) => (
                                <tr key={subject} className={deficit > 0 ? 'bg-red-50' : deficit < 0 ? 'bg-yellow-50' : 'bg-green-50'}>
                                  <td className="px-4 py-2 whitespace-nowrap font-medium text-gray-900">{subject}</td>
                                  <td className="px-4 py-2 text-center whitespace-nowrap font-bold text-blue-600">{scheduled}</td>
                                  <td className="px-4 py-2 text-center whitespace-nowrap font-bold text-gray-700">{requested}</td>
                                  <td className="px-4 py-2 text-center whitespace-nowrap">
                                    {deficit > 0 ? (
                                      <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-200 text-red-800">
                                        -{deficit} (Deficit)
                                      </span>
                                    ) : deficit < 0 ? (
                                      <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-yellow-200 text-yellow-800">
                                        +{Math.abs(deficit)} (Extra)
                                      </span>
                                    ) : (
                                      <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-green-200 text-green-800">
                                         Complete
                                      </span>
                                    )}
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                        {hasDeficit && (
                          <div className="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                            <p className="text-sm text-red-800">
                              <strong>Note:</strong> Some subjects have fewer lectures scheduled than requested in settings. 
                              This may be due to constraints like teacher availability, fixed periods, or insufficient time slots.
                            </p>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                );
              })()}
            </div>
          );
        };

        // A new component for the teacher timetable table
        const TeacherTimetableTable = ({ teacherName, timetableData, workingDayLabels, periodsPerDay, onExport, onExportCSV, onExportHTML, isExporting, halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, absentTeachers, proxyAssignments, onCellClick, originalTimetable }) => {
          return (
            <div className="space-y-4 overflow-x-auto">
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                <h3 className="text-xl font-bold text-blue-800 mb-2 sm:mb-0">{teacherName}</h3>
                <div className="flex flex-wrap gap-2">
                  <Button
                    variant="secondary"
                    onClick={() => onExportCSV(teacherName, 'teacher')}
                    className="flex items-center space-x-1 text-xs px-3 py-2"
                  >
                    <FileTextIcon className="w-4 h-4" />
                    <span>CSV</span>
                  </Button>
                  <Button
                    variant="secondary"
                    onClick={() => onExportHTML(teacherName, 'teacher')}
                    className="flex items-center space-x-1 text-xs px-3 py-2"
                  >
                    <FileTextIcon className="w-4 h-4" />
                    <span>HTML</span>
                  </Button>
                  <Button
                    variant="secondary"
                    onClick={() => onExport(teacherName)}
                    disabled={isExporting}
                    className="flex items-center space-x-1 text-xs px-3 py-2"
                  >
                    {isExporting ? <LoadingSpinner /> : <DownloadIcon className="w-4 h-4" />}
                    <span>{isExporting ? 'Exporting...' : 'PDF'}</span>
                  </Button>
                </div>
              </div>
              <table className="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-3 py-3 sm:px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                    {workingDayLabels.map(day => (
                      <th key={day} className="px-3 py-3 sm:px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        {day}
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {Array.from({ length: periodsPerDay }).map((_, periodIndex) => (
                    <tr key={periodIndex}>
                      <td className="px-3 py-4 sm:px-6 whitespace-nowrap font-medium text-gray-900 text-sm">{periodIndex + 1}</td>
                      {workingDayLabels.map(day => {
                        const lesson = timetableData[teacherName]?.[day]?.[periodIndex] || { className: 'Free' };
                        
                        const cellData = getCellContent(lesson, periodIndex, day, periodsPerDay, halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, absentTeachers, proxyAssignments, originalTimetable, null);
                        
                        // Determine the class name for this teacher at this slot from the original timetable
                        let classNameForSlot = null;
                        for (const cls of Object.keys(originalTimetable || {})) {
                            const originalLesson = originalTimetable[cls]?.[day]?.[periodIndex];
                            if (originalLesson && originalLesson.teacher === teacherName) {
                                classNameForSlot = cls;
                                break;
                            }
                        }
                        const isClickable = cellData.isAbsent || cellData.isProxy;
                        const proxyKey = classNameForSlot ? `${classNameForSlot}-${day}-${periodIndex}` : null;
                        const currentProxy = proxyKey ? proxyAssignments[proxyKey] : null;

                        return (
                          <td key={day} className="px-3 py-4 sm:px-6 whitespace-nowrap">
                            <div 
                                className={`p-2 rounded-md ${cellData.bgClass} ${isClickable ? 'cursor-pointer hover:shadow-lg' : ''}`}
                                onClick={isClickable ? () => onCellClick(classNameForSlot, day, periodIndex, lesson, currentProxy) : null}
                            >
                              {cellData.isProxy ? (
                                <div>
                                  <div className="font-bold text-sm">{lesson.className || cellData.className || 'Proxy'}</div>
                                  <div className="text-xs font-semibold mt-1">({lesson.subject || cellData.subject})</div>
                                  <div className="text-xs font-bold text-purple-900">Proxy Assignment</div>
                                </div>
                              ) : cellData.isAbsent ? (
                                <div>
                                  <div className="font-bold text-sm">ABSENT</div>
                                  <div className="text-xs font-semibold mt-1">Class: {cellData.className}</div>
                                  {cellData.assignedProxy ? (
                                    <div className="text-xs">Proxy: {cellData.assignedProxy}</div>
                                  ) : (
                                    <div className="text-xs">No Proxy Assigned</div>
                                  )}
                                </div>
                              ) : cellData.isBreak ? (
                                <div>
                                  <div className="font-semibold text-sm">{cellData.className}</div>
                                </div>
                              ) : cellData.isFree ? (
                                <div>
                                  <div className="font-semibold text-sm">Free</div>
                                </div>
                              ) : (
                                <div>
                                  <div className="font-semibold text-sm">{lesson.className || cellData.className || 'Free'}</div>
                                  <div className="text-xs">
                                    {lesson.subject && lesson.subject !== 'Free' && (
                                      <span>({lesson.subject})</span>
                                    )}
                                  </div>
                                </div>
                              )}
                            </div>
                          </td>
                        );
                      })}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          );
        };

        // All Classes Consolidated View Component - Compact Version
        const AllClassesConsolidatedView = ({ classes, timetable, workingDayLabels, periodsPerDay, halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, absentTeachers, proxyAssignments, originalTimetable, freeClassReasons, onExportPDF, onExportCSV, onExportHTML, isExporting }) => {
          if (!timetable) return null;

          return (
            <div className="space-y-4">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl sm:text-2xl font-bold text-gray-900">All Classes - Consolidated View</h2>
                <div className="flex gap-2">
                  <Button variant="secondary" onClick={() => onExportCSV && onExportCSV()} className="flex items-center space-x-1 text-xs px-3 py-2">
                    <FileTextIcon className="w-4 h-4" />
                    <span>CSV</span>
                  </Button>
                  <Button variant="secondary" onClick={() => onExportHTML && onExportHTML()} className="flex items-center space-x-1 text-xs px-3 py-2">
                    <FileTextIcon className="w-4 h-4" />
                    <span>HTML</span>
                  </Button>
                  <Button variant="secondary" onClick={() => onExportPDF && onExportPDF()} disabled={isExporting} className="flex items-center space-x-1 text-xs px-3 py-2">
                    {isExporting ? <LoadingSpinner /> : <DownloadIcon className="w-4 h-4" />}
                    <span>{isExporting ? 'Exporting...' : 'PDF'}</span>
                  </Button>
                </div>
              </div>
              <Card className="overflow-x-auto" id="all-classes-consolidated">
                <div className="overflow-x-auto">
                  <table className="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg text-xs">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-20 border-r">Class</th>
                        {workingDayLabels.map(day => (
                          <th key={day} colSpan={periodsPerDay} className="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l-2 border-gray-300">
                            {day}
                          </th>
                        ))}
                      </tr>
                      <tr>
                        <th className="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-20 border-r"></th>
                        {workingDayLabels.map(day => (
                          Array.from({ length: periodsPerDay }).map((_, i) => (
                            <th key={`${day}-${i}`} className="px-1 py-1 text-center text-xs font-medium text-gray-500 uppercase">
                              P{i + 1}
                            </th>
                          ))
                        ))}
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {classes.map(cls => (
                        <tr key={cls} className="hover:bg-gray-50">
                          <td className="px-2 py-2 whitespace-nowrap font-bold text-gray-900 text-sm sticky left-0 bg-blue-50 z-10 border-r">
                            {cls}
                          </td>
                          {workingDayLabels.map(day => (
                            Array.from({ length: periodsPerDay }).map((_, periodIndex) => {
                              const lesson = timetable[cls]?.[day]?.[periodIndex] || { subject: 'Free', teacher: null };
                              const lessonWithClass = { ...lesson, className: cls };
                              const cellData = getCellContent(lessonWithClass, periodIndex, day, periodsPerDay, halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, absentTeachers, proxyAssignments, originalTimetable, freeClassReasons || null);
                              
                              return (
                                <td key={`${day}-${periodIndex}`} className="px-1 py-1 text-center border-l" title={`${cellData.subject || 'Free'}${cellData.teacher ? ' - ' + cellData.teacher : ''}`}>
                                  <div className={`p-1 rounded ${cellData.bgClass} text-xs whitespace-nowrap overflow-hidden text-ellipsis`} style={{maxWidth: '80px'}}>
                                    <div className="font-semibold">{cellData.subject || 'Free'}</div>
                                  </div>
                                </td>
                              );
                            })
                          ))}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </Card>
            </div>
          );
        };

        // All Teachers Consolidated View Component - Compact Version
        const AllTeachersConsolidatedView = ({ teachers, teacherTimetable, workingDayLabels, periodsPerDay, halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, absentTeachers, proxyAssignments, originalTimetable, onExportPDF, onExportCSV, onExportHTML, isExporting }) => {
          if (!teacherTimetable) return null;

          return (
            <div className="space-y-4">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl sm:text-2xl font-bold text-gray-900">All Teachers - Consolidated View</h2>
                <div className="flex gap-2">
                  <Button variant="secondary" onClick={() => onExportCSV && onExportCSV()} className="flex items-center space-x-1 text-xs px-3 py-2">
                    <FileTextIcon className="w-4 h-4" />
                    <span>CSV</span>
                  </Button>
                  <Button variant="secondary" onClick={() => onExportHTML && onExportHTML()} className="flex items-center space-x-1 text-xs px-3 py-2">
                    <FileTextIcon className="w-4 h-4" />
                    <span>HTML</span>
                  </Button>
                  <Button variant="secondary" onClick={() => onExportPDF && onExportPDF()} disabled={isExporting} className="flex items-center space-x-1 text-xs px-3 py-2">
                    {isExporting ? <LoadingSpinner /> : <DownloadIcon className="w-4 h-4" />}
                    <span>{isExporting ? 'Exporting...' : 'PDF'}</span>
                  </Button>
                </div>
              </div>
              <Card className="overflow-x-auto" id="all-teachers-consolidated">
                <div className="overflow-x-auto">
                  <table className="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg text-xs">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-20 border-r">Teacher</th>
                        {workingDayLabels.map(day => (
                          <th key={day} colSpan={periodsPerDay} className="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l-2 border-gray-300">
                            {day}
                          </th>
                        ))}
                      </tr>
                      <tr>
                        <th className="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-20 border-r"></th>
                        {workingDayLabels.map(day => (
                          Array.from({ length: periodsPerDay }).map((_, i) => (
                            <th key={`${day}-${i}`} className="px-1 py-1 text-center text-xs font-medium text-gray-500 uppercase">
                              P{i + 1}
                            </th>
                          ))
                        ))}
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {teachers.map(teacher => {
                        const isAbsent = absentTeachers.includes(teacher);
                        return (
                          <tr key={teacher} className="hover:bg-gray-50">
                            <td className={`px-2 py-2 whitespace-nowrap font-bold text-gray-900 text-sm sticky left-0 ${isAbsent ? 'bg-red-100' : 'bg-green-50'} z-10 border-r`}>
                              {teacher}
                              {isAbsent && <span className="text-xs text-red-600 ml-1">(ABS)</span>}
                            </td>
                            {workingDayLabels.map(day => (
                              Array.from({ length: periodsPerDay }).map((_, periodIndex) => {
                                const lesson = teacherTimetable[teacher]?.[day]?.[periodIndex] || { className: 'Free' };
                                const cellData = getCellContent(lesson, periodIndex, day, periodsPerDay, halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, absentTeachers, proxyAssignments, originalTimetable, null);
                                
                                // Determine what to display
                                let displayText = 'Free';
                                let tooltipText = 'Free Period';
                                
                                if (cellData.isBreak) {
                                  displayText = breakLabel;
                                  tooltipText = breakLabel;
                                } else if (cellData.isProxy) {
                                  displayText = cellData.className || 'Proxy';
                                  tooltipText = `Proxy: ${cellData.subject || 'Assignment'} for ${cellData.className || 'class'}`;
                                } else if (cellData.isAbsent) {
                                  displayText = 'ABSENT';
                                  tooltipText = 'Teacher Absent';
                                } else if (lesson.className && lesson.className !== 'Free') {
                                  displayText = lesson.className;
                                  tooltipText = `${lesson.className}${lesson.subject ? ' - ' + lesson.subject : ''}`;
                                } else if (cellData.className && cellData.className !== 'Free') {
                                  displayText = cellData.className;
                                  tooltipText = `${cellData.className}${lesson?.subject ? ' - ' + lesson.subject : ''}`;
                                }
                                
                                return (
                                  <td key={`${day}-${periodIndex}`} className="px-1 py-1 text-center border-l" title={tooltipText}>
                                    <div className={`p-1 rounded ${cellData.bgClass} text-xs whitespace-nowrap overflow-hidden text-ellipsis`} style={{maxWidth: '80px'}}>
                                      <div className="font-semibold">{displayText}</div>
                                    </div>
                                  </td>
                                );
                              })
                            ))}
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </Card>
            </div>
          );
        };

        // Teacher Workload Summary Component
        const TeacherWorkloadSummary = ({ teachers, teacherTimetable, workingDayLabels, periodsPerDay, halfDayPeriods, halfDays, lunchBreakPeriod, absentTeachers, proxyAssignments, originalTimetable }) => {
          if (!teacherTimetable || !originalTimetable) {
            return null;
          }

          // Calculate periods per day for each teacher
          const calculateTeacherWorkload = () => {
            const workload = {};
            
            teachers.forEach(teacher => {
              workload[teacher] = {};
              let totalPeriods = 0;
              
              workingDayLabels.forEach(day => {
                const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                let periodsOnDay = 0;
                
                for (let periodIndex = 0; periodIndex < periodsForDay; periodIndex++) {
                  // Skip lunch break
                  if (periodIndex === lunchBreakPeriod - 1) continue;
                  
                  const lesson = teacherTimetable[teacher]?.[day]?.[periodIndex];
                  
                  // Check if teacher has a class (not free)
                  if (lesson && lesson.className && lesson.className !== 'Free') {
                    periodsOnDay++;
                  }
                  
                  // Check if this teacher is assigned as a proxy for this slot
                  for (const [key, proxyTeacher] of Object.entries(proxyAssignments)) {
                    const [cls, assignedDay, assignedPeriodStr] = key.split('-');
                    const assignedPeriod = parseInt(assignedPeriodStr);
                    
                    if (assignedDay === day && assignedPeriod === periodIndex && proxyTeacher === teacher) {
                      // Check if this isn't already counted (teacher might be assigned proxy during their regular class)
                      if (!lesson || lesson.className === 'Free') {
                        periodsOnDay++;
                      }
                      break;
                    }
                  }
                }
                
                workload[teacher][day] = periodsOnDay;
                totalPeriods += periodsOnDay;
              });
              
              workload[teacher]['Total'] = totalPeriods;
            });
            
            return workload;
          };

          const workload = calculateTeacherWorkload();

          return (
            <Card className="mb-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Teacher Workload Summary (Periods per Day)</h3>
              <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-3 py-3 sm:px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10">Teacher</th>
                      {workingDayLabels.map(day => (
                        <th key={day} className="px-3 py-3 sm:px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                          {day}
                        </th>
                      ))}
                      <th className="px-3 py-3 sm:px-6 text-center text-xs font-medium text-gray-700 uppercase tracking-wider bg-blue-50">
                        Total
                      </th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {teachers.map(teacher => {
                      const isAbsent = absentTeachers.includes(teacher);
                      return (
                        <tr key={teacher} className={isAbsent ? 'bg-red-50' : ''}>
                          <td className="px-3 py-4 sm:px-6 whitespace-nowrap font-medium text-gray-900 text-sm sticky left-0 bg-white z-10 border-r">
                            {teacher}
                            {isAbsent && <span className="ml-2 text-xs text-red-600 font-bold">(ABSENT)</span>}
                          </td>
                          {workingDayLabels.map(day => {
                            const periods = workload[teacher][day];
                            const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                            const maxPeriods = periodsForDay - 1; // Subtract lunch break
                            
                            let bgColor = 'bg-white';
                            if (periods === 0) {
                              bgColor = 'bg-gray-100';
                            } else if (periods >= maxPeriods * 0.8) {
                              bgColor = 'bg-red-100';
                            } else if (periods >= maxPeriods * 0.6) {
                              bgColor = 'bg-yellow-100';
                            } else {
                              bgColor = 'bg-green-100';
                            }
                            
                            return (
                              <td key={day} className={`px-3 py-4 sm:px-6 text-center text-sm font-semibold ${bgColor}`}>
                                {periods}
                              </td>
                            );
                          })}
                          <td className="px-3 py-4 sm:px-6 text-center text-sm font-bold bg-blue-50">
                            {workload[teacher]['Total']}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
              <div className="mt-4 flex flex-wrap gap-4 text-xs text-gray-600">
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 bg-green-100 border border-gray-300"></div>
                  <span>Light Load (&lt;60%)</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 bg-yellow-100 border border-gray-300"></div>
                  <span>Moderate Load (60-80%)</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 bg-red-100 border border-gray-300"></div>
                  <span>Heavy Load (80%)</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 bg-gray-100 border border-gray-300"></div>
                  <span>No Classes</span>
                </div>
              </div>
            </Card>
          );
        };

        const LandingPage = ({ onNavigate }) => {
          return (
            <div className="flex flex-col items-center justify-center min-h-screen p-4 md:p-6 text-center bg-white shadow-xl rounded-xl m-4 md:m-8">
              <h1 className="text-3xl sm:text-5xl md:text-7xl font-extrabold tracking-tight text-gray-900">
                Hello, I'm <span className="text-blue-600">Ayaan</span>
              </h1>
              <p className="mt-4 max-w-xl text-base sm:text-lg text-gray-600">
                Welcome to the Timetable App! I've built this platform to make managing schedules simple, clear, and stress-free. Whether you're a student, teacher, or school, this app helps you stay organized with easy access to classes, subjects, and activitiesall in one place. My goal is to save your time and keep everything well-planned.
              </p>
              <div className="mt-8 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                <Button onClick={() => onNavigate('app')} className="px-6 py-3 text-lg w-full sm:w-auto">
                  Explore the App
                </Button>
               
              </div>
            </div>
          );
        };
        // Main Application Component
        const TimetableApp = () => {
          const loadedState = loadState();
          
          // Helper for initial state (used when no state is loaded or for defaults)
          const initialTeachers = ['Mr. Smith', 'Ms. Jones', 'Dr. Williams', 'Ms. Brown', 'Mr. Green'];
          const initialClasses = ['5A', '5B'];
          const initialSubjects = ['English', 'Maths', 'Science', 'History', 'Art'];
          
          // Ensure initialAssignments is fully populated for initial classes and subjects
          const createInitialAssignments = (classes, subjects, teachers) => {
              const assignments = {};
              classes.forEach(cls => {
                  assignments[cls] = {};
                  subjects.forEach(sub => {
                      assignments[cls][sub] = teachers[Math.floor(Math.random() * teachers.length)];
                  });
              });
              return assignments;
          };

          const createInitialFirstPeriodAssignments = (classes, weekDays) => {
              const firstPeriodAssignments = {};
              classes.forEach(cls => {
                  firstPeriodAssignments[cls] = {};
                  weekDays.forEach(day => {
                      firstPeriodAssignments[cls][day] = { subject: '', teacher: '' };
                  });
              });
              return firstPeriodAssignments;
          };

          const createInitialSubjectPeriodsPerWeek = (classes, subjects) => {
            const subjectPeriodsPerWeek = {};
            classes.forEach(cls => {
                subjectPeriodsPerWeek[cls] = {};
                subjects.forEach(sub => {
                    subjectPeriodsPerWeek[cls][sub] = 0;
                });
            });
            return subjectPeriodsPerWeek;
          };

          const weekDays = useMemo(() => ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'], []);

          // State for settings - Load from localStorage or use defaults
          const [teachers, setTeachers] = useState(loadedState?.teachers || initialTeachers);
          const [classes, setClasses] = useState(loadedState?.classes || initialClasses);
          const [subjects, setSubjects] = useState(loadedState?.subjects || initialSubjects);
          const [periodsPerDay, setPeriodsPerDay] = useState(loadedState?.periodsPerDay || 6);
          const [workingDays, setWorkingDays] = useState(loadedState?.workingDays || 5);
          const [offDays, setOffDays] = useState(loadedState?.offDays || ['Saturday', 'Sunday']);
          const [halfDayPeriods, setHalfDayPeriods] = useState(loadedState?.halfDayPeriods ?? 4);
          const [halfDays, setHalfDays] = useState(loadedState?.halfDays || ['Friday']);
          const [lunchBreakPeriod, setLunchBreakPeriod] = useState(loadedState?.lunchBreakPeriod ?? 3);
          const [breakLabel, setBreakLabel] = useState(loadedState?.breakLabel || 'LUNCH BREAK');

          // State for constraints
          const [assignments, setAssignments] = useState(loadedState?.assignments || createInitialAssignments(initialClasses, initialSubjects, initialTeachers));
          const [firstPeriodAssignments, setFirstPeriodAssignments] = useState(loadedState?.firstPeriodAssignments || createInitialFirstPeriodAssignments(initialClasses, weekDays));
          const [teacherStartPeriod, setTeacherStartPeriod] = useState(loadedState?.teacherStartPeriod || initialTeachers.reduce((acc, t) => ({ ...acc, [t]: 1 }), {}));
          const [lastPeriodSubjectRestrictions, setLastPeriodSubjectRestrictions] = useState(loadedState?.lastPeriodSubjectRestrictions || []); 
          const [events, setEvents] = useState(loadedState?.events || []); 
          const [subjectPeriodsPerWeek, setSubjectPeriodsPerWeek] = useState(loadedState?.subjectPeriodsPerWeek || createInitialSubjectPeriodsPerWeek(initialClasses, initialSubjects)); // New state

          // New states for absent teachers and proxy management
          const [absentTeachers, setAbsentTeachers] = useState(loadedState?.absentTeachers || []);
          const [proxyTeachers, setProxyTeachers] = useState(loadedState?.proxyTeachers || []);
          const [proxyAssignments, setProxyAssignments] = useState(loadedState?.proxyAssignments || {}); // Key: `${className}-${day}-${periodIndex}`, Value: proxyTeacherName
          const [originalTimetable, setOriginalTimetable] = useState(loadedState?.originalTimetable || null); // To revert when absent teachers return
          const [freeClassReasons, setFreeClassReasons] = useState(loadedState?.freeClassReasons || {}); // Track reasons for free classes
          const [ensureTeacherFreePeriod, setEnsureTeacherFreePeriod] = useState(loadedState?.ensureTeacherFreePeriod ?? true); // Ensure every teacher has at least one free period

          // State for the generated timetable
          const [timetable, setTimetable] = useState(loadedState?.timetable || null);
          const [teacherTimetable, setTeacherTimetable] = useState(loadedState?.teacherTimetable || null);
          const [showSettings, setShowSettings] = useState(true);
          const [settingsTab, setSettingsTab] = useState('general');
          const [currentView, setCurrentView] = useState('class'); // Can be 'class', 'teacher', or 'proxy'
          const [isGenerating, setIsGenerating] = useState(false);
          const [generatingProgress, setGeneratingProgress] = useState(0);
          const [estimatedTimeLeft, setEstimatedTimeLeft] = useState(0);
          const [isExportingAll, setIsExportingAll] = useState(false);
          const [isExporting, setIsExporting] = useState({ class: {}, teacher: {} });
          const [areLibrariesLoaded, setAreLibrariesLoaded] = useState(false);
          const [useAltTheme, setUseAltTheme] = useState(loadedState?.useAltTheme || false);

          // Quick search states for ribbon
          const [searchTeacherName, setSearchTeacherName] = useState('');
          const [searchClassName, setSearchClassName] = useState('');
          const [teacherSearchQuery, setTeacherSearchQuery] = useState('');
          const [classSearchQuery, setClassSearchQuery] = useState('');

          // Visible notice to confirm redirects and guide when data is missing
          const [redirectNotice, setRedirectNotice] = useState('');

          // Active filters for focused rendering
          const [selectedTeacherFilter, setSelectedTeacherFilter] = useState(null);
          const [selectedClassFilter, setSelectedClassFilter] = useState(null);

          // Clear helpers to revert to full views
          const clearTeacherFilter = () => {
            setSelectedTeacherFilter(null);
            setRedirectNotice('');
            setCurrentView('teacher');
          };
          const clearClassFilter = () => {
            setSelectedClassFilter(null);
            setRedirectNotice('');
            setCurrentView('class');
          };
          const clearFilters = () => {
            setSelectedTeacherFilter(null);
            setSelectedClassFilter(null);
            setRedirectNotice('');
          };

          // Helpers: safe IDs and robust scrolling
          const makeIdSafe = (s) => String(s || '').trim().replace(/\s+/g, '-').replace(/[^a-zA-Z0-9_-]/g, '-');
          const scrollToIdWhenReady = (id, attempts = 0) => {
            const el = document.getElementById(id);
            if (el) {
              el.scrollIntoView({ behavior: 'auto', block: 'start' });
              el.classList.add('highlight-card');
              setTimeout(() => el.classList.remove('highlight-card'), 1500);
              return;
            }
            if (attempts < 30) {
              setTimeout(() => scrollToIdWhenReady(id, attempts + 1), 50);
            }
          };
          const redirectToTeacher = (teacherName) => {
            console.log('[TimetableApp] redirectToTeacher called with', teacherName);
            setSelectedTeacherFilter(teacherName);
            setCurrentView('teacher');
            setRedirectNotice(`Showing timetable for teacher: ${teacherName}. If you don't see data, generate the timetable first.`);
            setTimeout(() => {
              scrollToIdWhenReady(`timetable-teacher-${makeIdSafe(teacherName)}`);
            }, 0);
          };
          const redirectToClass = (className) => {
            console.log('[TimetableApp] redirectToClass called with', className);
            setSelectedClassFilter(className);
            setCurrentView('class');
            setRedirectNotice(`Showing timetable for class: ${className}. If you don't see data, generate the timetable first.`);
            setTimeout(() => {
              scrollToIdWhenReady(`timetable-class-${makeIdSafe(className)}`);
            }, 0);
          };

          // Expose redirect functions globally and process any pending redirect
          useEffect(() => {
            try {
              console.log('[TimetableApp] mounted; exposing window redirects');
              window.redirectToTeacher = (name) => redirectToTeacher(name);
              window.redirectToClass = (cls) => redirectToClass(cls);
              window.clearTeacherFilter = () => clearTeacherFilter();
              window.clearClassFilter = () => clearClassFilter();
              window.clearTimetableFilters = () => clearFilters();
              window.ttReady = true;

              const raw = localStorage.getItem('pendingRedirect');
              if (raw) {
                const pending = JSON.parse(raw);
                console.log('[TimetableApp] found pendingRedirect', pending);
                if (pending && pending.type === 'teacher' && pending.name) {
                  redirectToTeacher(pending.name);
                } else if (pending && pending.type === 'class' && pending.name) {
                  redirectToClass(pending.name);
                }
                localStorage.removeItem('pendingRedirect');
              }
            } catch (err) {
              console.error('Redirect binding error:', err);
            }
          }, []);
          
          const handleSearchTeacher = (e) => {
            const name = e.target.value;
            setSearchTeacherName(name);
            if (!name) return;
            if (name === '__ALL__') {
              clearTeacherFilter();
              return;
            }
            redirectToTeacher(name);
          };
          
          const handleSearchClass = (e) => {
            const cls = e.target.value;
            setSearchClassName(cls);
            if (!cls) return;
            if (cls === '__ALL__') {
              clearClassFilter();
              return;
            }
            redirectToClass(cls);
          };

          // Modal state for proxy assignment
          const [isProxyModalOpen, setIsProxyModalOpen] = useState(false);
          const [proxyModalInfo, setProxyModalInfo] = useState(null);

          // Manual placement state
          const [isManualOpen, setIsManualOpen] = useState(false);

          // Bulk first-period apply controls
          const [bulkFirstPeriodDay, setBulkFirstPeriodDay] = useState('');
          const [bulkFirstPeriodSubject, setBulkFirstPeriodSubject] = useState('');

          // State for showing/hiding lecture statistics
          const [showLectureStats, setShowLectureStats] = useState(true);
          
          // State for generation progress
          const [generationProgress, setGenerationProgress] = useState({ current: 0, total: 0, timeLeft: 0 });

          // State for auto-distribute teacher selection
          const [selectedAutoDistributeTeacher, setSelectedAutoDistributeTeacher] = useState(loadedState?.selectedAutoDistributeTeacher || {});

          const workingDayLabels = useMemo(() => {
            const validDays = weekDays.filter(day => !offDays.includes(day));
            return validDays.slice(0, workingDays);
          }, [workingDays, weekDays, offDays]);

          // Keep UI progress and countdown aligned with actual attempt progress
          useEffect(() => {
            if (generationProgress && generationProgress.total > 0) {
              const attemptPercent = Math.floor((generationProgress.current / generationProgress.total) * 100);
              // Drive only the progress bar here; countdown is purely time-based
              setGeneratingProgress(prev => {
                const next = Math.min(95, attemptPercent);
                return next < prev ? prev : next;
              });
            }
          }, [generationProgress]);

          // --- LOCAL STORAGE SAVE EFFECT ---
          useEffect(() => {
              const stateToSave = {
                  teachers, classes, subjects, periodsPerDay, workingDays, offDays,
                  halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, assignments,
                  timetable, teacherTimetable, firstPeriodAssignments, teacherStartPeriod,
                  lastPeriodSubjectRestrictions, events, subjectPeriodsPerWeek, // Save new states
                  absentTeachers, proxyTeachers, proxyAssignments, originalTimetable, freeClassReasons,
                  ensureTeacherFreePeriod, selectedAutoDistributeTeacher, useAltTheme // Save class teacher assignments and theme
              };
              saveState(stateToSave);
          }, [teachers, classes, subjects, periodsPerDay, workingDays, offDays,
              halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, assignments,
              timetable, teacherTimetable, firstPeriodAssignments, teacherStartPeriod,
              lastPeriodSubjectRestrictions, events, subjectPeriodsPerWeek,
              absentTeachers, proxyTeachers, proxyAssignments, originalTimetable, freeClassReasons,
              ensureTeacherFreePeriod, selectedAutoDistributeTeacher, useAltTheme]);
          // --- END LOCAL STORAGE SAVE EFFECT ---


          // Helper functions for adding/removing items
          const addItem = (item, currentList, setList, type) => { // Modified to accept currentList and type
            const trimmedItem = item.trim();
            if (trimmedItem !== '' && !currentList.includes(trimmedItem)) {
              setList(prev => [...prev, trimmedItem]);

              // Special handling for classes to initialize related states
              if (type === 'class') {
                  setAssignments(prev => ({ ...prev, [trimmedItem]: {} }));
                  setFirstPeriodAssignments(prev => {
                      const newFirstPeriods = { ...prev, [trimmedItem]: {} };
                      weekDays.forEach(day => {
                          newFirstPeriods[trimmedItem][day] = { subject: '', teacher: '' };
                      });
                      return newFirstPeriods;
                  });
                  setSubjectPeriodsPerWeek(prev => ({ ...prev, [trimmedItem]: {} }));
              }
            }
          };

          const removeItem = (itemToRemove, setList, type) => {
            setList(prev => prev.filter(item => item !== itemToRemove));

            // Special handling for classes to clean up related states
            if (type === 'class') {
                setAssignments(prev => {
                    const newAssignments = { ...prev };
                    delete newAssignments[itemToRemove];
                    return newAssignments;
                });
                setFirstPeriodAssignments(prev => {
                    const newFirstPeriods = { ...prev };
                    delete newFirstPeriods[itemToRemove];
                    return newFirstPeriods;
                });
                  setSubjectPeriodsPerWeek(prev => {
                    const newSubjectPeriods = { ...prev };
                    delete newSubjectPeriods[itemToRemove];
                    return newSubjectPeriods;
                });
            }
          };

          const handleAssignmentChange = (className, subject, teacher) => {
            setAssignments(prev => ({
              ...prev,
              [className]: {
                ...(prev[className] || {}), // Ensure className object exists
                [subject]: teacher,
              },
            }));
          };
          
          const handleFirstPeriodChange = (className, day, key, value) => {
              setFirstPeriodAssignments(prev => {
                  const newFirstPeriods = { ...prev };
                  if (!newFirstPeriods[className]) {
                      newFirstPeriods[className] = {};
                  }
                  if (!newFirstPeriods[className][day]) {
                      newFirstPeriods[className][day] = { subject: '', teacher: '' };
                  }
                  newFirstPeriods[className][day] = {
                      ...newFirstPeriods[className][day],
                      [key]: value
                  };
                  return newFirstPeriods;
              });
          };

          const handleTeacherStartPeriodChange = (teacher, period) => {
              setTeacherStartPeriod(prev => ({
                  ...prev,
                  [teacher]: Math.max(1, Math.min(periodsPerDay, parseInt(period) || 1))
              }));
          };

          const handleLastPeriodSubjectRestriction = (cls, subject, checked) => {
            setLastPeriodSubjectRestrictions(prev => {
                const key = `${cls}:${subject}`;
                if (checked) {
                    return prev.find(r => r.key === key) ? prev : [...prev, { className: cls, subject: subject, key: key }];
                } else {
                    return prev.filter(r => r.key !== key);
                }
            });
          };

          const addEvent = (e) => {
              e.preventDefault();
              const form = e.target;
              const className = form.className.value; 
              const day = form.day.value;
              const period = parseInt(form.period.value);
              const label = form.label.value;

              if (className && day && period > 0 && period <= periodsPerDay && label) {
                  setEvents(prev => [...prev, { className, day, period, label }]);
                  form.reset();
              } else {
                  alert('Please fill out all event fields correctly.');
              }
          };

          const removeEvent = (index) => {
              setEvents(prev => prev.filter((_, i) => i !== index));
          };

          // New handler for subject periods per week
          const handleSubjectPeriodsPerWeekChange = (className, subject, count) => {
            const nextValue = Math.max(0, parseInt(count) || 0);

            // Compute weekly capacity for this class (full-day and half-day) excluding lunch only
            let weeklyCapacity = 0;
            workingDayLabels.forEach(day => {
              const pForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
              if (pForDay > 0) {
                const lunch = (lunchBreakPeriod > 0 && lunchBreakPeriod <= pForDay) ? 1 : 0;
                weeklyCapacity += (pForDay - lunch);
              }
            });

            // Compute new requested total if we apply this change
            const currentMap = subjectPeriodsPerWeek[className] || {};
            const newRequestedTotal = Object.keys(currentMap).reduce((sum, sub) => {
              if (sub === subject) return sum; // we'll add nextValue below
              return sum + (Math.max(0, parseInt(currentMap[sub]) || 0));
            }, 0) + nextValue;

            if (newRequestedTotal > weeklyCapacity) {
              alert(`Requested periods exceed available weekly slots for ${className} (${newRequestedTotal}/${weeklyCapacity}).`);
              return;
            }

            setSubjectPeriodsPerWeek(prev => ({
              ...prev,
              [className]: {
                ...(prev[className] || {}),
                [subject]: nextValue
              }
            }));
          };

          // Auto-fill periods per week based on available slots
          const handleAutoFillPeriods = () => {
            const newSubjectPeriods = {};
            
            classes.forEach(className => {
              newSubjectPeriods[className] = {};
              
              // Get subjects assigned to this class
              const classAssignments = assignments[className] || {};
              const assignedSubjects = subjects.filter(sub => classAssignments[sub]);
              
              if (assignedSubjects.length === 0) {
                // No subjects assigned, set all to 0
                subjects.forEach(sub => {
                  newSubjectPeriods[className][sub] = 0;
                });
                return;
              }
              
              // Calculate available periods per week
              let totalPeriodsPerWeek = 0;
              workingDayLabels.forEach(day => {
                const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                totalPeriodsPerWeek += periodsForDay;
              });
              
              // Subtract lunch breaks
              totalPeriodsPerWeek -= workingDayLabels.length; // One lunch per day
              
              // Subtract fixed first periods
              let fixedPeriodsCount = 0;
              workingDayLabels.forEach(day => {
                if (firstPeriodAssignments[className]?.[day]?.subject) {
                  fixedPeriodsCount++;
                }
              });
              
              // Subtract events
              const classEvents = events.filter(e => e.className === className);
              fixedPeriodsCount += classEvents.length;
              
              const availablePeriods = totalPeriodsPerWeek - fixedPeriodsCount;
              
              // NEW: Respect teacher period limits and class teacher assignments
              const teacherPeriodLimits = {};
              const classTeacherAssignments = {};
              
              // Calculate teacher period limits based on their availability
              assignedSubjects.forEach(subject => {
                const teacher = classAssignments[subject];
                if (teacher) {
                  // Count how many periods this teacher can handle per week
                  let teacherMaxPeriods = 0;
                  workingDayLabels.forEach(day => {
                    const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                    const teacherStart = teacherStartPeriod[teacher] || 1;
                    let availablePeriodsForTeacher = 0;
                    
                    for (let p = 0; p < periodsForDay; p++) {
                      // Skip lunch break
                      if (p === lunchBreakPeriod - 1) continue;
                      // Skip periods before teacher starts
                      if (p < teacherStart - 1) continue;
                      // Skip last period if teacher has free period constraint
                      if (ensureTeacherFreePeriod && p === periodsForDay - 1) continue;
                      availablePeriodsForTeacher++;
                    }
                    teacherMaxPeriods += availablePeriodsForTeacher;
                  });
                  
                  teacherPeriodLimits[teacher] = teacherMaxPeriods;
                  
                  // Check if this teacher is the class teacher (assigned to multiple subjects)
                  const teacherSubjectCount = assignedSubjects.filter(sub => classAssignments[sub] === teacher).length;
                  if (teacherSubjectCount > 1) {
                    classTeacherAssignments[teacher] = teacherSubjectCount;
                  }
                }
              });
              
              // Distribute periods with respect to teacher limits and class teacher priority
              const periodsToDistribute = Math.min(availablePeriods, assignedSubjects.length * 2); // Cap at 2 periods per subject
              
              // First, assign periods to class teachers (teachers with multiple subjects)
              const classTeachers = Object.keys(classTeacherAssignments);
              let remainingPeriods = periodsToDistribute;
              
              classTeachers.forEach(teacher => {
                const teacherSubjects = assignedSubjects.filter(sub => classAssignments[sub] === teacher);
                const teacherLimit = teacherPeriodLimits[teacher] || 0;
                const maxPeriodsForTeacher = Math.min(teacherLimit, teacherSubjects.length * 2);
                
                // Distribute periods among this teacher's subjects
                const periodsPerSubject = Math.floor(maxPeriodsForTeacher / teacherSubjects.length);
                const remainder = maxPeriodsForTeacher % teacherSubjects.length;
                
                teacherSubjects.forEach((sub, index) => {
                const extraPeriod = index < remainder ? 1 : 0;
                  const assignedPeriods = Math.min(periodsPerSubject + extraPeriod, 2); // Max 2 periods per subject
                  newSubjectPeriods[className][sub] = assignedPeriods;
                  remainingPeriods -= assignedPeriods;
                });
              });
              
              // Then, assign periods to other teachers
              const otherSubjects = assignedSubjects.filter(sub => {
                const teacher = classAssignments[sub];
                return !classTeachers.includes(teacher);
              });
              
              if (otherSubjects.length > 0 && remainingPeriods > 0) {
                const periodsPerSubject = Math.floor(remainingPeriods / otherSubjects.length);
                const remainder = remainingPeriods % otherSubjects.length;
                
                otherSubjects.forEach((sub, index) => {
                  const teacher = classAssignments[sub];
                  const teacherLimit = teacherPeriodLimits[teacher] || 0;
                  const maxPeriodsForSubject = Math.min(teacherLimit, 2); // Max 2 periods per subject
                  
                  const extraPeriod = index < remainder ? 1 : 0;
                  const assignedPeriods = Math.min(periodsPerSubject + extraPeriod, maxPeriodsForSubject);
                  newSubjectPeriods[className][sub] = assignedPeriods;
                });
              }
              
              // Set unassigned subjects to 0
              subjects.forEach(sub => {
                if (!assignedSubjects.includes(sub)) {
                  newSubjectPeriods[className][sub] = 0;
                }
              });
            });
            
            setSubjectPeriodsPerWeek(newSubjectPeriods);
            alert('Periods have been automatically distributed with respect to teacher limits and class teacher assignments! Review the numbers and adjust if needed.');
          };

          // --- Absent Teacher & Proxy Management Functions ---
          const handleAbsentTeacherToggle = (teacher, isAbsent) => {
              setAbsentTeachers(prev => {
                  if (isAbsent) {
                      return [...prev, teacher];
                  } else {
                      // When a teacher is no longer absent, remove any proxy assignments for them
                      const newProxyAssignments = { ...proxyAssignments };
                      for (const key in newProxyAssignments) {
                          // Check if the proxy assignment key contains the teacher's name
                          // This assumes the key format is `${className}-${day}-${periodIndex}`
                          // We need to find all classes where this teacher was assigned
                          const [className, day, periodIndexStr] = key.split('-');
                          const periodIndex = parseInt(periodIndexStr);

                          if (originalTimetable?.[className]?.[day]?.[periodIndex]?.teacher === teacher) {
                              delete newProxyAssignments[key];
                          }
                      }
                      setProxyAssignments(newProxyAssignments);
                      return prev.filter(t => t !== teacher);
                  }
              });
          };

          const handleAddProxyTeacher = (newProxyTeacher) => {
              if (newProxyTeacher.trim() !== '' && !proxyTeachers.includes(newProxyTeacher.trim())) {
                  setProxyTeachers(prev => [...prev, newProxyTeacher.trim()]);
              }
          };

          const handleRemoveProxyTeacher = (proxyTeacherToRemove) => {
              setProxyTeachers(prev => prev.filter(t => t !== proxyTeacherToRemove));
          };

          const handleAssignProxy = (className, day, periodIndex, proxyTeacher) => {
              const key = `${className}-${day}-${periodIndex}`;
              setProxyAssignments(prev => ({
                  ...prev,
                  [key]: proxyTeacher
              }));
          };

          const handleRemoveProxyAssignment = (className, day, periodIndex) => {
              const key = `${className}-${day}-${periodIndex}`;
              setProxyAssignments(prev => {
                  const newAssignments = { ...prev };
                  delete newAssignments[key];
                  return newAssignments;
              });
          };

          const getAvailableProxyTeachersForPeriod = useCallback((day, periodIndex) => {
            const occupiedProxyTeachers = new Set();
            // Identify teachers already assigned as proxies for this specific day and period
            for (const key in proxyAssignments) {
                const [assignedClassName, assignedDay, assignedPeriodIndexStr] = key.split('-');
                const assignedPeriodIndex = parseInt(assignedPeriodIndexStr);

                if (assignedDay === day && assignedPeriodIndex === periodIndex) {
                    occupiedProxyTeachers.add(proxyAssignments[key]);
                }
            }

            const freeTeachers = teachers.filter(teacher => {
                // 1. Absent teachers cannot be proxies
                if (absentTeachers.includes(teacher)) return false;

                // 2. Check their original timetable slot
                const teacherLesson = teacherTimetable?.[teacher]?.[day]?.[periodIndex];
                if (!teacherLesson || teacherLesson.className !== 'Free') {
                    return false; // Not free in their original schedule
                }

                // 3. Check if they are already assigned as a proxy for another class in this slot
                if (occupiedProxyTeachers.has(teacher)) {
                    return false;
                }

                return true; // This teacher is available
            });

            // Combine truly free teachers and dedicated proxy teachers (who are not absent or already occupied)
            const dedicatedProxyTeachersAvailable = proxyTeachers.filter(pt =>
                !absentTeachers.includes(pt) && !occupiedProxyTeachers.has(pt)
            );

            const allAvailable = [...new Set([...freeTeachers, ...dedicatedProxyTeachersAvailable])];
            return allAvailable;
          }, [teachers, teacherTimetable, absentTeachers, proxyTeachers, proxyAssignments]);


          const openProxyAssignmentModal = (className, day, periodIndex, lesson, currentProxy = null) => {
            // Determine the original teacher for this specific class and slot
            const originalLesson = originalTimetable?.[className]?.[day]?.[periodIndex];
            const originalTeacher = originalLesson?.teacher;

            if (!originalTeacher) {
                console.warn(`No original teacher found for ${className} on ${day}, P${periodIndex}. Cannot assign proxy.`);
                return;
            }

            setProxyModalInfo({
                className,
                day,
                periodIndex,
                originalTeacher,
                subject: originalLesson?.subject || 'N/A',
                currentProxy: currentProxy // Pass the currently assigned proxy if any
            });
            setIsProxyModalOpen(true);
          };

          // --- End Absent Teacher & Proxy Management Functions ---

          // --- Manual Placement Handlers (strict) ---
          const applyManualPlacement = ({ className, day, periodIndex, subject, teacher }) => {
            if (!timetable || !teacherTimetable) { alert('Generate a timetable first.'); return; }
            if (!className || !day || !subject || !teacher) { alert('Please select all fields.'); return; }

            const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
            if (periodIndex < 0 || periodIndex >= periodsForDay) return;
            if (periodIndex === lunchBreakPeriod - 1) { alert('Cannot place during lunch/break.'); return; }

            // Check teacher start time
            const startP = (teacherStartPeriod[teacher] || 1) - 1;
            if (periodIndex < startP) { alert(`Teacher starts at P${startP + 1}.`); return; }

            // Check last period restriction
            const isLast = periodIndex === periodsForDay - 1;
            const restricted = lastPeriodSubjectRestrictions.some(r => r.className === className && r.subject === subject);
            if (isLast && restricted) { alert('Subject restricted from last period.'); return; }

            // Check teacher free at slot
            const tSlot = teacherTimetable[teacher]?.[day]?.[periodIndex];
            const teacherIsFree = !tSlot || tSlot.className === 'Free' || tSlot.subject === 'Free';
            if (!teacherIsFree) { alert('Teacher not free at this time.'); return; }

            // Check max periods (subjectPeriodsPerWeek)
            const targetMax = parseInt(subjectPeriodsPerWeek[className]?.[subject]) || 0;
            if (targetMax > 0) {
              let currentCount = 0;
              const classDayMap = timetable[className] || {};
              Object.keys(classDayMap).forEach(d => {
                (classDayMap[d] || []).forEach(lesson => {
                  if (lesson && lesson.subject === subject) currentCount++;
                });
              });
              // Count this placement preview; if already at max, block
              if (currentCount >= targetMax) { alert('Max periods for subject reached.'); return; }
            }

            // Check no-double-period rule (same day) if needed
            const alreadyOnDay = (timetable[className]?.[day] || []).some((l, idx) => idx !== periodIndex && l?.subject === subject);
            if (alreadyOnDay) {
              const ok = confirm(`${subject} already exists on ${day} for ${className}. Place anyway?`);
              if (!ok) return;
            }

            // Apply placement immutably
            const tt = JSON.parse(JSON.stringify(timetable));
            const tteach = JSON.parse(JSON.stringify(teacherTimetable));
            const prev = tt[className]?.[day]?.[periodIndex];
            if (prev?.teacher && tteach[prev.teacher] && tteach[prev.teacher][day]) {
              tteach[prev.teacher][day][periodIndex] = { className: 'Free', subject: 'Free' };
            }
            tt[className][day][periodIndex] = { subject, teacher };
            if (!tteach[teacher]) tteach[teacher] = {};
            if (!tteach[teacher][day]) tteach[teacher][day] = new Array(periodsForDay).fill(null);
            tteach[teacher][day][periodIndex] = { className, subject };

            setTimetable(tt);
            setTeacherTimetable(tteach);
            setIsManualOpen(false);
          };

          const clearManualPlacement = (className, day, periodIndex) => {
            if (!timetable || !teacherTimetable) return;
            const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
            if (periodIndex < 0 || periodIndex >= periodsForDay) return;

            const tt = JSON.parse(JSON.stringify(timetable));
            const tteach = JSON.parse(JSON.stringify(teacherTimetable));
            const prev = tt[className]?.[day]?.[periodIndex];
            if (prev?.teacher && tteach[prev.teacher] && tteach[prev.teacher][day]) {
              tteach[prev.teacher][day][periodIndex] = { className: 'Free', subject: 'Free' };
            }
            tt[className][day][periodIndex] = { subject: 'Free', teacher: null };

            setTimetable(tt);
            setTeacherTimetable(tteach);
            setIsManualOpen(false);
          };
          // --- End Manual Placement Handlers ---

          // Apply fixed Period 1 for a chosen day and subject across all classes
          const applyFirstPeriodToAllClasses = () => {
            const day = bulkFirstPeriodDay;
            const subject = bulkFirstPeriodSubject;
            if (!day || !subject) { alert('Select both day and subject.'); return; }
            const updated = { ...firstPeriodAssignments };
            classes.forEach(cls => {
              if (!updated[cls]) updated[cls] = {};
              const teacher = (assignments[cls] || {})[subject] || '';
              updated[cls][day] = { subject, teacher };
            });
            setFirstPeriodAssignments(updated);
            alert(`Applied Period 1 = ${subject} on ${day} for all classes.`);
          };
          // Auto-distribute Period 1 across a teacher's subjects for a class
          const autoDistributeFirstPeriodsByTeacher = (cls, teacher) => {
            if (!teacher) return;
            const classAssign = assignments[cls] || {};
            // Collect subjects taught by this teacher and requested counts
            const subjectsForTeacher = Object.keys(classAssign).filter(sub => classAssign[sub] === teacher);
            if (subjectsForTeacher.length === 0) { 
              alert(`Selected teacher "${teacher}" has no subjects assigned for class "${cls}". Please assign subjects to this teacher first.`); 
              return; 
            }

            // Map subject -> requested weekly count, but exclude subjects already assigned as bulk Period 1
            const requestedMap = {};
            let totalRequested = 0;
            subjectsForTeacher.forEach(sub => {
              const req = Math.max(0, parseInt((subjectPeriodsPerWeek?.[cls] || {})[sub]) || 0);
              
              // Check if this subject is already assigned as a bulk Period 1 assignment
              const isBulkSubject = workingDayLabels.some(day => {
                const assignment = firstPeriodAssignments[cls]?.[day];
                if (!assignment) return false;
                
                // Check if this is a bulk assignment (same subject across all classes)
                const isBulkAssignment = classes.every(c => {
                  const classAssignment = firstPeriodAssignments[c]?.[day];
                  return classAssignment && classAssignment.subject === assignment.subject;
                });
                
                return isBulkAssignment && assignment.subject === sub;
              });
              
              // If it's a bulk subject, don't include it in the distribution count
              if (!isBulkSubject) {
                requestedMap[sub] = req;
                totalRequested += req;
              } else {
                console.log(`Skipping ${sub} - already assigned as bulk Period 1`);
                requestedMap[sub] = 0; // Mark as 0 so it won't be distributed
              }
            });
            
            if (totalRequested === 0) { 
              const bulkSubjects = subjectsForTeacher.filter(sub => {
                return workingDayLabels.some(day => {
                  const assignment = firstPeriodAssignments[cls]?.[day];
                  if (!assignment) return false;
                  const isBulkAssignment = classes.every(c => {
                    const classAssignment = firstPeriodAssignments[c]?.[day];
                    return classAssignment && classAssignment.subject === assignment.subject;
                  });
                  return isBulkAssignment && assignment.subject === sub;
                });
              });
              
              if (bulkSubjects.length > 0) {
                alert(`All subjects taught by "${teacher}" are already assigned as bulk Period 1 assignments:\n${bulkSubjects.join(', ')}\n\nNo additional Period 1 distribution needed.`); 
              } else {
                alert(`Requested counts for teacher "${teacher}"'s subjects are zero. Please set period counts for subjects first.`); 
              }
              return; 
            }

            // Calculate teacher's total periods per week across all subjects (excluding bulk assignments)
            // This is the maximum number of Period 1 assignments this teacher should get
            const teacherTotalPeriodsPerWeek = totalRequested;

            // Determine available days (Period 1 positions respecting periodsPerDay/halfDay)
            // Check if there are any existing assignments for this teacher
            const existingAssignments = workingDayLabels.filter(day => {
              const assignment = firstPeriodAssignments[cls]?.[day];
              return assignment && assignment.teacher === teacher;
            });
            
            // If teacher already has assignments, ask if they want to overwrite
            if (existingAssignments.length > 0) {
              const overwrite = confirm(`Teacher "${teacher}" already has Period 1 assignments on: ${existingAssignments.join(', ')}\n\nDo you want to overwrite these assignments with new auto-distribution?`);
              if (!overwrite) return;
            }
            
            // Check if there are any other teachers' assignments that could be overwritten
            const otherTeacherAssignments = workingDayLabels.filter(day => {
              const assignment = firstPeriodAssignments[cls]?.[day];
              return assignment && assignment.teacher !== teacher;
            });
            
            // If there are other teachers' assignments, ask if user wants to overwrite them
            if (otherTeacherAssignments.length > 0) {
              const overwriteOthers = confirm(`There are existing Period 1 assignments by other teachers:\n${otherTeacherAssignments.map(day => {
                const assignment = firstPeriodAssignments[cls]?.[day];
                return `${day}: ${assignment?.subject} - ${assignment?.teacher}`;
              }).join('\n')}\n\nDo you want to overwrite these assignments to distribute Period 1 for ${teacher}?\n\nNote: This will replace the existing assignments with new ones for ${teacher}.`);
              if (!overwriteOthers) return;
            }
            
            // Get all available days (including those with existing assignments for this teacher)
            // BUT completely respect bulk assignments (applied to all classes) - NEVER touch them
            const allAvailableDays = workingDayLabels.filter(day => {
              const pForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
              const hasPeriod1 = pForDay > 0;
              const assignment = firstPeriodAssignments[cls]?.[day];
              
              // Check if this day has a bulk assignment (same subject across all classes)
              // Only skip if it's a TRUE bulk assignment (same subject across ALL classes)
              const isBulkAssignment = assignment && classes.every(c => {
                const classAssignment = firstPeriodAssignments[c]?.[day];
                return classAssignment && classAssignment.subject === assignment.subject;
              });
              
              // If it's a bulk assignment, NEVER touch it - even if it's the same teacher
              if (isBulkAssignment) {
                console.log(`Skipping ${day} - bulk assignment detected: ${assignment.subject} (applied to all classes)`);
                return false;
              }
              
              // Since user has confirmed they want to overwrite other teachers' assignments,
              // include all days that have Period 1 (except bulk assignments)
              return hasPeriod1;
            });

            // Limit the days to only assign as many as the teacher has total periods per week
            const days = allAvailableDays.slice(0, teacherTotalPeriodsPerWeek);
            
            // Debug information
            console.log(`Auto-distribute debug for ${cls}:`, {
              workingDayLabels,
              allAvailableDays,
              days,
              teacherTotalPeriodsPerWeek,
              firstPeriodAssignments: firstPeriodAssignments[cls],
              teacher,
              halfDays,
              periodsPerDay,
              halfDayPeriods,
              subjectsForTeacher,
              requestedMap,
              totalRequested
            });
            
            // Additional debug: Check each day's status
            workingDayLabels.forEach(day => {
              const assignment = firstPeriodAssignments[cls]?.[day];
              const isBulkAssignment = assignment && classes.every(c => {
                const classAssignment = firstPeriodAssignments[c]?.[day];
                return classAssignment && classAssignment.subject === assignment.subject;
              });
              console.log(`Day ${day}:`, {
                assignment,
                isBulkAssignment,
                isThisTeacher: assignment && assignment.teacher === teacher,
                allClassAssignments: classes.map(c => ({
                  class: c,
                  assignment: firstPeriodAssignments[c]?.[day]
                }))
              });
            });
            
            if (days.length === 0) { 
              const otherTeachers = workingDayLabels.map(day => {
                const assignment = firstPeriodAssignments[cls]?.[day];
                if (!assignment) return `${day}: No assignment`;
                
                // Check if it's a bulk assignment
                const isBulkAssignment = classes.every(c => {
                  const classAssignment = firstPeriodAssignments[c]?.[day];
                  return classAssignment && classAssignment.subject === assignment.subject;
                });
                
                if (isBulkAssignment) {
                  return `${day}: ${assignment.subject} ( BULK - Applied to all classes - PROTECTED)`;
                } else {
                  return `${day}: ${assignment.subject} - ${assignment.teacher}`;
                }
              }).join('\n');
              
              // Check if there are any non-bulk assignments that could be overwritten
              const nonBulkDays = workingDayLabels.filter(day => {
                const assignment = firstPeriodAssignments[cls]?.[day];
                if (!assignment) return true; // No assignment
                
                const isBulkAssignment = classes.every(c => {
                  const classAssignment = firstPeriodAssignments[c]?.[day];
                  return classAssignment && classAssignment.subject === assignment.subject;
                });
                
                return !isBulkAssignment; // Not a bulk assignment
              });
              
              if (nonBulkDays.length > 0) {
                // Limit to teacher's total periods per week
                const availableNonBulkDays = nonBulkDays.slice(0, teacherTotalPeriodsPerWeek);
                const forceOverwrite = confirm(`No available days for auto-distribution in class "${cls}".\n\nTeacher "${teacher}" has ${teacherTotalPeriodsPerWeek} total periods per week across all subjects.\n\nCurrent assignments:\n${otherTeachers}\n\nHowever, there are ${availableNonBulkDays.length} non-bulk assignment(s) that could be overwritten.\n\nDo you want to force overwrite these assignments?`);
                if (forceOverwrite) {
                  // Force distribution by including non-bulk days (limited to teacher's total periods)
                  const forceDays = availableNonBulkDays.filter(day => {
                    const pForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                    return pForDay > 0;
                  });
                  
                  if (forceDays.length > 0) {
                    // Proceed with force distribution
                    const updated = { ...firstPeriodAssignments };
                    if (!updated[cls]) updated[cls] = {};
                    
                    // Simple round-robin distribution - only for non-bulk subjects
                    const nonBulkSubjects = subjectsForTeacher.filter(sub => requestedMap[sub] > 0);
                    const subjectQueues = nonBulkSubjects.map(sub => ({ sub, remaining: Math.ceil(forceDays.length / nonBulkSubjects.length) }));
                    let sIndex = 0;
                    forceDays.forEach(day => {
                      const chosen = subjectQueues[sIndex % subjectQueues.length];
                      updated[cls][day] = { subject: chosen.sub, teacher };
                      sIndex++;
                    });
                    
                    setFirstPeriodAssignments(updated);
                    alert(` Force auto-distributed Period 1 for ${teacher} in class ${cls}!\n\n Days assigned: ${forceDays.join(', ')} (limited to ${teacherTotalPeriodsPerWeek} total periods per week)\n\nNote: This overwrote existing non-bulk assignments.`);
                    return;
                  }
                }
              }
              
              alert(`No available days for auto-distribution in class "${cls}".\n\nTeacher "${teacher}" has ${teacherTotalPeriodsPerWeek} total periods per week across all subjects.\n\nCurrent assignments:\n${otherTeachers}\n\n BULK assignments (applied to all classes) are COMPLETELY PROTECTED and cannot be overwritten by auto-distribute.\n\nTo use auto-distribute:\n1. Clear non-bulk assignments manually, OR\n2. Select a different teacher, OR\n3. Use the "Clear All" button to reset everything`); 
              return; 
            }

            // Compute allocation proportions across available days
            // Start with floor of proportional allocation, then distribute remainder
            const perSubjectTargets = {};
            let allocated = 0;
            subjectsForTeacher.forEach(sub => {
              // Only distribute subjects that are not bulk assignments (requestedMap[sub] > 0)
              if (requestedMap[sub] > 0) {
                const target = Math.floor((requestedMap[sub] / totalRequested) * days.length);
                perSubjectTargets[sub] = target;
                allocated += target;
              } else {
                perSubjectTargets[sub] = 0; // Bulk subjects get 0 distribution
              }
            });
            // Remainder distribution by highest fractional part and then by subjects with higher remaining need
            let remainder = Math.max(0, days.length - allocated);
            if (remainder > 0) {
              // compute fractional weights - only for non-bulk subjects
              const weighted = subjectsForTeacher.filter(sub => requestedMap[sub] > 0).map(sub => ({
                sub,
                frac: ((requestedMap[sub] / totalRequested) * days.length) - perSubjectTargets[sub],
                remainingNeed: requestedMap[sub] - perSubjectTargets[sub]
              }));
              weighted.sort((a, b) => b.frac - a.frac || b.remainingNeed - a.remainingNeed);
              let idx = 0;
              while (remainder > 0) {
                const w = weighted[idx % weighted.length];
                perSubjectTargets[w.sub] += 1;
                remainder -= 1;
                idx += 1;
              }
            }

            // Build a day-wise sequence by round-robin over subjects respecting targets
            // Only include subjects that are not bulk assignments
            const subjectQueues = subjectsForTeacher.filter(sub => requestedMap[sub] > 0).map(sub => ({ sub, remaining: perSubjectTargets[sub] }));
            // round-robin across days
            const updated = { ...firstPeriodAssignments };
            if (!updated[cls]) updated[cls] = {};
            let sIndex = 0;
            days.forEach(day => {
              // pick next subject with remaining > 0
              let loops = 0;
              while (loops < subjectQueues.length && subjectQueues[sIndex].remaining === 0) {
                sIndex = (sIndex + 1) % subjectQueues.length;
                loops += 1;
              }
              const chosen = subjectQueues[sIndex];
              if (!chosen || chosen.remaining === 0) return; // nothing left
              updated[cls][day] = { subject: chosen.sub, teacher };
              chosen.remaining -= 1;
              sIndex = (sIndex + 1) % subjectQueues.length;
            });

            setFirstPeriodAssignments(updated);
            
            // Show detailed success message
            const assignedDays = days.length;
            const distributedSubjects = subjectsForTeacher.filter(sub => requestedMap[sub] > 0);
            const bulkSubjects = subjectsForTeacher.filter(sub => requestedMap[sub] === 0);
            const subjectList = distributedSubjects.join(', ');
            const dayList = days.join(', ');
            
            // Check if any days were skipped due to bulk assignments
            const skippedDays = workingDayLabels.filter(day => {
              const assignment = firstPeriodAssignments[cls]?.[day];
              if (!assignment) return false;
              
              // Check if it's a bulk assignment
              const isBulkAssignment = classes.every(c => {
                const classAssignment = firstPeriodAssignments[c]?.[day];
                return classAssignment && classAssignment.subject === assignment.subject;
              });
              
              return isBulkAssignment;
            });
            
            let message = ` Successfully auto-distributed Period 1 for ${teacher} in class ${cls}!\n\n Distributed subjects: ${subjectList}\n Teacher's total periods per week: ${teacherTotalPeriodsPerWeek}\n Days assigned: ${assignedDays} (limited to teacher's total periods)\n Days: ${dayList}`;
            
            if (bulkSubjects.length > 0) {
              message += `\n\n Skipped bulk subjects (already assigned): ${bulkSubjects.join(', ')}`;
            }
            
            if (skippedDays.length > 0) {
              const skippedSubjects = skippedDays.map(day => {
                const assignment = firstPeriodAssignments[cls]?.[day];
                return `${day}: ${assignment?.subject}`;
              }).join(', ');
              
              message += `\n\n PROTECTED DAYS (bulk assignments - applied to all classes):\n${skippedSubjects}\n\nThese days were skipped because they have bulk assignments that cannot be overwritten.`;
            }
            
            // Show which assignments were overwritten
            const overwrittenDays = days.filter(day => {
              const assignment = firstPeriodAssignments[cls]?.[day];
              return assignment && assignment.teacher !== teacher;
            });
            
            if (overwrittenDays.length > 0) {
              message += `\n\n OVERWRITTEN ASSIGNMENTS:\n${overwrittenDays.map(day => {
                const assignment = firstPeriodAssignments[cls]?.[day];
                return `${day}: ${assignment?.subject} - ${assignment?.teacher}`;
              }).join('\n')}\n\nThese existing assignments were replaced with new ones for ${teacher}.`;
            }
            
            message += `\n\nCheck the table below to see the assignments.`;
            
            alert(message);
          };


          // Compute feasibility caps to avoid impossible searches
          const computeFeasibleRequestedCounts = (allowDoublePeriods) => {
              const requestedCounts = {};
              let unavoidableDeficit = 0;
              const reasons = {};

              classes.forEach(className => {
                  requestedCounts[className] = {};

                  // Pre-calc events per day for class
                  const eventsByDay = {};
                  (events || []).forEach(ev => {
                      if (ev.className === className) {
                          eventsByDay[ev.day] = (eventsByDay[ev.day] || 0) + 1;
                      }
                  });

                  const classAssignments = assignments[className] || {};
                  subjects.forEach(subject => {
                      const teacher = classAssignments[subject];
                      const requested = (subjectPeriodsPerWeek?.[className]?.[subject]) || 0;
                      if (!teacher || requested <= 0) {
                          requestedCounts[className][subject] = 0;
                          return;
                      }

                      // Class weekly availability: sum per-day available teaching slots excluding lunch, fixed first periods, events, and off-days
                      let classWeeklyAvail = 0;
                      let subjectPerDayCap = 0; // for no-double-periods mode
                      workingDayLabels.forEach(day => {
                          const pForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                          if (pForDay <= 0) return;
                          let avail = pForDay;
                          if (lunchBreakPeriod > 0 && lunchBreakPeriod <= pForDay) avail -= 1; // lunch
                          if (firstPeriodAssignments[className]?.[day]?.subject) avail -= 1; // fixed first period
                          const evCount = eventsByDay[day] || 0; // crude; safe upper bound
                          avail -= Math.min(avail, evCount);
                          if (avail < 0) avail = 0;

                          // Last period restriction: if restricted subject, remove last slot
                          const isRestrictedLast = lastPeriodSubjectRestrictions.some(r => r.className === className && r.subject === subject);
                          if (isRestrictedLast && avail > 0) avail -= 1;

                          classWeeklyAvail += Math.max(0, avail);

                          if (!allowDoublePeriods) {
                              // At most 1 per day if no double periods and there is at least one slot
                              subjectPerDayCap += avail > 0 ? 1 : 0;
                          }
                      });

                      // Teacher weekly availability (rough upper bound)
                      let teacherWeeklyAvail = 0;
                      workingDayLabels.forEach(day => {
                          const pForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                          if (pForDay <= 0) return;
                          const startP = (teacherStartPeriod?.[teacher] || 1) - 1;
                          let avail = 0;
                          for (let p = 0; p < pForDay; p++) {
                              if (p === (lunchBreakPeriod - 1)) continue;
                              if (p < startP) continue;
                              avail += 1;
                          }
                          if (ensureTeacherFreePeriod && avail > 0) avail -= 1; // keep at least one free per day
                          if (avail < 0) avail = 0;
                          teacherWeeklyAvail += avail;
                      });

                      const weeklyNoDoubleCap = allowDoublePeriods ? Infinity : subjectPerDayCap;
                      const feasible = Math.max(0, Math.min(requested, classWeeklyAvail, teacherWeeklyAvail, weeklyNoDoubleCap));
                      requestedCounts[className][subject] = feasible;
                      if (feasible < requested) {
                          unavoidableDeficit += (requested - feasible);
                          reasons[`${className}:${subject}`] = {
                              requested,
                              feasible,
                              reason: 'Constraint cap (slots/teacher availability/no-double-period)'
                          };
                      }
                  });
              });

              return { requestedCounts, unavoidableDeficit, reasons };
          };

          // The core timetable generation function
          const generateTimetable = async (allowDoublePeriods = true) => {
              setIsGenerating(true);
              setGeneratingProgress(0);

             // Configure dynamic attempt target and timers for responsiveness
             const MAX_GLOBAL_ATTEMPTS = Math.min(4000, Math.max(800, classes.length * workingDayLabels.length * periodsPerDay));
              const baselineAttempts = 1200;
              const baselineMs = 30000;
              const perAttemptMs = baselineMs / baselineAttempts; // heuristic pacing
              const dynamicMaxTimeMs = Math.min(300000, Math.max(baselineMs, Math.ceil(MAX_GLOBAL_ATTEMPTS * perAttemptMs))); // cap at 5 minutes
              setEstimatedTimeLeft(Math.ceil(dynamicMaxTimeMs / 1000));
              
              // Clear proxy assignments and free class reasons when generating a new timetable
              setProxyAssignments({});
              const newFreeClassReasons = {}; // Track reasons for any free classes
              
              // Disable time-based countdown; progress and ETA will derive from real attempt speed
              const countdownInterval = null;
              
              // Use setTimeout to allow UI to update with loading state
              // Pre-compute feasibility caps to avoid impossible searches
              const feasibility = computeFeasibleRequestedCounts(allowDoublePeriods);
              if (feasibility.unavoidableDeficit > 0) {
                  console.warn('Unavoidable subject deficits due to constraints:', feasibility);
                  alert(`Heads-up: ${feasibility.unavoidableDeficit} requested period(s) are infeasible given current constraints (teacher availability, slots, or no-double-periods). We'll generate the best possible timetable and show remaining deficits.`);
              }

              setTimeout(async () => {
                  let bestTimetable = null;
                  let bestTeacherSchedule = null;
                  let bestFreeCount = Infinity;
                  let bestDeficitCount = Infinity;
                  let bestFreeClassReasons = {};
                  let lastImprovementAttempt = -1;
                  
                  console.log(' Starting exhaustive timetable generation...');
                  console.log(`   Mode: ${allowDoublePeriods ? 'Allow Double Periods' : 'No Double Periods'}`);
                  
                  const startTime = Date.now();
                  let lastUpdateTime = startTime;
                  
                  for (let globalAttempt = 0; globalAttempt < MAX_GLOBAL_ATTEMPTS; globalAttempt++) {
                      // Allow UI to breathe frequently for real-time updates
                      if ((globalAttempt + 1) % 10 === 0) {
                          await new Promise(requestAnimationFrame);
                      }

                      // Update progress very frequently for live feedback
                      const currentTime = Date.now();
                      if (globalAttempt % 2 === 0 || currentTime - lastUpdateTime > 300) {
                          const elapsed = (currentTime - startTime) / 1000;
                          const avgTimePerAttempt = elapsed / (globalAttempt + 1);
                          const remainingAttempts = MAX_GLOBAL_ATTEMPTS - (globalAttempt + 1);
                          const etaSeconds = Math.max(0, Math.ceil(avgTimePerAttempt * remainingAttempts));
                          const progressPercent = Math.min(99, Math.floor(((globalAttempt + 1) / MAX_GLOBAL_ATTEMPTS) * 100));

                          setGenerationProgress({
                              current: globalAttempt + 1,
                              total: MAX_GLOBAL_ATTEMPTS,
                              timeLeft: etaSeconds
                          });
                          setEstimatedTimeLeft(etaSeconds);
                          setGeneratingProgress(progressPercent);

                          lastUpdateTime = currentTime;
                      }
                      // Generate a complete timetable attempt
                      const result = generateSingleTimetableAttempt(allowDoublePeriods, feasibility.requestedCounts);
                      const { newTimetable, teacherSchedule, freeCount, deficitCount, attemptFreeClassReasons } = result;
                      
                      // Track the best result so far
                      // PRIORITY 1: Minimize deficit (unfulfilled subject demands)
                      // PRIORITY 2: Minimize free periods
                      const isBetterSolution = 
                          deficitCount < bestDeficitCount || 
                          (deficitCount === bestDeficitCount && freeCount < bestFreeCount);
                      
                      if (isBetterSolution) {
                          bestDeficitCount = deficitCount;
                          bestFreeCount = freeCount;
                          bestTimetable = newTimetable;
                          bestTeacherSchedule = teacherSchedule;
                          bestFreeClassReasons = attemptFreeClassReasons;
                          lastImprovementAttempt = globalAttempt;
                          console.log(`    Attempt ${globalAttempt + 1}: Better solution - ${deficitCount} deficit, ${freeCount} free periods`);
                      }
                      
                      // If we found a zero-deficit solution, stop searching further (free periods may remain)
                      if (deficitCount === 0) {
                          console.log(`    ZERO DEFICIT achieved on attempt ${globalAttempt + 1} (free periods: ${freeCount})`);
                          break;
                      }

                      // Early stop if no improvement for a while
                      const STAGNATION_LIMIT = Math.min(1000, Math.floor(MAX_GLOBAL_ATTEMPTS / 3));
                      if (lastImprovementAttempt >= 0 && (globalAttempt - lastImprovementAttempt) > STAGNATION_LIMIT) {
                          console.warn('Stopping early due to stagnation without improvements.');
                          break;
                      }
                      
                      // Progress updates
                      if ((globalAttempt + 1) % 100 === 0) {
                          console.log(`    Attempt ${globalAttempt + 1}/${MAX_GLOBAL_ATTEMPTS} - Best: ${bestDeficitCount} deficit, ${bestFreeCount} free`);
                      }
                  }
                  
                  // Analyze final result
                  if (bestDeficitCount === 0 && bestFreeCount === 0) {
                      console.log(' SUCCESS: Generated timetable with ALL demands fulfilled and ZERO free periods!');
                  } else if (bestDeficitCount === 0) {
                      console.log(` SUCCESS: All subject demands fulfilled! (${bestFreeCount} free periods remain)`);
                  } else {
                      console.warn(` Could not fulfill all demands. Best result: ${bestDeficitCount} period deficit, ${bestFreeCount} free periods`);
                      
                      // Identify periods where ALL classes have free slots (cut periods)
                      const cutPeriods = identifyCutPeriods(bestTimetable);
                      if (cutPeriods.length > 0) {
                          console.warn(' The following periods have been cut (all classes are free):');
                          cutPeriods.forEach(cp => {
                              console.warn(`    ${cp.day}, Period ${cp.periodIndex + 1}`);
                              // Add alert in the free class reasons
                              classes.forEach(className => {
                                  const key = `${className}-${cp.day}-${cp.periodIndex}`;
                                  if (!bestFreeClassReasons[key]) {
                                      bestFreeClassReasons[key] = {
                                          className,
                                          day: cp.day,
                                          periodIndex: cp.periodIndex,
                                          reasons: [' This period has been cut - all classes are free at this time'],
                                          affectedSubjects: []
                                      };
                                  } else {
                                      bestFreeClassReasons[key].reasons.unshift(' This period has been cut - all classes are free at this time');
                                  }
                              });
                          });
                          
                          // Show alert to user about cut periods
                          const cutPeriodsText = cutPeriods.map(cp => `${cp.day} - Period ${cp.periodIndex + 1}`).join('\n');
                          alert(` Unable to schedule all periods without conflicts.\n\nThe following periods have been cut (all classes are free):\n\n${cutPeriodsText}\n\nThis usually happens when:\n- Too many constraints are applied\n- Teachers have limited availability\n- Subject requirements cannot all be met`);
                      }
                      
                      // Show alert about unfulfilled subject demands
                      if (bestDeficitCount > 0) {
                          alert(` Subject Period Deficit Alert!\n\n${bestDeficitCount} subject period(s) could not be scheduled despite being requested.\n\nCheck the subject-wise breakdown in each class timetable to see which subjects are affected.\n\nCommon causes:\n- Teacher availability conflicts\n- Too many constraints (no double periods, late arrivals, etc.)\n- Insufficient time slots\n- Last period restrictions\n\nTip: Try adjusting teacher start times, enabling double periods, or reducing period requirements.`);
                      }
                  }
                  
                  clearInterval(countdownInterval);
                  
                  // Show completion animation
                  setGeneratingProgress(100);
                  setEstimatedTimeLeft(0); // jump to 0 at completion
                  
                  // Set the timetable data
                  setTimetable(bestTimetable);
                  setTeacherTimetable(bestTeacherSchedule);
                  setOriginalTimetable(bestTimetable);
                  setFreeClassReasons(bestFreeClassReasons);
                  
                  // Show 100% completion briefly before hiding
                  setTimeout(() => {
                      setIsGenerating(false);
                      setGeneratingProgress(0);
                  }, 800); // Slightly longer to show success
              }, 500);
          };
          
          // Helper function to identify periods where ALL classes have free slots
          const identifyCutPeriods = (timetable) => {
              const cutPeriods = [];
              
              workingDayLabels.forEach(day => {
                  const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                  
                  for (let periodIndex = 0; periodIndex < periodsForDay; periodIndex++) {
                      // Check if this period is lunch break
                      if (periodIndex === lunchBreakPeriod - 1) {
                          continue; // Skip lunch breaks
                      }
                      
                      // Check if ALL classes are free at this period
                      let allClassesFree = true;
                      for (const className of classes) {
                          const lesson = timetable[className]?.[day]?.[periodIndex];
                          if (lesson && lesson.subject !== 'Free') {
                              allClassesFree = false;
                              break;
                          }
                      }
                      
                      if (allClassesFree && classes.length > 0) {
                          cutPeriods.push({ day, periodIndex });
                      }
                  }
              });
              
              return cutPeriods;
          };
          // Helper function to generate a single timetable attempt
          const generateSingleTimetableAttempt = (allowDoublePeriods, feasibleRequestedCounts = null) => {
              const attemptFreeClassReasons = {};
              
              // Original timetable generation logic starts here
                  // 1. Initialize Teacher Schedule and Class Timetable
                  const teacherSchedule = {};
                  teachers.forEach(teacher => {
                    teacherSchedule[teacher] = {};
                    workingDayLabels.forEach(day => {
                      const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                      teacherSchedule[teacher][day] = new Array(periodsForDay).fill(null);
                    });
                  });

                  const newTimetable = {};
                  classes.forEach(className => {
                    newTimetable[className] = {};
                    workingDayLabels.forEach(day => {
                      const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                      newTimetable[className][day] = new Array(periodsForDay).fill({ subject: 'Free', teacher: null });
                    });
                  });

                  // 2. Pre-fill Constraints: Breaks, Fixed First Periods, and Events
                  workingDayLabels.forEach(day => {
                      const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                      
                      // 2a. Lunch Break
                      if (lunchBreakPeriod > 0 && lunchBreakPeriod <= periodsForDay) {
                          const breakIndex = lunchBreakPeriod - 1;
                          classes.forEach(className => {
                              newTimetable[className][day][breakIndex] = { subject: breakLabel, teacher: 'School Event' };
                          });
                          teachers.forEach(teacher => {
                              teacherSchedule[teacher][day][breakIndex] = { className: breakLabel, subject: 'Break' };
                          });
                      }
                      
                      classes.forEach(className => {
                          // 2b. Fixed First Periods
                          const firstPeriodIndex = 0;
                          const assignment = firstPeriodAssignments[className]?.[day];
                          if (assignment && assignment.subject && assignment.teacher && firstPeriodIndex < periodsForDay) {
                              const { subject, teacher } = assignment;
                              if (newTimetable[className][day][firstPeriodIndex].subject === 'Free' && teacherSchedule[teacher][day][firstPeriodIndex] === null) {
                                  newTimetable[className][day][firstPeriodIndex] = { subject, teacher };
                                  teacherSchedule[teacher][day][firstPeriodIndex] = { className, subject };
                              } else {
                                  newTimetable[className][day][firstPeriodIndex] = { subject: 'CONFLICT/FIXED', teacher: 'SYSTEM' }; 
                                  console.warn(`Conflict: Could not place fixed first period for ${className} on ${day}.`);
                              }
                          }
                      });
                  });
                  
                  // 2c. Events/Test Days
                  events.forEach(event => {
                      const { className, day, period, label } = event;
                      const periodIndex = period - 1;
                      const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                      
                      if (newTimetable[className]?.[day]?.[periodIndex] && periodIndex < periodsForDay && newTimetable[className][day][periodIndex].subject === 'Free') {
                          newTimetable[className][day][periodIndex] = { subject: label, teacher: 'Event Coordinator' };
                      } else {
                          if (newTimetable[className]?.[day]?.[periodIndex] && newTimetable[className][day][periodIndex].subject !== 'Free') {
                            newTimetable[className][day][periodIndex] = { subject: 'CONFLICT/EVENT', teacher: 'SYSTEM' }; 
                          }
                          console.warn(`Conflict: Could not place event for ${className} on ${day} period ${period}.`);
                      }
                  });


                  // 3. Determine Required Assignments (periods per subject per class)
                  // Use feasibility-capped requested counts when provided, else use subjectPeriodsPerWeek
                  const periodsToAssignPerSubject = {}; // { className: { subject: count } }
                  classes.forEach(className => {
                      periodsToAssignPerSubject[className] = {};
                      const classAssignments = assignments[className] || {};
                      const subjectsForClass = subjects.filter(sub => classAssignments[sub]);

                      // Class Teacher feature removed

                      // Count available slots
                      let totalAvailableSlotsForFloating = 0;
                      workingDayLabels.forEach(day => {
                          const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                          for (let p = 0; p < periodsForDay; p++) {
                              if (newTimetable[className][day][p].subject === 'Free') {
                                  totalAvailableSlotsForFloating++;
                              }
                          }
                      });

                      // ONLY assign periods that user explicitly set
                      let totalFixedPeriodsRequested = 0;
                      subjectsForClass.forEach(subject => {
                          const fixedCount = (feasibleRequestedCounts?.[className]?.[subject] !== undefined)
                            ? feasibleRequestedCounts[className][subject]
                            : subjectPeriodsPerWeek[className]?.[subject];
                          if (fixedCount !== undefined && fixedCount > 0) {
                              periodsToAssignPerSubject[className][subject] = fixedCount;
                              totalFixedPeriodsRequested += fixedCount;
                          } else {
                              // If no count specified, set to 0 (don't auto-distribute)
                              periodsToAssignPerSubject[className][subject] = 0;
                          }
                      });

                      // Warn if fixed periods exceed available slots
                      if (totalFixedPeriodsRequested > totalAvailableSlotsForFloating) {
                          console.warn(`Warning: Fixed periods requested for ${className} (${totalFixedPeriodsRequested}) exceed available slots (${totalAvailableSlotsForFloating}). Some periods may not be scheduled.`);
                      }
                  });


                  // --- START STRICT TIMETABLE GENERATION LOGIC ---
                  // 4. Place ONLY the exact number of periods requested by user
                  const assignmentsPlaced = {}; // Track how many periods have been placed for each subject
                  for (const cls in periodsToAssignPerSubject) {
                      assignmentsPlaced[cls] = {};
                      for (const sub in periodsToAssignPerSubject[cls]) {
                          assignmentsPlaced[cls][sub] = 0;
                      }
                  }

                  // Count periods already placed by fixed first periods, events, and breaks
                  classes.forEach(className => {
                      workingDayLabels.forEach(day => {
                          const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                          for (let periodIndex = 0; periodIndex < periodsForDay; periodIndex++) {
                              const lesson = newTimetable[className][day][periodIndex];
                              if (lesson && lesson.subject !== 'Free' && lesson.teacher !== 'School Event' && lesson.teacher !== 'Event Coordinator' && lesson.teacher !== 'SYSTEM') {
                                  // This is a real subject period (fixed first period or other pre-placed period)
                                  if (assignmentsPlaced[className] && assignmentsPlaced[className][lesson.subject] !== undefined) {
                                      assignmentsPlaced[className][lesson.subject]++;
                                      console.log(`   Pre-counted ${lesson.subject} for ${className} (already placed on ${day} P${periodIndex + 1})`);
                                  } else if (assignmentsPlaced[className]) {
                                      // Initialize counter for this subject if it wasn't in the list
                                      assignmentsPlaced[className][lesson.subject] = 1;
                                      console.log(`   Pre-counted ${lesson.subject} for ${className} (already placed on ${day} P${periodIndex + 1}) - initialized`);
                                  }
                              }
                          }
                      });
                  });

                  // Helper function to count teacher's free periods on a specific day
                  const countTeacherFreePeriods = (teacher, day) => {
                      const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                      const teacherStart = teacherStartPeriod[teacher] || 1;
                      let freeCount = 0;
                      
                      for (let p = 0; p < periodsForDay; p++) {
                          // Skip periods before teacher starts
                          if (p < teacherStart - 1) continue;
                          
                          const slot = teacherSchedule[teacher]?.[day]?.[p];
                          // Count as free if: null (unfilled), or already marked as Free
                          if (slot === null || (slot && (slot.className === 'Free' || slot.subject === 'Free'))) {
                              // Don't count lunch break as a free period
                              if (p !== lunchBreakPeriod - 1) {
                                  freeCount++;
                              }
                          }
                      }
                      
                      return freeCount;
                  };

                  // Helper function to check if we can place a subject in a slot
                  const canPlaceSubject = (className, subject, teacher, day, periodIndex, currentPlacedCount, relaxConstraints = false) => {
                      // Check if already placed enough periods for this subject
                      const requestedCount = periodsToAssignPerSubject[className]?.[subject] || 0;
                      if (requestedCount === 0 || currentPlacedCount >= requestedCount) {
                          return false; // Don't place if no periods requested or already placed enough
                      }

                      // Check teacher start time
                      const teacherStart = teacherStartPeriod[teacher] || 1;
                      if (periodIndex < teacherStart - 1) return false;
                      
                      // Check last period restrictions (can be relaxed)
                      const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                      const isLastPeriod = periodIndex === periodsForDay - 1;
                      const isRestrictedSubject = lastPeriodSubjectRestrictions.some(r => r.className === className && r.subject === subject);
                      if (!relaxConstraints && isLastPeriod && isRestrictedSubject) return false;

                      // Check teacher availability
                      const isTeacherSlotFree = teacherSchedule[teacher]?.[day]?.[periodIndex] === null;
                      if (!isTeacherSlotFree) return false;

                      // Check if assigning this period would violate teacher free period constraint (can be relaxed)
                      if (!relaxConstraints && ensureTeacherFreePeriod) {
                          const teacherFreePeriods = countTeacherFreePeriods(teacher, day);
                          // If teacher currently has only 1 free period and we're about to fill it, skip
                          if (teacherFreePeriods <= 1) {
                              return false;
                          }
                      }

                      // Check double period restriction (can be relaxed if allowDoublePeriods is true)
                      if (!allowDoublePeriods && !relaxConstraints) {
                          const isSubjectAlreadyOnDay = newTimetable[className][day].some((lesson, index) => index !== periodIndex && lesson.subject === subject);
                          if (isSubjectAlreadyOnDay) return false;
                      }

                      return true;
                  };

                  // Collect all initially free slots per class
                  const freeSlotsByClass = {};
                  classes.forEach(className => {
                      freeSlotsByClass[className] = [];
                      workingDayLabels.forEach(day => {
                          const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                          for (let periodIndex = 0; periodIndex < periodsForDay; periodIndex++) {
                              if (newTimetable[className][day][periodIndex].subject === 'Free') {
                                  freeSlotsByClass[className].push({ day, periodIndex });
                              }
                          }
                      });
                  });

                  // Place periods for each class using a round-robin approach
                  // PRIORITY: Fulfill exact requested amounts, leave slots free if needed
                  classes.forEach(className => {
                      const classAssignments = assignments[className] || {};
                      const subjectsForClass = Object.keys(periodsToAssignPerSubject[className] || {})
                          .filter(sub => periodsToAssignPerSubject[className][sub] > 0)
                          .sort(() => Math.random() - 0.5); // Randomize initial order for fairness

                      console.log(` Scheduling ${className}:`, periodsToAssignPerSubject[className]);

                      // Try multiple times with different strategies
                      let maxAttempts = 100; // Increased attempts for better success rate
                      let attempt = 0;
                      
                      while (attempt < maxAttempts) {
                          // Shuffle slots for variety on each attempt
                          const shuffledSlots = [...freeSlotsByClass[className]].sort(() => Math.random() - 0.5);
                          
                          // Progressive constraint relaxation
                          // After 30 attempts, start relaxing constraints to fulfill demands
                          const shouldRelaxConstraints = attempt >= 30;
                          
                          // ROUND-ROBIN APPROACH: Place one period at a time for each subject
                          // This prevents any subject from monopolizing teacher time
                          let anyPlacedInRound = true;
                          
                          while (anyPlacedInRound) {
                              anyPlacedInRound = false;
                              
                              // Try to place ONE period for each subject that still needs periods
                              for (const subject of subjectsForClass) {
                                  const teacher = classAssignments[subject];
                                  if (!teacher) continue;

                                  const requestedCount = periodsToAssignPerSubject[className][subject];
                                  const placedCount = assignmentsPlaced[className][subject];

                                  // CRITICAL: Stop if we've already placed the exact requested amount
                                  if (placedCount >= requestedCount) {
                                      continue; // Already placed enough - DO NOT place more
                                  }

                                  // Try to place ONE period for this subject
                                  for (const slot of shuffledSlots) {
                                      const { day, periodIndex } = slot;
                                      
                                      // Check if slot is still free
                                      if (newTimetable[className][day][periodIndex].subject !== 'Free') {
                                          continue;
                                      }

                                      // Double-check we haven't exceeded the limit (safety check)
                                      if (assignmentsPlaced[className][subject] >= requestedCount) {
                                          break; // Stop trying to place this subject
                                      }

                                      // Check if we can place this subject here (pass current count + relaxation flag)
                                      if (canPlaceSubject(className, subject, teacher, day, periodIndex, assignmentsPlaced[className][subject], shouldRelaxConstraints)) {
                                          // Place the assignment
                                          newTimetable[className][day][periodIndex] = { subject, teacher };
                                          teacherSchedule[teacher][day][periodIndex] = { className, subject };
                                          assignmentsPlaced[className][subject]++;
                                          anyPlacedInRound = true;
                                          
                                          // Log placement for debugging
                                          const relaxMsg = shouldRelaxConstraints ? ' [RELAXED]' : '';
                                          console.log(`   Placed ${subject} for ${className} (${assignmentsPlaced[className][subject]}/${requestedCount}) on ${day} P${periodIndex + 1}${relaxMsg}`);
                                          
                                          break; // Place only ONE period per subject per round
                                      }
                                  }
                              }
                          }

                          // Check if all subjects for this class have been fully scheduled
                          let allPlacedForClass = true;
                          for (const subject of subjectsForClass) {
                              const requestedCount = periodsToAssignPerSubject[className][subject];
                              const placedCount = assignmentsPlaced[className][subject];
                              if (placedCount < requestedCount) {
                                  allPlacedForClass = false;
                                  break;
                              }
                          }

                          if (allPlacedForClass) {
                              console.log(` ${className}: All subjects fully scheduled!`);
                              break; // All subjects placed for this class
                          }

                          attempt++;
                          
                          // If we're stuck and not making progress, try different strategies
                          if (attempt > 10 && attempt % 10 === 0) {
                              // Try different subject ordering
                              subjectsForClass.sort((a, b) => {
                                  const aNeeded = periodsToAssignPerSubject[className][a] - assignmentsPlaced[className][a];
                                  const bNeeded = periodsToAssignPerSubject[className][b] - assignmentsPlaced[className][b];
                                  return bNeeded - aNeeded; // Prioritize subjects that need more periods
                              });
                          }
                      }

                      // Log final status and any subjects that couldn't be fully scheduled
                      console.log(` ${className} Final Status:`);
                      for (const subject of subjectsForClass) {
                          const requestedCount = periodsToAssignPerSubject[className][subject];
                          const placedCount = assignmentsPlaced[className][subject];
                          console.log(`  ${subject}: ${placedCount}/${requestedCount} periods`);
                          if (placedCount < requestedCount) {
                              console.warn(` ${className} - ${subject}: Could only place ${placedCount}/${requestedCount} periods. Check teacher availability and constraints.`);
                          } else if (placedCount > requestedCount) {
                              console.error(` BUG: ${className} - ${subject}: Placed ${placedCount}/${requestedCount} periods (TOO MANY!)`);
                          }
                      }
                  });

                  // --- END STRICT TIMETABLE GENERATION LOGIC ---

                  // 5. AUTO-FILL REMAINING FREE PERIODS TO ACHIEVE ZERO FREE CLASSES
                  console.log(' PHASE 2: Auto-filling remaining free periods...');
                  
                  classes.forEach(className => {
                      const classAssignments = assignments[className] || {};
                      const subjectsForClass = Object.keys(periodsToAssignPerSubject[className] || {})
                          .filter(sub => periodsToAssignPerSubject[className][sub] >= 0);
                      
                      // Identify all remaining free slots for this class
                      const remainingFreeSlots = [];
                      workingDayLabels.forEach(day => {
                          const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                          for (let periodIndex = 0; periodIndex < periodsForDay; periodIndex++) {
                              if (newTimetable[className][day][periodIndex].subject === 'Free') {
                                  remainingFreeSlots.push({ day, periodIndex });
                              }
                          }
                      });
                      
                      if (remainingFreeSlots.length === 0) {
                          console.log(` ${className}: No free periods - perfect schedule!`);
                          return;
                      }
                      
                      console.log(` ${className}: Attempting to fill ${remainingFreeSlots.length} free periods...`);
                      
                      // Try to fill each free slot
                      remainingFreeSlots.forEach(slot => {
                          const { day, periodIndex } = slot;
                          const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                          const isLastPeriod = periodIndex === periodsForDay - 1;
                          
                          let placed = false;
                          const reasons = [];
                          
                          // Try each subject for this class
                          for (const subject of subjectsForClass) {
                              const teacher = classAssignments[subject];
                              if (!teacher) {
                                  reasons.push(`${subject}: No teacher assigned`);
                                  continue;
                              }
                              
                              // Check teacher start time
                              const teacherStart = teacherStartPeriod[teacher] || 1;
                              if (periodIndex < teacherStart - 1) {
                                  reasons.push(`${subject}: Teacher ${teacher} not available (starts at P${teacherStart})`);
                                  continue;
                              }
                              
                              // Check last period restrictions
                              const isRestrictedSubject = lastPeriodSubjectRestrictions.some(r => r.className === className && r.subject === subject);
                              if (isLastPeriod && isRestrictedSubject) {
                                  reasons.push(`${subject}: Restricted from last period`);
                                  continue;
                              }
                              
                              // Check teacher availability
                              const isTeacherSlotFree = teacherSchedule[teacher]?.[day]?.[periodIndex] === null;
                              if (!isTeacherSlotFree) {
                                  const teacherConflict = teacherSchedule[teacher]?.[day]?.[periodIndex];
                                  reasons.push(`${subject}: Teacher ${teacher} busy with ${teacherConflict?.className || 'another class'}`);
                                  continue;
                              }
                              
                              // NEW: Check if assigning this period would violate teacher free period constraint
                              if (ensureTeacherFreePeriod) {
                                  const teacherFreePeriods = countTeacherFreePeriods(teacher, day);
                                  // If teacher currently has only 1 free period and we're about to fill it, skip
                                  if (teacherFreePeriods <= 1) {
                                      reasons.push(`${subject}: Teacher ${teacher} needs at least one free period`);
                                      continue;
                                  }
                              }
                              
                              // Check double period restriction
                              const isSubjectAlreadyOnDay = !allowDoublePeriods && newTimetable[className][day].some((lesson, index) => index !== periodIndex && lesson.subject === subject);
                              if (isSubjectAlreadyOnDay) {
                                  reasons.push(`${subject}: Already scheduled on ${day} (no double periods mode)`);
                                  continue;
                              }
                              
                              // ALL CHECKS PASSED - Place the period!
                              newTimetable[className][day][periodIndex] = { subject, teacher };
                              teacherSchedule[teacher][day][periodIndex] = { className, subject };
                              assignmentsPlaced[className][subject]++;
                              placed = true;
                              console.log(`   Auto-filled ${className} ${day} P${periodIndex + 1} with ${subject} (${teacher})`);
                              break;
                          }
                          
                          // If couldn't place anything, record the reason
                          if (!placed) {
                              const key = `${className}-${day}-${periodIndex}`;
                              attemptFreeClassReasons[key] = {
                                  className,
                                  day,
                                  periodIndex,
                                  reasons: reasons.length > 0 ? reasons : ['No subjects available to schedule'],
                                  affectedSubjects: subjectsForClass.map(sub => {
                                      const requested = periodsToAssignPerSubject[className][sub] || 0;
                                      const placed = assignmentsPlaced[className][sub] || 0;
                                      return { subject: sub, requested, placed, deficit: Math.max(0, requested - placed) };
                                  }).filter(s => s.deficit > 0)
                              };
                          }
                      });
                  });

                  // 6. Fill Remaining Teacher Free Slots
                  teachers.forEach(teacher => {
                      workingDayLabels.forEach(day => {
                          const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                          for (let p = 0; p < periodsForDay; p++) {
                              if (teacherSchedule[teacher][day][p] === null) {
                                  if (p < (teacherStartPeriod[teacher] || 1) - 1) {
                                      teacherSchedule[teacher][day][p] = { className: 'Unavailable', subject: 'Late Arrival' };
                                  } else {
                                      teacherSchedule[teacher][day][p] = { className: 'Free', subject: 'Free' };
                                  }
                              }
                          }
                      });
                  });
                  
                  // Free period counting is performed after potential repair phase below
                  
                  // Count total subject period deficit (requested but not scheduled)
                  let totalDeficit = 0;
                  classes.forEach(className => {
                      const classSubjects = Object.keys(periodsToAssignPerSubject[className] || {});
                      classSubjects.forEach(subject => {
                          const requested = periodsToAssignPerSubject[className][subject] || 0;
                          const placed = assignmentsPlaced[className][subject] || 0;
                          const deficit = Math.max(0, requested - placed);
                          totalDeficit += deficit;
                      });
                  });

                  // 5b. DEFICIT REPAIR PHASE (aggressive): try to fulfill remaining requested periods via relaxed placement and swaps
                  if (totalDeficit > 0) {
                      console.log(' PHASE 2b: Deficit repair started...', totalDeficit);
                      // Attempt a bounded number of repairs proportional to deficits
                      let repairBudget = Math.min(2000, 50 + totalDeficit * 10);
                      while (repairBudget > 0) {
                          let repairedAny = false;
                          for (const className of classes) {
                              const classSubjects = Object.keys(periodsToAssignPerSubject[className] || {});
                              for (const subject of classSubjects) {
                                  const requested = periodsToAssignPerSubject[className][subject] || 0;
                                  const placed = assignmentsPlaced[className][subject] || 0;
                                  if (placed >= requested) continue; // no deficit for this subject

                                  const teacher = (assignments[className] || {})[subject];
                                  if (!teacher) continue;

                                  // First, try to place into any free slot for this class, ignoring last-period and free-period constraints
                                  let placedNow = false;
                                  for (const day of workingDayLabels) {
                                      const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                                      for (let p = 0; p < periodsForDay; p++) {
                                          // Skip lunch
                                          if (p === lunchBreakPeriod - 1) continue;
                                          const cell = newTimetable[className][day][p];
                                          if (cell.subject === 'Free') {
                                              // Relax: ignore ensureTeacherFreePeriod/last-period restrictions; only require teacher slot free or free-ish
                                              const teacherSlot = teacherSchedule[teacher]?.[day]?.[p];
                                              const teacherAvailable = teacherSlot === null || (teacherSlot && (teacherSlot.className === 'Free' || teacherSlot.subject === 'Free'));
                                              // Also allow if teacher is truly unassigned
                                              if (teacherAvailable) {
                                                  newTimetable[className][day][p] = { subject, teacher };
                                                  teacherSchedule[teacher][day][p] = { className, subject };
                                                  assignmentsPlaced[className][subject] = (assignmentsPlaced[className][subject] || 0) + 1;
                                                  repairedAny = true;
                                                  placedNow = true;
                                                  break;
                                              }
                                          }
                                      }
                                      if (placedNow) break;
                                  }

                                  if (placedNow) continue;

                                  // If no free slot worked, try a constrained swap: replace an overfilled subject in this class where target teacher is free
                                  // Identify overfilled subjects for this class
                                  const overfilled = classSubjects.filter(su => (assignmentsPlaced[className][su] || 0) > (periodsToAssignPerSubject[className][su] || 0));
                                  if (overfilled.length > 0) {
                                      for (const day of workingDayLabels) {
                                          const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                                          for (let p = 0; p < periodsForDay; p++) {
                                              if (p === lunchBreakPeriod - 1) continue;
                                              const cell = newTimetable[className][day][p];
                                              if (cell && overfilled.includes(cell.subject)) {
                                                  const occupiedTeacherSlot = teacherSchedule[teacher]?.[day]?.[p];
                                                  const teacherFreeHere = occupiedTeacherSlot === null || (occupiedTeacherSlot && (occupiedTeacherSlot.className === 'Free' || occupiedTeacherSlot.subject === 'Free'));
                                                  if (teacherFreeHere) {
                                                      // Remove the overfill period's teacher from this slot
                                                      const oldSubject = cell.subject;
                                                      const oldTeacher = cell.teacher;
                                                      newTimetable[className][day][p] = { subject, teacher };
                                                      teacherSchedule[teacher][day][p] = { className, subject };
                                                      // Free the old teacher at this slot
                                                      if (oldTeacher && teacherSchedule[oldTeacher] && teacherSchedule[oldTeacher][day]) {
                                                          teacherSchedule[oldTeacher][day][p] = { className: 'Free', subject: 'Free' };
                                                      }
                                                      // Adjust counts
                                                      assignmentsPlaced[className][subject] = (assignmentsPlaced[className][subject] || 0) + 1;
                                                      assignmentsPlaced[className][oldSubject] = Math.max(0, (assignmentsPlaced[className][oldSubject] || 1) - 1);
                                                      repairedAny = true;
                                                      placedNow = true;
                                                      break;
                                                  }
                                              }
                                          }
                                          if (placedNow) break;
                                      }
                                  }

                                  if (!placedNow) {
                                      // Relocation attempt: move the blocking subject to another free slot to free this slot
                                      for (const day of workingDayLabels) {
                                          const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                                          for (let p = 0; p < periodsForDay; p++) {
                                              if (p === lunchBreakPeriod - 1) continue;
                                              const cell = newTimetable[className][day][p];
                                              if (cell && cell.subject !== 'Free') {
                                                  const blockingSubject = cell.subject;
                                                  const blockingTeacher = cell.teacher;
                                                  // Try to relocate this blocking subject to another free slot for the same class
                                                  let relocated = false;
                                                  for (const altDay of workingDayLabels) {
                                                      const altPeriodsForDay = halfDays.includes(altDay) ? halfDayPeriods : periodsPerDay;
                                                      for (let altP = 0; altP < altPeriodsForDay; altP++) {
                                                          if (altP === lunchBreakPeriod - 1) continue;
                                                          if (newTimetable[className][altDay][altP].subject !== 'Free') continue;
                                                          // Check blocking teacher availability on alt slot
                                                          const blockingTeacherFree = teacherSchedule[blockingTeacher]?.[altDay]?.[altP] === null || (teacherSchedule[blockingTeacher]?.[altDay]?.[altP] && (teacherSchedule[blockingTeacher][altDay][altP].className === 'Free' || teacherSchedule[blockingTeacher][altDay][altP].subject === 'Free'));
                                                          // Respect teacher start time for blocking teacher
                                                          const blockingTeacherStart = (teacherStartPeriod[blockingTeacher] || 1) - 1;
                                                          if (altP < blockingTeacherStart) continue;
                                                          if (!blockingTeacherFree) continue;
                                                          // Move blocking subject
                                                          newTimetable[className][altDay][altP] = { subject: blockingSubject, teacher: blockingTeacher };
                                                          teacherSchedule[blockingTeacher][altDay][altP] = { className, subject: blockingSubject };
                                                          // Free original blocking slot to place our deficit subject
                                                          newTimetable[className][day][p] = { subject: 'Free', teacher: null };
                                                          if (teacherSchedule[blockingTeacher] && teacherSchedule[blockingTeacher][day]) {
                                                              teacherSchedule[blockingTeacher][day][p] = { className: 'Free', subject: 'Free' };
                                                          }
                                                          relocated = true;
                                                          break;
                                                      }
                                                      if (relocated) break;
                                                  }
                                                  if (relocated) {
                                                      // Now try placing our deficit subject at freed slot
                                                      const teacherFreeHereAfter = teacherSchedule[teacher]?.[day]?.[p] === null || (teacherSchedule[teacher]?.[day]?.[p] && (teacherSchedule[teacher][day][p].className === 'Free' || teacherSchedule[teacher][day][p].subject === 'Free'));
                                                      if (teacherFreeHereAfter) {
                                                          newTimetable[className][day][p] = { subject, teacher };
                                                          teacherSchedule[teacher][day][p] = { className, subject };
                                                          assignmentsPlaced[className][subject] = (assignmentsPlaced[className][subject] || 0) + 1;
                                                          repairedAny = true;
                                                          placedNow = true;
                                                          break;
                                                      }
                                                  }
                                              }
                                          }
                                          if (placedNow) break;
                                      }

                                      if (!placedNow) {
                                          // As a last resort, allow placing even if teacher has a class, only if that other subject is overfilled and can be freed
                                      for (const day of workingDayLabels) {
                                          const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                                          for (let p = 0; p < periodsForDay; p++) {
                                              if (p === lunchBreakPeriod - 1) continue;
                                              const cell = newTimetable[className][day][p];
                                              if (cell && cell.subject !== 'Free') {
                                                  const oldSubject = cell.subject;
                                                  const oldPlaced = assignmentsPlaced[className][oldSubject] || 0;
                                                  const oldRequested = periodsToAssignPerSubject[className][oldSubject] || 0;
                                                  if (oldPlaced > oldRequested) {
                                                      // Replace over-placed subject with our deficit subject, even if teacher is currently busy elsewhere
                                                      newTimetable[className][day][p] = { subject, teacher };
                                                      // Free the old teacher at this slot
                                                      const oldTeacher = cell.teacher;
                                                      if (oldTeacher && teacherSchedule[oldTeacher] && teacherSchedule[oldTeacher][day]) {
                                                          teacherSchedule[oldTeacher][day][p] = { className: 'Free', subject: 'Free' };
                                                      }
                                                      // Mark teacher schedule for new teacher
                                                      teacherSchedule[teacher][day][p] = { className, subject };
                                                      assignmentsPlaced[className][subject] = (assignmentsPlaced[className][subject] || 0) + 1;
                                                      assignmentsPlaced[className][oldSubject] = Math.max(0, oldPlaced - 1);
                                                      repairedAny = true;
                                                      placedNow = true;
                                                      break;
                                                  }
                                              }
                                          }
                                          if (placedNow) break;
                                      }
                                      }
                                  }

                                  repairBudget--;
                                  if (repairBudget <= 0) break;
                              }
                              if (repairBudget <= 0) break;
                          }

                          if (!repairedAny) break; // nothing else to repair

                          // Recompute totalDeficit after a repair sweep
                          totalDeficit = 0;
                          classes.forEach(cls => {
                              const classSubjects = Object.keys(periodsToAssignPerSubject[cls] || {});
                              classSubjects.forEach(subj => {
                                  const requested = periodsToAssignPerSubject[cls][subj] || 0;
                                  const placed = assignmentsPlaced[cls][subj] || 0;
                                  totalDeficit += Math.max(0, requested - placed);
                              });
                          });
                          if (totalDeficit === 0) break;
                      }
                      console.log(' Repair phase completed. Remaining deficit:', totalDeficit);
                  }

                  // Recount free periods after repair
                  let totalFreeCount = 0;
                  classes.forEach(className => {
                      workingDayLabels.forEach(day => {
                          const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                          for (let p = 0; p < periodsForDay; p++) {
                              if (newTimetable[className][day][p].subject === 'Free') {
                                  totalFreeCount++;
                              }
                          }
                      });
                  });
                  // Return the result of this attempt
                  return {
                      newTimetable,
                      teacherSchedule,
                      freeCount: totalFreeCount,
                      deficitCount: totalDeficit,
                      attemptFreeClassReasons
                  };
          };

          const loadScript = (src) => {
            return new Promise((resolve, reject) => {
              const script = document.createElement('script');
              script.src = src;
              script.onload = () => resolve(true);
              script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
              document.head.appendChild(script);
            });
          };

          const loadPdfLibraries = async () => {
            if (window.html2canvas && window.jspdf) {
                 setAreLibrariesLoaded(true);
                 return;
            }
            try {
              await Promise.all([
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'),
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js')
              ]);
              setAreLibrariesLoaded(true);
            } catch (error) {
              console.error('[ERROR] Error loading PDF libraries:', error);
            }
          };

          useEffect(() => {
            loadPdfLibraries();
          }, []);

          const getPeriodCellHtml = (day, periodIndex, lesson, type, currentAbsentTeachers, currentProxyAssignments, currentOriginalTimetable, currentFreeClassReasons) => {
            const cellData = getCellContent(lesson, periodIndex, day, periodsPerDay, halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, currentAbsentTeachers, currentProxyAssignments, currentOriginalTimetable, currentFreeClassReasons);

            let content1, content2;
            
            if (type === 'class') {
                content1 = cellData.subject;
                content2 = !cellData.isBreak && !cellData.isFree && cellData.teacher && cellData.teacher !== 'Event Coordinator' && `(${cellData.teacher})`;
                if (cellData.isProxy) {
                    content2 += `<span class="block text-xs font-bold text-purple-700">Proxy: ${cellData.teacher}</span>`;
                }
            } else { // teacher type
                content1 = cellData.className;
                content2 = !cellData.isBreak && !cellData.isFree && lesson.subject && lesson.subject !== 'Free' && `(${lesson.subject})`;
                if (cellData.isProxy) {
                    content2 += `<span class="block text-xs font-bold text-purple-700">Proxy Assignment</span>`;
                }
            }
            
            return `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="p-2 rounded-md ${cellData.bgClass}">
                        <div class="font-semibold text-sm">${content1}</div>
                        <div class="text-xs">${content2}</div>
                    </div>
                </td>
            `;
          }


          const renderClassTimetableToHtml = (className, timetableData, workingDayLabels, periodsPerDay, currentAbsentTeachers, currentProxyAssignments, currentOriginalTimetable) => {
            const tableHeader = `
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                  ${workingDayLabels.map(day => `
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${day}</th>
                  `).join('')}
                </tr>
              </thead>
            `;

            const tableBody = `
              <tbody class="bg-white divide-y divide-gray-200">
                ${Array.from({ length: periodsPerDay }).map((_, periodIndex) => `
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 text-sm">${periodIndex + 1}</td>
                    ${workingDayLabels.map(day => {
                      const lesson = timetableData[className]?.[day]?.[periodIndex] || { subject: 'Free', teacher: null };
                      const lessonWithClass = { ...lesson, className: className };
                      return getPeriodCellHtml(day, periodIndex, lessonWithClass, 'class', absentTeachers, proxyAssignments, originalTimetable, freeClassReasons);
                    }).join('')}
                  </tr>
                `).join('')}
              </tbody>
            `;

            return `
              <div class="space-y-4 overflow-x-auto p-6 bg-white rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-bold text-blue-800">${className}</h3>
                </div>
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                  ${tableHeader}
                  ${tableBody}
                </table>
              </div>
            `;
          };
          const renderTeacherTimetableToHtml = (teacherName, timetableData, workingDayLabels, periodsPerDay, currentAbsentTeachers, currentProxyAssignments, currentOriginalTimetable) => {
            const tableHeader = `
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                  ${workingDayLabels.map(day => `
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${day}</th>
                  `).join('')}
                </tr>
              </thead>
            `;

            const tableBody = `
              <tbody class="bg-white divide-y divide-gray-200">
                ${Array.from({ length: periodsPerDay }).map((_, periodIndex) => `
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 text-sm">${periodIndex + 1}</td>
                    ${workingDayLabels.map(day => {
                      const lesson = timetableData[teacherName]?.[day]?.[periodIndex] || { className: 'Free' };
                      return getPeriodCellHtml(day, periodIndex, lesson, 'teacher', absentTeachers, proxyAssignments, originalTimetable, null);
                    }).join('')}
                  </tr>
                `).join('')}
              </tbody>
            `;

            return `
              <div class="space-y-4 overflow-x-auto p-6 bg-white rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-bold text-blue-800">${teacherName}</h3>
                </div>
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                  ${tableHeader}
                  ${tableBody}
                </table>
              </div>
            `;
          };

          // Export to CSV format (original verbosity restored)
          const exportToCSV = (entityName, type) => {
            if ((!timetable && type === 'class') || (!teacherTimetable && type === 'teacher')) {
              alert('Timetable not generated.');
              return;
            }

            let csvContent = '';
            const data = type === 'class' ? timetable[entityName] : teacherTimetable[entityName];
            
            if (!data) {
              alert(`No data found for ${entityName}`);
              return;
            }

            // Header row
            csvContent += 'Period,' + workingDayLabels.join(',') + '\n';

            // Data rows
            for (let periodIndex = 0; periodIndex < periodsPerDay; periodIndex++) {
              const row = [`P${periodIndex + 1}`];
              
              workingDayLabels.forEach(day => {
                const lesson = data[day]?.[periodIndex];
                const cellData = getCellContent(lesson || {}, periodIndex, day, periodsPerDay, halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, absentTeachers, proxyAssignments, originalTimetable);
                
                let cellText = '';
                if (type === 'class') {
                  cellText = cellData.subject || 'Free';
                  if (cellData.teacher && !cellData.isBreak && !cellData.isFree) {
                    cellText += ` (${cellData.teacher})`;
                  }
                } else {
                  // Teacher CSV cell: prefer className; if missing but subject exists, derive class from original or current timetable
                  let classText = cellData.className;
                  const hasRealSubject = !!(lesson && lesson.subject && lesson.subject !== 'Free' && !cellData.isBreak && !cellData.isFree);
                  if ((!classText || classText === 'Free') && hasRealSubject) {
                    // Fallback 1: originalTimetable
                    if (originalTimetable) {
                      for (const cls of classes) {
                        const origLesson = originalTimetable[cls]?.[day]?.[periodIndex];
                        if (origLesson && origLesson.teacher === entityName) { classText = cls; break; }
                      }
                    }
                    // Fallback 2: current class timetables
                    if ((!classText || classText === 'Free') && timetable) {
                      for (const cls of classes) {
                        const curLesson = timetable[cls]?.[day]?.[periodIndex];
                        if (curLesson && curLesson.teacher === entityName) { classText = cls; break; }
                      }
                    }
                  }
                  // Finalize text
                  cellText = classText || 'Free';
                  // Only append subject if we resolved a real class (not Free)
                  if (cellText !== 'Free' && hasRealSubject) {
                    cellText += ` (${lesson.subject})`;
                  }
                }
                
                // Escape quotes and commas for CSV
                cellText = cellText.replace(/"/g, '""');
                if (cellText.includes(',') || cellText.includes('"') || cellText.includes('\n')) {
                  cellText = `"${cellText}"`;
                }
                
                row.push(cellText);
              });
              
              csvContent += row.join(',') + '\n';
            }

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${entityName}_timetable.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          // Export to HTML format
          const exportToHTML = (entityName, type) => {
            if ((!timetable && type === 'class') || (!teacherTimetable && type === 'teacher')) {
              alert('Timetable not generated.');
              return;
            }

            let htmlContent = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${entityName} Timetable</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1e40af;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f9fafb;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
        }
        td {
            font-size: 14px;
        }
        .cell-content {
            padding: 8px;
            border-radius: 4px;
        }
        .bg-blue { background-color: #eff6ff; color: #1e40af; }
        .bg-green { background-color: #f0fdf4; color: #166534; }
        .bg-yellow { background-color: #fef9c3; color: #854d0e; font-weight: bold; }
        .bg-red { background-color: #fee2e2; color: #991b1b; font-weight: bold; }
        .bg-purple { background-color: #f3e8ff; color: #6b21a8; font-weight: bold; }
        .bg-gray { background-color: #f3f4f6; color: #6b7280; }
        .subject { font-weight: 600; }
        .teacher { font-size: 12px; margin-top: 4px; }
        @media print {
            body { background-color: white; }
            .container { box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>${entityName} Timetable</h1>
        <table>
            <thead>
                <tr>
                    <th>Period</th>
                    ${workingDayLabels.map(day => `<th>${day}</th>`).join('')}
                </tr>
            </thead>
            <tbody>
`;

            const data = type === 'class' ? timetable[entityName] : teacherTimetable[entityName];
            
            for (let periodIndex = 0; periodIndex < periodsPerDay; periodIndex++) {
              htmlContent += `                <tr>\n                    <td><strong>P${periodIndex + 1}</strong></td>\n`;
              
              workingDayLabels.forEach(day => {
                const lesson = data[day]?.[periodIndex];
                const cellData = getCellContent(lesson || {}, periodIndex, day, periodsPerDay, halfDayPeriods, halfDays, lunchBreakPeriod, breakLabel, absentTeachers, proxyAssignments, originalTimetable);
                
                let bgClass = 'bg-gray';
                if (cellData.bgClass.includes('blue')) bgClass = 'bg-blue';
                else if (cellData.bgClass.includes('green')) bgClass = 'bg-green';
                else if (cellData.bgClass.includes('yellow')) bgClass = 'bg-yellow';
                else if (cellData.bgClass.includes('red')) bgClass = 'bg-red';
                else if (cellData.bgClass.includes('purple')) bgClass = 'bg-purple';
                
                let content1 = '';
                let content2 = '';
                let content3 = '';
                
                if (type === 'class') {
                  if (cellData.isProxy) {
                    // Show proxy information like on the main page
                    content1 = cellData.subject || 'Free';
                    content2 = cellData.originalTeacher ? `(${cellData.originalTeacher})` : '';
                    content3 = cellData.teacher ? `<div class="teacher" style="font-weight: bold; color: #6b21a8;">Proxy: ${cellData.teacher}</div>` : '';
                  } else if (cellData.isAbsent) {
                    // Show absent teacher information
                    content1 = 'ABSENT';
                    content2 = cellData.teacher ? `Teacher: ${cellData.teacher}` : '';
                    content3 = '<div class="teacher">No Proxy Assigned</div>';
                  } else {
                    content1 = cellData.subject || 'Free';
                    if (cellData.teacher && !cellData.isBreak && !cellData.isFree) {
                      content2 = `(${cellData.teacher})`;
                    }
                  }
                } else {
                  // Teacher view
                  if (cellData.isProxy) {
                    // This teacher is assigned as a proxy for another class
                    content1 = cellData.className || 'Proxy Assignment';
                    content2 = cellData.subject && cellData.subject !== 'Free' ? `(${cellData.subject})` : '';
                    content3 = '<div class="teacher" style="font-weight: bold; color: #6b21a8;">Proxy Assignment</div>';
                  } else if (cellData.isAbsent) {
                    // This teacher is absent
                    content1 = 'ABSENT';
                    content2 = cellData.assignedProxy ? `Proxy: ${cellData.assignedProxy}` : 'No Proxy Assigned';
                  } else {
                    // Derive class name if missing in teacher timetable using originalTimetable
                    const derivedClassName = (cellData.className && cellData.className !== 'Free') ? cellData.className : (() => {
                      if (!originalTimetable) return null;
                      for (const cls of Object.keys(originalTimetable)) {
                        const origLesson = originalTimetable[cls]?.[day]?.[periodIndex];
                        if (origLesson && origLesson.teacher === entityName) return cls;
                      }
                      return null;
                    })();
                    content1 = derivedClassName || cellData.className || 'Free';
                    if (lesson?.subject && lesson.subject !== 'Free' && !cellData.isBreak) {
                      content2 = `(${lesson.subject})`;
                    }
                  }
                }
                
                htmlContent += `                    <td><div class="cell-content ${bgClass}"><div class="subject">${content1}</div>${content2 ? `<div class="teacher">${content2}</div>` : ''}${content3 || ''}</div></td>\n`;
              });
              
              htmlContent += `                </tr>\n`;
            }

            htmlContent += `
            </tbody>
        </table>
    </div>
</body>
</html>
`;

            // Create download link
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${entityName}_timetable.html`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          // Improved PDF export with better error handling
          const exportTimetableToPDF = async (entityName, type) => {
            if ((!timetable && type === 'class') || (!teacherTimetable && type === 'teacher')) {
              alert('Timetable not generated.');
              return;
            }

            if (!areLibrariesLoaded) {
              alert('PDF libraries are still loading. Please try CSV or HTML export, or wait a moment and try again.');
              return;
            }

            if (!window.html2canvas || !window.jspdf) {
              alert('PDF export libraries failed to load. Please use CSV or HTML export instead.');
              return;
            }

            setIsExporting(prev => ({
              ...prev,
              [type]: { ...prev[type], [entityName]: true }
            }));

            const { jsPDF } = window.jspdf;

            const container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.left = '-9999px';
            container.style.width = '1200px'; 
            document.body.appendChild(container);

            try {
              const element = document.createElement('div');
              if (type === 'class') {
                element.innerHTML = renderClassTimetableToHtml(entityName, timetable, workingDayLabels, periodsPerDay, absentTeachers, proxyAssignments, originalTimetable);
              } else {
                element.innerHTML = renderTeacherTimetableToHtml(entityName, teacherTimetable, workingDayLabels, periodsPerDay, absentTeachers, proxyAssignments, originalTimetable);
              }
              container.appendChild(element);

              await new Promise(resolve => setTimeout(resolve, 100));

              const canvas = await window.html2canvas(element.firstChild, { 
                scale: 2, 
                useCORS: true, 
                logging: false,
                backgroundColor: '#ffffff'
              });
              const imgData = canvas.toDataURL('image/png');
              
              const pdf = new jsPDF('l', 'mm', 'a4'); 
              const pdfWidth = pdf.internal.pageSize.getWidth();
              const pdfHeight = pdf.internal.pageSize.getHeight();
              
              const imgWidth = pdfWidth - 20;
              const imgHeight = canvas.height * imgWidth / canvas.width;
              let heightLeft = imgHeight;
              let position = 10; 

              pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
              heightLeft -= (pdfHeight - position);
              
              while (heightLeft > 0) {
                position = 10;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 10, -(imgHeight - heightLeft), imgWidth, imgHeight);
                heightLeft -= (pdfHeight - position);
              }
              
              pdf.save(`${entityName}_timetable.pdf`);

              container.removeChild(element);
              alert(`PDF exported successfully: ${entityName}_timetable.pdf`);
            } catch (error) {
              console.error(`[ERROR] Error during PDF export for ${entityName}:`, error);
              alert(`PDF export failed. Error: ${error.message}. Please try CSV or HTML export instead.`);
            } finally {
              setIsExporting(prev => ({
                ...prev,
                [type]: { ...prev[type], [entityName]: false }
              }));
              if (document.body.contains(container)) {
                document.body.removeChild(container);
              }
            }
          };


          // Import/Export Settings Functions (matrix-style CSV)
          const handleExportSettings = () => {
            try {
              const header = ['', 'Teachers','Classes','Subjects','PeriodsPerDay','HalfDayPeriods','WorkingDays','OffDays','HalfDays','LunchBreakPeriod','BreakLabel','EnsureTeacherFreePeriod','ProxyTeachers'];
              const values = ['', teachers.join(';'), classes.join(';'), subjects.join(';'), String(periodsPerDay), String(halfDayPeriods), String(workingDays), offDays.join(';'), halfDays.join(';'), String(lunchBreakPeriod), breakLabel, String(ensureTeacherFreePeriod), proxyTeachers.join(';')];
              downloadCsv('Settings_Matrix.csv', [header, values]);
            } catch (error) {
              console.error('Error exporting settings:', error);
              alert(` Export failed: ${error.message}`);
            }
          };
          
          const handleImportSettings = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const csvText = e.target.result;
                const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
                
                // Helper: split a CSV line on commas not inside quotes, and unquote cells
                const splitCsvLine = (line) => {
                  const parts = line.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/);
                  return parts.map(p => p.replace(/^\"|\"$/g, '').replace(/\"\"/g, '"').trim());
                };
                
                // FAST-PATH: Support direct import of Settings_Matrix.csv exported by handleExportSettings
                // Expected: first row is headers with an initial empty cell, second row are values with an initial empty cell
                if (lines.length >= 2) {
                  const headerCells = splitCsvLine(lines[0]);
                  const valueCells = splitCsvLine(lines[1]);
                  const headerHasMatrix = headerCells.includes('Teachers') && headerCells.includes('Classes') && headerCells.includes('Subjects') && headerCells.includes('PeriodsPerDay');
                  const leadingBlankOk = headerCells[0] === '' && valueCells[0] === '';
                  if (headerHasMatrix && leadingBlankOk) {
                    const idx = (key) => headerCells.indexOf(key);
                    const getStr = (key) => valueCells[idx(key)] || '';
                    const getNum = (key, def = 0) => Math.max(0, parseInt(valueCells[idx(key)]) || def);
                    const getList = (key) => (getStr(key) ? getStr(key).split(';').map(s => s.trim()).filter(Boolean) : []);
                    
                    const newTeachers = getList('Teachers');
                    const newClasses = getList('Classes');
                    const newSubjects = getList('Subjects');
                    const newPeriodsPerDay = getNum('PeriodsPerDay', 6);
                    const newHalfDayPeriods = getNum('HalfDayPeriods', 4);
                    const newWorkingDays = getNum('WorkingDays', 5);
                    const newOffDays = getList('OffDays');
                    const newHalfDays = getList('HalfDays');
                    const newLunchBreakPeriod = getNum('LunchBreakPeriod', 0);
                    const newBreakLabel = getStr('BreakLabel') || 'LUNCH BREAK';
                    const newEnsureTeacherFreePeriod = (getStr('EnsureTeacherFreePeriod') || 'true').toString().toLowerCase() === 'true';
                    const newProxyTeachers = getList('ProxyTeachers');
                    
                    if (newTeachers.length === 0 || newClasses.length === 0 || newSubjects.length === 0) {
                      throw new Error('Invalid Settings_Matrix.csv: missing Teachers, Classes, or Subjects');
                    }
                    
                    const confirmed = confirm(
                      ` This will replace ALL current settings with the imported data.\n\n` +
                      `Imported data contains:\n` +
                      `- ${newTeachers.length} teachers\n` +
                      `- ${newClasses.length} classes\n` +
                      `- ${newSubjects.length} subjects\n\n` +
                      `Do you want to proceed?`
                    );
                    if (!confirmed) { event.target.value = ''; return; }
                    
                    // Apply parsed basic settings; keep advanced maps empty (user can import them from their dedicated CSVs)
                    setTeachers(newTeachers);
                    setClasses(newClasses);
                    setSubjects(newSubjects);
                    setAssignments({});
                    setSubjectPeriodsPerWeek({});
                    setFirstPeriodAssignments({});
                    setEvents([]);
                    setTeacherStartPeriod({});
                    setLastPeriodSubjectRestrictions([]);
                    setProxyTeachers(newProxyTeachers);
                    setPeriodsPerDay(newPeriodsPerDay);
                    setHalfDayPeriods(newHalfDayPeriods);
                    setWorkingDays(newWorkingDays);
                    setOffDays(newOffDays);
                    setHalfDays(newHalfDays);
                    setLunchBreakPeriod(newLunchBreakPeriod);
                    setBreakLabel(newBreakLabel);
                    setEnsureTeacherFreePeriod(newEnsureTeacherFreePeriod);
                    
                    // Reset generated artefacts
                    setTimetable(null);
                    setTeacherTimetable(null);
                    setOriginalTimetable(null);
                    setProxyAssignments({});
                    setAbsentTeachers([]);
                    
                    alert(' Settings imported successfully from Settings_Matrix.csv!');
                    event.target.value = '';
                    return; // Done with matrix import
                  }
                }
                
                // Parse CSV data
                const newTeachers = [];
                const newClasses = [];
                const newSubjects = [];
                const newAssignments = {};
                const newSubjectPeriodsPerWeek = {};
                const newFirstPeriodAssignments = {};
                const newEvents = [];
                const newTeacherStartPeriod = {};
                const newLastPeriodRestrictions = [];
                let newProxyTeachers = [];
                let newPeriodsPerDay = 8;
                let newHalfDayPeriods = 4;
                let newWorkingDays = 5;
                let newOffDays = [];
                let newHalfDays = [];
                let newLunchBreakPeriod = 0;
                let newBreakLabel = 'LUNCH BREAK';
                let newEnsureTeacherFreePeriod = true;
                
                let currentSection = 'basic';
                
                for (let i = 0; i < lines.length; i++) {
                  const line = lines[i];
                  
                  // Detect section headers
                  if (line.includes('Class,Subject,Teacher,PeriodsPerWeek')) {
                    currentSection = 'assignments';
                    continue;
                  } else if (line.includes('Class,Day,FirstPeriodSubject')) {
                    currentSection = 'firstPeriod';
                    continue;
                  } else if (line.includes('EventClass,EventDay')) {
                    currentSection = 'events';
                    continue;
                  } else if (line.includes('Teacher,StartPeriod')) {
                    currentSection = 'teacherStart';
                    continue;
                  } else if (line.includes('RestrictedClass,RestrictedSubject')) {
                    currentSection = 'restrictions';
                    continue;
                  }
                  
                  // Parse based on section
                  if (currentSection === 'basic' && line.includes(',')) {
                    const parts = line.match(/^([^,]+),(.+)$/);
                    if (parts) {
                      const key = parts[1].trim();
                      let value = parts[2].trim().replace(/^"|"$/g, '');
                      
                      if (key === 'Teachers') newTeachers.push(...value.split(';').filter(v => v));
                      else if (key === 'Classes') newClasses.push(...value.split(';').filter(v => v));
                      else if (key === 'Subjects') newSubjects.push(...value.split(';').filter(v => v));
                      else if (key === 'PeriodsPerDay') newPeriodsPerDay = parseInt(value) || 8;
                      else if (key === 'HalfDayPeriods') newHalfDayPeriods = parseInt(value) || 4;
                      else if (key === 'WorkingDays') newWorkingDays = parseInt(value) || 5;
                      else if (key === 'OffDays') newOffDays = value.split(';').filter(v => v);
                      else if (key === 'HalfDays') newHalfDays = value.split(';').filter(v => v);
                      else if (key === 'LunchBreakPeriod') newLunchBreakPeriod = parseInt(value) || 0;
                      else if (key === 'BreakLabel') newBreakLabel = value;
                      else if (key === 'EnsureTeacherFreePeriod') newEnsureTeacherFreePeriod = value === 'true';
                      else if (key === 'ProxyTeachers') newProxyTeachers = value.split(';').filter(v => v);
                    }
                  } else if (currentSection === 'assignments') {
                    const parts = line.split(',');
                    if (parts.length >= 4) {
                      const cls = parts[0].trim();
                      const subject = parts[1].trim();
                      const teacher = parts[2].trim().replace(/^"|"$/g, '');
                      const periods = parseInt(parts[3]) || 0;
                      
                      if (!newAssignments[cls]) newAssignments[cls] = {};
                      if (!newSubjectPeriodsPerWeek[cls]) newSubjectPeriodsPerWeek[cls] = {};
                      newAssignments[cls][subject] = teacher;
                      newSubjectPeriodsPerWeek[cls][subject] = periods;
                    }
                  } else if (currentSection === 'firstPeriod') {
                    const parts = line.split(',');
                    if (parts.length >= 4) {
                      const cls = parts[0].trim();
                      const day = parts[1].trim();
                      const subject = parts[2].trim().replace(/^"|"$/g, '');
                      const teacher = parts[3].trim().replace(/^"|"$/g, '');
                      
                      if (!newFirstPeriodAssignments[cls]) newFirstPeriodAssignments[cls] = {};
                      newFirstPeriodAssignments[cls][day] = { subject, teacher };
                    }
                  } else if (currentSection === 'events') {
                    const parts = line.split(',');
                    if (parts.length >= 4) {
                      newEvents.push({
                        className: parts[0].trim(),
                        day: parts[1].trim(),
                        periodIndex: parseInt(parts[2]) - 1,
                        eventName: parts[3].trim().replace(/^"|"$/g, '')
                      });
                    }
                  } else if (currentSection === 'teacherStart') {
                    const parts = line.split(',');
                    if (parts.length >= 2) {
                      const teacher = parts[0].trim().replace(/^"|"$/g, '');
                      const startPeriod = parseInt(parts[1]) || 1;
                      newTeacherStartPeriod[teacher] = startPeriod;
                    }
                  } else if (currentSection === 'restrictions') {
                    const parts = line.split(',');
                    if (parts.length >= 2) {
                      newLastPeriodRestrictions.push({
                        className: parts[0].trim(),
                        subject: parts[1].trim().replace(/^"|"$/g, '')
                      });
                    }
                  }
                }
                
                // Validate
                if (newTeachers.length === 0 || newClasses.length === 0 || newSubjects.length === 0) {
                  throw new Error('Invalid CSV file - missing required data');
                }
                
                // Confirm
                const confirmed = confirm(
                  ` This will replace ALL current settings with the imported data.\n\n` +
                  `Imported data contains:\n` +
                  `- ${newTeachers.length} teachers\n` +
                  `- ${newClasses.length} classes\n` +
                  `- ${newSubjects.length} subjects\n\n` +
                  `Do you want to proceed?`
                );
                
                if (!confirmed) {
                  event.target.value = '';
                  return;
                }
                
                // Apply all settings
                setTeachers(newTeachers);
                setClasses(newClasses);
                setSubjects(newSubjects);
                setAssignments(newAssignments);
                setSubjectPeriodsPerWeek(newSubjectPeriodsPerWeek);
                setPeriodsPerDay(newPeriodsPerDay);
                setHalfDayPeriods(newHalfDayPeriods);
                setWorkingDays(newWorkingDays);
                setOffDays(newOffDays);
                setHalfDays(newHalfDays);
                setLunchBreakPeriod(newLunchBreakPeriod);
                setBreakLabel(newBreakLabel);
                setEnsureTeacherFreePeriod(newEnsureTeacherFreePeriod);
                setFirstPeriodAssignments(newFirstPeriodAssignments);
                setEvents(newEvents);
                setTeacherStartPeriod(newTeacherStartPeriod);
                setLastPeriodSubjectRestrictions(newLastPeriodRestrictions);
                setProxyTeachers(newProxyTeachers);
                
                // Reset timetable
                setTimetable(null);
                setTeacherTimetable(null);
                setOriginalTimetable(null);
                setProxyAssignments({});
                setAbsentTeachers([]);
                
                alert(' Settings imported successfully from CSV!');
                event.target.value = '';
              } catch (error) {
                console.error('Error importing CSV:', error);
                alert(` Import failed: ${error.message}\n\nPlease make sure you selected a valid CSV settings file.`);
                event.target.value = '';
              }
            };
            reader.readAsText(file);
          };

          // --- CLEAN CSV DOWNLOAD HELPERS AND PER-SECTION EXPORTS ---
          const downloadCsv = (filename, rows) => {
            try {
              const escapeCell = (v) => `"${String(v ?? '').replace(/"/g,'""')}"`;
              const csv = rows.map(r => r.map(escapeCell).join(',')).join('\r\n');
              const bom = '\ufeff';
              const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
              const a = document.createElement('a');
              const url = URL.createObjectURL(blob);
              a.setAttribute('href', url);
              a.setAttribute('download', filename);
              a.style.display = 'none';
              document.body.appendChild(a);
              a.click();
              setTimeout(() => { URL.revokeObjectURL(url); if (document.body.contains(a)) document.body.removeChild(a); }, 0);
            } catch (err) {
              console.error('CSV download failed', err);
              alert('Export failed.');
            }
          };

          const exportSchoolDetailsCSV = () => {
            const header = ['', 'Teachers','Classes','Subjects','PeriodsPerDay','HalfDayPeriods','WorkingDays','OffDays','HalfDays','LunchBreakPeriod','BreakLabel','EnsureTeacherFreePeriod'];
            const values = ['', teachers.join('; '), classes.join('; '), subjects.join('; '), String(periodsPerDay), String(halfDayPeriods), String(workingDays), offDays.join('; '), halfDays.join('; '), String(lunchBreakPeriod), breakLabel, String(ensureTeacherFreePeriod)];
            downloadCsv('School_Details_Matrix.csv', [header, values]);
          };

          const exportAssignmentsCSV = () => {
            // Build header: empty first cell, then 'Class' and subject columns, ending with 'Total'
            const header = ['','Class', ...subjects, 'Total'];
            const rows = [header];
            
            // For each class, output two rows: teacher names and periods per week
            classes.forEach((cls, idx) => {
              // Row 1: index, Class name, teacher for each subject, blank Total (to be computed on next row)
              const teacherRow = [String(idx + 1), cls];
              subjects.forEach(sub => {
                const teacher = assignments?.[cls]?.[sub] || '';
                teacherRow.push(teacher);
              });
              teacherRow.push('');
              rows.push(teacherRow);

              // Row 2: blank first two cells, periods numbers per subject, and Total sum
              const periodsRow = ['', ''];
              let total = 0;
              subjects.forEach(sub => {
                const periods = Math.max(0, parseInt(subjectPeriodsPerWeek?.[cls]?.[sub]) || 0);
                periodsRow.push(String(periods));
                total += periods;
              });
              periodsRow.push(String(total));
              rows.push(periodsRow);
            });

            downloadCsv('Assignments_Matrix.csv', rows);
          };

          const exportConstraintsCSV = () => {
            // Matrix with separate sections as blocks
            const rows = [];
            // First Period Assignments
            rows.push(['','FirstPeriod Assignments']);
            rows.push(['','Class', ...workingDayLabels]);
            classes.forEach(cls => {
              const line = ['', cls];
              workingDayLabels.forEach(day => {
                const fp = firstPeriodAssignments?.[cls]?.[day];
                const cell = fp && (fp.subject || fp.teacher) ? `${fp.subject || ''}${fp.teacher ? ` (${fp.teacher})` : ''}` : '';
                line.push(cell);
              });
              rows.push(line);
            });

            // Last Period Restrictions
            rows.push([]);
            rows.push(['','LastPeriod Restrictions']);
            rows.push(['','Class','Subject']);
            (lastPeriodSubjectRestrictions||[]).forEach(r => {
              rows.push(['', r.className, r.subject]);
            });

            // Events
            rows.push([]);
            rows.push(['','Events']);
            rows.push(['','Class','Day','Period','Name']);
            (events||[]).forEach(ev => {
              const p = (typeof ev.period === 'number') ? ev.period : ((typeof ev.periodIndex === 'number') ? (ev.periodIndex + 1) : '');
              const name = ev.label || ev.eventName || 'Event';
              rows.push(['', ev.className, ev.day, `P${p}`, name]);
            });

            downloadCsv('Constraints_Matrix.csv', rows);
          };

          // --- IMPORTS matching the component's export formats ---
          const importSchoolDetailsCSV = (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
              try {
                const textRaw = String(ev.target.result || '');
                const text = textRaw.replace(/^\ufeff/, '');
                const lines = text.split(/\r?\n/).map(l => l.trim());
                const nonEmpty = lines.filter(Boolean);

                // Case 1: Our Settings_Matrix.csv (two rows, first may start with an empty cell)
                const header = nonEmpty[0] || '';
                const headerCells = header.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(s => s.replace(/^\"|\"$/g, ''));
                const isMatrix = headerCells.includes('Teachers') && headerCells.includes('Classes') && headerCells.includes('Subjects');
                if (isMatrix && nonEmpty[1]) {
                  const vals = nonEmpty[1].split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(s => s.replace(/^\"|\"$/g, ''));
                  const idx = (k) => headerCells.indexOf(k);
                  const getStr = (k) => (idx(k) >= 0 ? vals[idx(k)] : '') || '';
                  const getNum = (k, d=0) => Math.max(0, parseInt(getStr(k)) || d);
                  const getList = (k) => (getStr(k) ? getStr(k).split(';').map(s=>s.trim()).filter(Boolean) : []);

                  setTeachers(getList('Teachers'));
                  setClasses(getList('Classes'));
                  setSubjects(getList('Subjects'));
                  setPeriodsPerDay(getNum('PeriodsPerDay', periodsPerDay));
                  setHalfDayPeriods(getNum('HalfDayPeriods', halfDayPeriods));
                  setWorkingDays(getNum('WorkingDays', workingDays));
                  setOffDays(getList('OffDays'));
                  setHalfDays(getList('HalfDays'));
                  setLunchBreakPeriod(getNum('LunchBreakPeriod', lunchBreakPeriod));
                  setBreakLabel(getStr('BreakLabel') || breakLabel);
                  setEnsureTeacherFreePeriod((getStr('EnsureTeacherFreePeriod') || String(ensureTeacherFreePeriod)).toLowerCase()==='true');
                  const proxyList = headerCells.includes('ProxyTeachers') ? getList('ProxyTeachers') : proxyTeachers;
                  setProxyTeachers(proxyList);

                  alert('School details imported');
                } else {
                  // Case 2: key,value CSV (Setting,Value)
                  const start = nonEmpty[0] && /setting\s*,\s*value/i.test(nonEmpty[0]) ? 1 : 0;
                  const map = {};
                  nonEmpty.slice(start).forEach(line => {
                    const m = line.match(/^([^,]+),(.+)$/);
                    if (!m) return;
                    const key = m[1].trim();
                    const val = m[2].trim().replace(/^\"|\"$/g, '');
                    map[key] = val;
                  });
                  if (map.Teachers) setTeachers(map.Teachers.split(';').filter(Boolean));
                  if (map.Classes) setClasses(map.Classes.split(';').filter(Boolean));
                  if (map.Subjects) setSubjects(map.Subjects.split(';').filter(Boolean));
                  if (map.PeriodsPerDay) setPeriodsPerDay(Math.max(1, parseInt(map.PeriodsPerDay)||1));
                  if (map.HalfDayPeriods) setHalfDayPeriods(Math.max(0, parseInt(map.HalfDayPeriods)||0));
                  if (map.WorkingDays) setWorkingDays(Math.max(1, Math.min(7, parseInt(map.WorkingDays)||1)));
                  if (map.OffDays) setOffDays(map.OffDays.split(';').filter(Boolean));
                  if (map.HalfDays) setHalfDays(map.HalfDays.split(';').filter(Boolean));
                  if (map.LunchBreakPeriod!==undefined) setLunchBreakPeriod(Math.max(0, parseInt(map.LunchBreakPeriod)||0));
                  if (map.BreakLabel!==undefined) setBreakLabel(map.BreakLabel);
                  if (map.EnsureTeacherFreePeriod!==undefined) setEnsureTeacherFreePeriod(String(map.EnsureTeacherFreePeriod).toLowerCase()==='true');
                  alert('School details imported');
                }
              } catch(err) {
                alert('Failed to import School Details CSV');
              } finally { e.target.value = ''; }
            };
            reader.readAsText(file);
          };

          const importAssignmentsCSV = (e) => {
            const file = e.target.files?.[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
              try {
                const textRaw = String(ev.target.result||'');
                const text = textRaw.replace(/^\ufeff/, '');
                const lines = text.split(/\r?\n/).map(l=>l.trim());
                const nonEmpty = lines.filter(Boolean);

                const newAssignments = {};
                const newPeriods = {};

                // Matrix header: [,Class, ...subjects, Total]
                const header = nonEmpty[0] || '';
                const headerParts = header.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(s => s.replace(/^\"|\"$/g,''));
                const isMatrix = headerParts.length >= 3 && headerParts[1] === 'Class';
                if (isMatrix) {
                  const subjectsFromHeader = headerParts.slice(2, -1);
                  for (let i = 1; i < nonEmpty.length; i += 2) {
                    const teacherRow = (nonEmpty[i] || '').split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(s => s.replace(/^\"|\"$/g,''));
                    const periodsRow = (nonEmpty[i+1] || '').split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(s => s.replace(/^\"|\"$/g,''));
                    if (teacherRow.length < 2) continue;
                    const cls = teacherRow[1]; if (!cls) continue;
                    if (!newAssignments[cls]) newAssignments[cls] = {};
                    if (!newPeriods[cls]) newPeriods[cls] = {};
                    subjectsFromHeader.forEach((sub, idx) => {
                      const teacher = teacherRow[2 + idx] || '';
                      const periods = Math.max(0, parseInt(periodsRow[2 + idx])||0);
                      if (sub) { newAssignments[cls][sub] = teacher; newPeriods[cls][sub] = periods; }
                    });
                  }
                } else {
                  // Legacy: Class,Subject,Teacher,PeriodsPerWeek
                  if (!header.toLowerCase().includes('class,subject,teacher')) throw new Error('Invalid header');
                  nonEmpty.slice(1).forEach(line => {
                    const parts = line.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/);
                    if (parts.length < 4) return;
                    const cls = parts[0].trim();
                    const sub = parts[1].trim();
                    const teacher = parts[2].trim().replace(/^\"|\"$/g,'');
                    const periods = Math.max(0, parseInt(parts[3])||0);
                    if (!newAssignments[cls]) newAssignments[cls] = {};
                    if (!newPeriods[cls]) newPeriods[cls] = {};
                    newAssignments[cls][sub] = teacher;
                    newPeriods[cls][sub] = periods;
                  });
                }

                setAssignments(newAssignments);
                setSubjectPeriodsPerWeek(newPeriods);
                alert('Assignments imported');
              } catch(err) { alert('Failed to import Assignments CSV'); } finally { e.target.value=''; }
            };
            reader.readAsText(file);
          };

          const importConstraintsCSV = (e) => {
            const file = e.target.files?.[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
              try {
                const textRaw = String(ev.target.result||'');
                const text = textRaw.replace(/^\ufeff/, '');
                const lines = text.split(/\r?\n/).map(l=>l.trim());
                const nonEmpty = lines.filter(l=>l.length>0);

                const fpNew = {};
                const restrNew = [];
                const eventsNew = [];

                let i = 0;
                // FirstPeriod Assignments block
                if (/^,?FirstPeriod Assignments/i.test(nonEmpty[i]||'')) {
                  i += 1; // skip title
                  const header = (nonEmpty[i++]||'').split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(s=>s.replace(/^\"|\"$/g,''));
                  const days = header.slice(2);
                  while (i < nonEmpty.length && nonEmpty[i] && !/^,?LastPeriod Restrictions/i.test(nonEmpty[i])) {
                    const parts = nonEmpty[i++].split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(s=>s.replace(/^\"|\"$/g,''));
                    const cls = parts[1];
                    days.forEach((day, idx) => {
                      const cell = parts[2+idx]||'';
                      const m = cell.match(/^(.*?)\s*\((.*?)\)$/);
                      const subject = m ? m[1] : (cell||'');
                      const teacher = m ? m[2] : '';
                      if (subject || teacher) {
                        if (!fpNew[cls]) fpNew[cls] = {};
                        fpNew[cls][day] = { subject, teacher };
                      }
                    });
                  }
                }

                // LastPeriod Restrictions
                while (i < nonEmpty.length && nonEmpty[i] === '') i++;
                if (/^,?LastPeriod Restrictions/i.test(nonEmpty[i]||'')) {
                  i += 2; // skip title + header
                  while (i < nonEmpty.length && nonEmpty[i] && !/^,?Events/i.test(nonEmpty[i])) {
                    const parts = nonEmpty[i++].split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(s=>s.replace(/^\"|\"$/g,''));
                    if (parts.length >= 3) restrNew.push({ className: parts[1], subject: parts[2] });
                  }
                }

                // Events
                while (i < nonEmpty.length && nonEmpty[i] === '') i++;
                if (/^,?Events/i.test(nonEmpty[i]||'')) {
                  i += 2; // skip title + header
                  while (i < nonEmpty.length && nonEmpty[i]) {
                    const parts = nonEmpty[i++].split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(s=>s.replace(/^\"|\"$/g,''));
                    if (parts.length >= 5) {
                      const p = parseInt((parts[3]||'').replace(/^P/,''))||0;
                      eventsNew.push({ className: parts[1], day: parts[2], period: p, label: parts[4]||'Event' });
                    } else break;
                  }
                }

                setFirstPeriodAssignments(fpNew);
                setLastPeriodSubjectRestrictions(restrNew);
                setEvents(eventsNew);
                alert('Constraints imported');
              } catch(err) { alert('Failed to import Constraints CSV'); } finally { e.target.value=''; }
            };
            reader.readAsText(file);
          };

          const handleExportAll = async () => {
            if (!timetable && !teacherTimetable || !areLibrariesLoaded) {
              console.log('Timetable not generated or libraries not loaded.');
              return;
            }
            setIsExportingAll(true);

            if (currentView === 'class') {
              for (const cls of classes) {
                await exportTimetableToPDF(cls, 'class');
              }
            } else if (currentView === 'teacher') {
              for (const teacher of teachers) {
                await exportTimetableToPDF(teacher, 'teacher');
              }
            }
            setIsExportingAll(false);
          };

          const handleExportAllCSV = () => {
            if (!timetable && !teacherTimetable) {
              alert('Timetable not generated.');
              return;
            }

            if (currentView === 'class') {
              classes.forEach(cls => {
                exportToCSV(cls, 'class');
              });
            } else if (currentView === 'teacher') {
              teachers.forEach(teacher => {
                exportToCSV(teacher, 'teacher');
              });
            }
            alert('All CSV files exported successfully!');
          };

          const handleExportAllHTML = () => {
            if (!timetable && !teacherTimetable) {
              alert('Timetable not generated.');
              return;
            }

            if (currentView === 'class') {
              classes.forEach(cls => {
                exportToHTML(cls, 'class');
              });
            } else if (currentView === 'teacher') {
              teachers.forEach(teacher => {
                exportToHTML(teacher, 'teacher');
              });
            }
            alert('All HTML files exported successfully!');
          };

          const periodOptions = Array.from({ length: periodsPerDay }).map((_, i) => ({ value: i + 1, label: `Period ${i + 1}` }));

          // Export functions for consolidated views
          const [consolidatedExporting, setConsolidatedExporting] = useState({
            allClasses: false,
            allTeachers: false,
            proxyManagement: false
          });

          const exportConsolidatedViewToPDF = async (viewId, viewName, stateKey) => {
            if (!areLibrariesLoaded) {
              alert('PDF libraries are still loading. Please wait and try again.');
              return;
            }

            const elementId = viewId;
            const element = document.getElementById(elementId);
            if (!element) {
              alert(`Could not find view to export: ${viewName}`);
              console.error(`Element with ID '${elementId}' not found`);
              return;
            }

            setConsolidatedExporting(prev => ({ ...prev, [stateKey]: true }));

            try {
              const canvas = await html2canvas(element, {
                scale: 2,
                logging: false,
                useCORS: true,
                backgroundColor: '#ffffff'
              });

              const imgData = canvas.toDataURL('image/png');
              const pdf = new window.jspdf.jsPDF({
                orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                unit: 'mm',
                format: 'a4'
              });

              const imgWidth = pdf.internal.pageSize.getWidth() - 20;
              const imgHeight = (canvas.height * imgWidth) / canvas.width;

              pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
              pdf.save(`${viewName.replace(/\s+/g, '_')}_timetable.pdf`);

              alert(`PDF exported successfully: ${viewName}_timetable.pdf`);
            } catch (error) {
              console.error(`[ERROR] Error during PDF export for ${viewName}:`, error);
              alert(`PDF export failed. Error: ${error.message}`);
            } finally {
              setConsolidatedExporting(prev => ({ ...prev, [stateKey]: false }));
            }
          };
          const exportConsolidatedViewToCSV = (viewName, data) => {
            let csvContent = '';
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

            if (viewName === 'allClasses') {
              // Export all classes in one CSV
              csvContent += 'Class,' + workingDayLabels.flatMap(day => 
                Array.from({ length: periodsPerDay }, (_, i) => `${day} P${i + 1}`)
              ).join(',') + '\n';

              classes.forEach(cls => {
                const row = [cls];
                workingDayLabels.forEach(day => {
                  const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                  for (let p = 0; p < periodsPerDay; p++) {
                    if (p < periodsForDay) {
                      const lesson = timetable[cls]?.[day]?.[p];
                      const cellText = lesson?.subject || 'Free';
                      row.push(cellText.replace(/"/g, '""'));
                    } else {
                      row.push('');
                    }
                  }
                });
                csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
              });
            } else if (viewName === 'allTeachers') {
              // Export all teachers in one CSV
              csvContent += 'Teacher,' + workingDayLabels.flatMap(day => 
                Array.from({ length: periodsPerDay }, (_, i) => `${day} P${i + 1}`)
              ).join(',') + '\n';

              teachers.forEach(teacher => {
                const row = [teacher];
                workingDayLabels.forEach(day => {
                  const periodsForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                  for (let p = 0; p < periodsPerDay; p++) {
                    if (p < periodsForDay) {
                      const lesson = teacherTimetable[teacher]?.[day]?.[p];
                      let cellText = lesson?.className || '';
                      if (!cellText || cellText === 'Free') {
                        // Fallback: derive class from originalTimetable if teacher is teaching there
                        if (originalTimetable) {
                          for (const cls of classes) {
                            const origLesson = originalTimetable[cls]?.[day]?.[p];
                            if (origLesson && origLesson.teacher === teacher) { cellText = cls; break; }
                          }
                        }
                      }
                      if (!cellText) cellText = 'Free';
                      row.push(cellText.replace(/"/g, '""'));
                    } else {
                      row.push('');
                    }
                  }
                });
                csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
              });
            } else if (viewName === 'proxyManagement') {
              // Export proxy management
              csvContent += 'Class,Day,Period,Original Teacher,Subject,Proxy Teacher\n';
              
              Object.keys(proxyAssignments).forEach(key => {
                const [cls, day, periodIndex] = key.split('-');
                const proxyTeacher = proxyAssignments[key];
                const originalLesson = originalTimetable[cls]?.[day]?.[parseInt(periodIndex)];
                const originalTeacher = originalLesson?.teacher || 'N/A';
                const subject = originalLesson?.subject || 'N/A';
                
                csvContent += `"${cls}","${day}","P${parseInt(periodIndex) + 1}","${originalTeacher}","${subject}","${proxyTeacher}"\n`;
              });
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${viewName}_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('CSV exported successfully!');
          };

          const exportConsolidatedViewToHTML = (viewName, elementId) => {
            const element = document.getElementById(elementId);
            if (!element) {
              console.error(`Could not find element with ID: ${elementId}`);
              alert(`Could not find view to export: ${viewName}. Element ID: ${elementId} not found.`);
              return;
            }

            try {
              const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
              
              // Clone the element to avoid modifying the original
              const clonedElement = element.cloneNode(true);
              
              const htmlContent = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>' + viewName + ' Timetable</title><script src="https://cdn.tailwindcss.com"><' + '/script><style>body { font-family: \'Inter\', sans-serif; } @media print { @page { margin: 1cm; } } table { page-break-inside: auto; } tr { page-break-inside: avoid; page-break-after: auto; }</style></head><body class="bg-gray-50 p-4"><div class="max-w-full mx-auto"><h1 class="text-3xl font-bold text-center mb-6">' + viewName + ' Timetable</h1>' + clonedElement.outerHTML + '</div></body></html>';

              const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
              const link = document.createElement('a');
              const url = URL.createObjectURL(blob);
              link.setAttribute('href', url);
              link.setAttribute('download', `${viewName}_${timestamp}.html`);
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              
              alert('HTML exported successfully! Check your downloads folder.');
            } catch (error) {
              console.error('Error exporting HTML:', error);
              alert(`HTML export failed: ${error.message}`);
            }
          };

          // Export Everything into one CSV file, with clear vertical sections
          const exportEverythingCSV = () => {
            const rows = [];
            const add = (arr) => { rows.push(...arr); };
            const blank = () => rows.push([]);

            // 1) Settings Matrix (two-row form for easy round-trip)
            add([["", 'Teachers','Classes','Subjects','PeriodsPerDay','HalfDayPeriods','WorkingDays','OffDays','HalfDays','LunchBreakPeriod','BreakLabel','EnsureTeacherFreePeriod','ProxyTeachers']]);
            add([["",
              (teachers||[]).join(';'),
              (classes||[]).join(';'),
              (subjects||[]).join(';'),
              String(periodsPerDay),
              String(halfDayPeriods),
              String(workingDays),
              (offDays||[]).join(';'),
              (halfDays||[]).join(';'),
              String(lunchBreakPeriod),
              breakLabel,
              String(ensureTeacherFreePeriod),
              (proxyTeachers||[]).join(';')
            ]]);

            blank();

            // 2) Teachers (vertical list)
            add([["Teachers"],["Name"]]);
            (teachers||[]).forEach(t => add([[t]]));

            blank();

            // 3) Classes (vertical list)
            add([["Classes"],["Name"]]);
            (classes||[]).forEach(c => add([[c]]));

            blank();

            // 4) Subjects (vertical list)
            add([["Subjects"],["Name"]]);
            (subjects||[]).forEach(s => add([[s]]));

            blank();

            // 5) Assignments Matrix (teacher per subject and periods per subject)
            add([["Assignments"],
                 ["", 'Class', ...(subjects||[]), 'Total']]);
            (classes||[]).forEach((cls, idx) => {
              const teacherRow = [String(idx+1), cls, ...subjects.map(sub => (assignments?.[cls]?.[sub] || '')), ''];
              rows.push(teacherRow);
              let total = 0;
              const periodsRow = ['', ''];
              subjects.forEach(sub => {
                const p = Math.max(0, parseInt(subjectPeriodsPerWeek?.[cls]?.[sub]) || 0);
                periodsRow.push(String(p));
                total += p;
              });
              periodsRow.push(String(total));
              rows.push(periodsRow);
            });

            blank();

            // 6) Teacher Start Periods
            add([["TeacherStart"],["Teacher","StartPeriod"]]);
            (teachers||[]).forEach(t => add([[t, String(teacherStartPeriod?.[t] || 1)]]));

            blank();

            // 7) First Period Assignments (matrix per class x days)
            add([["FirstPeriod Assignments"],
                 ["", 'Class', ...(workingDayLabels||[])]]);
            (classes||[]).forEach(cls => {
              const line = ['', cls, ...workingDayLabels.map(day => {
                const fp = firstPeriodAssignments?.[cls]?.[day];
                return fp && (fp.subject || fp.teacher) ? `${fp.subject || ''}${fp.teacher ? ` (${fp.teacher})` : ''}` : '';
              })];
              rows.push(line);
            });

            blank();

            // 8) Last Period Restrictions
            add([["LastPeriod Restrictions"],["", 'Class','Subject']]);
            (lastPeriodSubjectRestrictions||[]).forEach(r => add([["", r.className, r.subject]]));

            blank();

            // 9) Events
            add([["Events"],["", 'Class','Day','Period','Name']]);
            (events||[]).forEach(ev => {
              const p = (typeof ev.period === 'number') ? ev.period : (typeof ev.periodIndex === 'number' ? ev.periodIndex + 1 : '');
              add([["", ev.className, ev.day, `P${p}`, ev.label || ev.eventName || 'Event']]);
            });

            // Serialize to CSV
            const escapeCell = (v) => `"${String(v ?? '').replace(/\"/g,'""')}"`;
            const csv = rows.map(r => (r||[]).map(escapeCell).join(',')).join('\r\n');
            const bom = '\ufeff';
            const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'everything_export.csv';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            alert('Everything exported to one CSV');
          };

          return (
            <div className={`${useAltTheme ? 'alt-theme' : ''} min-h-screen bg-gray-50 p-4 font-sans text-gray-800`}>
              <div className="max-w-7xl mx-auto space-y-8">
                <h1 className="text-3xl sm:text-4xl font-extrabold text-center text-gray-900 leading-tight">Timetable Maker</h1>
                <p className="text-center text-base sm:text-lg text-gray-600 max-w-2xl mx-auto">
                  Set up your teachers, classes, and subjects, then assign teachers and advanced constraints to generate a conflict-free timetable.
                </p>

                {/* Excel-like Ribbon */}
                <div className="bg-white border border-gray-200 rounded-lg shadow-sm mt-4">
                  <div className="flex flex-wrap items-center gap-3 px-4 py-3">
                    {/* Home section */}
                    <div className="flex items-center gap-2">
                      <span className="text-sm font-bold text-gray-700">Home</span>
                      <Button variant="secondary" onClick={() => setShowSettings(!showSettings)} className="text-xs px-2 py-1">
                        {showSettings ? 'Hide Settings' : 'Show Settings'}
                      </Button>
                      <Button onClick={() => generateTimetable(true)} className="text-xs px-2 py-1">Generate (Double)</Button>
                      <Button onClick={() => generateTimetable(false)} className="text-xs px-2 py-1">Generate (No Double)</Button>
                    </div>

                    <div className="hidden sm:block h-6 w-px bg-gray-200" />

                    {/* Data section */}
                    <div className="flex items-center gap-2">
                      <span className="text-sm font-bold text-gray-700">Data</span>
                      <Button variant="secondary" onClick={() => exportSchoolDetailsCSV()} className="text-xs px-2 py-1">Export School</Button>
                      <Button variant="secondary" onClick={() => document.getElementById('import-school-details-input').click()} className="text-xs px-2 py-1">Import School</Button>
                      <Button variant="secondary" onClick={handleExportAllCSV} className="text-xs px-2 py-1">Export All CSV</Button>
                    </div>

                    <div className="hidden sm:block h-6 w-px bg-gray-200" />

                    {/* View section */}
                    <div className="flex items-center gap-2">
                      <span className="text-sm font-bold text-gray-700">View</span>
                      <Button variant="secondary" onClick={() => setUseAltTheme(!useAltTheme)} className="text-xs px-2 py-1">{useAltTheme ? 'Default Theme' : 'Alt Theme'}</Button>
                      <Button variant="secondary" onClick={() => setCurrentView('analytics')} className="text-xs px-2 py-1">Analytics</Button>
                    </div>

                    <div className="hidden sm:block h-6 w-px bg-gray-200" />

                    {/* Find section */}
                    <div className="flex items-center gap-2 flex-1 min-w-[240px]">
                      <span className="text-sm font-bold text-gray-700">Find</span>
                      {/* Teacher filter and select */}
                      <Input
                        value={teacherSearchQuery}
                        onChange={(e) => setTeacherSearchQuery(e.target.value)}
                        placeholder="Filter teachers..."
                        className="max-w-xs"
                      />
                      <Select
                        value={searchTeacherName}
                        onChange={handleSearchTeacher}
                        options={[
                          { value: '', label: 'Search Teacher...' },
                          { value: '__ALL__', label: 'Show all teachers' },
                          ...teachers
                            .filter(t => t.toLowerCase().includes((teacherSearchQuery||'').toLowerCase()))
                            .map(t => ({ value: t, label: t }))
                        ]}
                        className="max-w-xs"
                      />
                      {/* Class filter and select */}
                      <Input
                        value={classSearchQuery}
                        onChange={(e) => setClassSearchQuery(e.target.value)}
                        placeholder="Filter classes..."
                        className="max-w-xs"
                      />
                      <Select
                        value={searchClassName}
                        onChange={handleSearchClass}
                        options={[
                          { value: '', label: 'Search Grade/Class...' },
                          { value: '__ALL__', label: 'Show all classes' },
                          ...classes
                            .filter(c => c.toLowerCase().includes((classSearchQuery||'').toLowerCase()))
                            .map(c => ({ value: c, label: c }))
                        ]}
                        className="max-w-xs"
                      />
                    </div>
                  </div>
                </div>
                <button
                  className="fixed bottom-6 right-6 z-40 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg px-5 py-3 font-bold"
                  onClick={() => setIsManualOpen(true)}
                  title="Manual Placement"
                >
                  Manual Place
                </button>

                {/* Settings and Assignments */}
                <div className="space-y-6">
                  {/* Toggle Settings Button + Import/Export */}
                  <div className="flex flex-col sm:flex-row justify-end items-center gap-3">
                    <Button variant="secondary" onClick={() => setShowSettings(!showSettings)} className="flex items-center space-x-2">
                      {showSettings ? <ToggleLeftIcon /> : <ToggleRightIcon />}
                      <span>{showSettings ? 'Hide Settings' : 'Show Settings'}</span>
                    </Button>
                  </div>

                  {showSettings && (
                    <div className="space-y-4">
                      <div className="sticky top-16 z-30 bg-white/80 backdrop-blur border-b">
                        <div className="flex flex-wrap gap-2 p-2">
                          <Button variant={settingsTab==='general' ? 'primary' : 'outline'} onClick={() => setSettingsTab('general')}>General</Button>
                          <Button variant={settingsTab==='assignments' ? 'primary' : 'outline'} onClick={() => setSettingsTab('assignments')}>Assignments</Button>
                          <Button variant={settingsTab==='constraints' ? 'primary' : 'outline'} onClick={() => setSettingsTab('constraints')}>Constraints</Button>
                        </div>
                      </div>
                      {/* Settings Card 1: School Details */}
                      {settingsTab === 'general' && (
                      <Card className="space-y-6">
                        <h2 className="text-xl sm:text-2xl font-bold text-blue-800">School Details</h2>
                        {/* Import/Export for School Details */}
                        <div className="flex flex-wrap gap-2">
                          <Button
                            variant="secondary"
                            onClick={() => exportSchoolDetailsCSV()}
                            className="text-xs px-3 py-2"
                          >
                            Export School Details (CSV)
                          </Button>
                          <div>
                            <Button
                              variant="secondary"
                              onClick={() => document.getElementById('import-school-details-input').click()}
                              className="text-xs px-3 py-2"
                            >
                              Import School Details (CSV)
                            </Button>
                            <input id="import-school-details-input" type="file" accept=".csv" className="hidden" onChange={(e) => importSchoolDetailsCSV(e)} />
                          </div>
                        </div>
                        {/* Teachers */}
                        <div>
                          <h3 className="font-semibold text-lg">Teachers</h3>
                          <div className="space-y-2">
                            <Input
                              placeholder="Add new teacher"
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') {
                                  addItem(e.target.value, teachers, setTeachers, 'teacher');
                                  e.target.value = '';
                                }
                              }}
                            />
                            <div className="flex flex-wrap gap-2 pt-2">
                              {teachers.map(teacher => (
                                <span key={teacher} className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full flex items-center space-x-1 text-sm">
                                  <span>{teacher}</span>
                                  <button onClick={() => removeItem(teacher, setTeachers, 'teacher')} className="text-blue-500 hover:text-blue-700 font-bold ml-1">
                                    &times;
                                  </button>
                                </span>
                              ))}
                            </div>
                          </div>
                        </div>

                        {/* Classes */}
                        <div>
                          <h3 className="font-semibold text-lg">Classes</h3>
                          <div className="space-y-2">
                            <Input
                              placeholder="Add new class"
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') {
                                  addItem(e.target.value, classes, setClasses, 'class');
                                  e.target.value = '';
                                }
                              }}
                            />
                            <div className="flex flex-wrap gap-2 pt-2">
                              {classes.map(cls => (
                                <span key={cls} className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full flex items-center space-x-1 text-sm">
                                  <span>{cls}</span>
                                  <button onClick={() => removeItem(cls, setClasses, 'class')} className="text-blue-500 hover:text-blue-700 font-bold ml-1">
                                    &times;
                                  </button>
                                </span>
                              ))}
                            </div>
                          </div>
                        </div>

                        {/* Subjects */}
                        <div>
                          <h3 className="font-semibold text-lg">Subjects</h3>
                          <div className="space-y-2">
                            <Input
                              placeholder="Add new subject"
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') {
                                  addItem(e.target.value, subjects, setSubjects, 'subject');
                                  e.target.value = '';
                                }
                              }}
                            />
                            <div className="flex flex-wrap gap-2 pt-2">
                              {subjects.map(subject => (
                                <span key={subject} className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full flex items-center space-x-1 text-sm">
                                  <span>{subject}</span>
                                  <button onClick={() => removeItem(subject, setSubjects, 'subject')} className="text-blue-500 hover:text-blue-700 font-bold ml-1">
                                    &times;
                                  </button>
                                </span>
                              ))}
                            </div>
                          </div>
                        </div>
                        
                        {/* Periods and Days */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          <div>
                            <label className="font-semibold text-sm">Periods per Day (Full Day)</label>
                            <Input
                              type="number"
                              value={periodsPerDay}
                              onChange={(e) => setPeriodsPerDay(Math.max(1, parseInt(e.target.value) || 1))}
                              min="1"
                            />
                          </div>
                          <div>
                            <label className="font-semibold text-sm">Working Days</label>
                            <Input
                              type="number"
                              value={workingDays}
                              onChange={(e) => setWorkingDays(Math.max(1, Math.min(7, parseInt(e.target.value) || 1)))}
                              min="1"
                              max="7"
                            />
                          </div>
                        </div>

                        {/* Half-Day Periods */}
                        <div>
                            <label className="font-semibold text-sm">Periods on a Half-Day</label>
                            <Input
                              type="number"
                              value={halfDayPeriods}
                              onChange={(e) => setHalfDayPeriods(Math.max(1, Math.min(periodsPerDay - 1, parseInt(e.target.value) || 1)))}
                              min="1"
                              max={periodsPerDay - 1}
                            />
                            <p className="text-xs text-gray-500 mt-1">Must be less than the regular Periods per Day ({periodsPerDay}).</p>
                        </div>
                        
                        {/* Half Days Selection */}
                        <div>
                          <h3 className="font-semibold text-lg">Half Days</h3>
                          <div className="flex flex-wrap gap-2 mt-2">
                            {workingDayLabels.map(day => (
                              <div key={day} className="flex items-center space-x-2">
                                <input
                                  type="checkbox"
                                  id={`half-day-${day}`}
                                  checked={halfDays.includes(day)}
                                  onChange={(e) => {
                                    if (e.target.checked) {
                                      setHalfDays([...halfDays, day]);
                                    } else {
                                      setHalfDays(halfDays.filter(d => d !== day));
                                    }
                                  }}
                                  className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                  disabled={offDays.includes(day)}
                                />
                                <label htmlFor={`half-day-${day}`} className={`text-sm font-medium ${offDays.includes(day) ? 'text-gray-400 line-through' : ''}`}>
                                  {day}
                                </label>
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Break Settings */}
                        <h2 className="text-xl sm:text-2xl font-bold text-blue-800">Break Settings</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="font-semibold text-sm">Break Period Number</label>
                                <Input
                                type="number"
                                value={lunchBreakPeriod}
                                onChange={(e) => setLunchBreakPeriod(Math.max(0, Math.min(periodsPerDay, parseInt(e.target.value) || 0)))}
                                min="0"
                                max={periodsPerDay}
                                />
                                <p className="text-xs text-gray-500 mt-1">Set to 0 to disable break. Break occurs at the start of this period number.</p>
                            </div>
                            <div>
                                <label className="font-semibold text-sm">Break Label</label>
                                <Input
                                type="text"
                                value={breakLabel}
                                onChange={(e) => setBreakLabel(e.target.value)}
                                placeholder="LUNCH BREAK"
                                />
                            </div>
                        </div>

                        {/* Teacher Free Period Option */}
                        <h2 className="text-xl sm:text-2xl font-bold text-blue-800">Teacher Scheduling Options</h2>
                        <div className="space-y-4">
                            <div className="flex items-center space-x-3 bg-green-50 p-4 rounded-lg border border-green-200">
                                <input
                                  type="checkbox"
                                  id="ensure-teacher-free-period"
                                  checked={ensureTeacherFreePeriod}
                                  onChange={(e) => setEnsureTeacherFreePeriod(e.target.checked)}
                                  className="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 cursor-pointer"
                                />
                                <label htmlFor="ensure-teacher-free-period" className="text-sm font-medium text-gray-900 cursor-pointer flex-1">
                                  <span className="font-bold">Ensure Every Teacher Has At Least One Free Period</span>
                                  <p className="text-xs text-gray-600 mt-1">When enabled, the timetable generator will try to give each teacher at least one free period per day (excluding breaks).</p>
                                </label>
                            </div>
                        </div>
                        
                        {/* Off Days */}
                        <div>
                          <h3 className="font-semibold text-lg">Off Days</h3>
                          <div className="flex flex-wrap gap-2 mt-2">
                            {weekDays.map(day => (
                              <div key={day} className="flex items-center space-x-2">
                                <input
                                  type="checkbox"
                                  id={day}
                                  checked={offDays.includes(day)}
                                  onChange={(e) => {
                                    if (e.target.checked) {
                                      setOffDays([...offDays, day]);
                                      setHalfDays(halfDays.filter(d => d !== day)); 
                                    } else {
                                      setOffDays(offDays.filter(d => d !== day));
                                    }
                                  }}
                                  className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                />
                                <label htmlFor={day} className="text-sm font-medium">{day}</label>
                              </div>
                            ))}
                          </div>
                        </div>
                      </Card>
                      )}

                      {/* Settings Card 2: Teacher Assignments & Constraints */}
                      {settingsTab === 'assignments' && (
                      <Card className="space-y-6">
                          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h2 className="text-xl sm:text-2xl font-bold text-blue-800">Teacher Assignments & Subject Periods</h2>
                            <Button 
                              onClick={handleAutoFillPeriods}
                              variant="success"
                              className="text-sm whitespace-nowrap"
                            >
                               Auto-Fill Periods
                            </Button>
                          </div>
                          {/* Import/Export for Assignments & Periods */}
                          <div className="flex flex-wrap gap-2">
                            <Button variant="secondary" onClick={() => exportAssignmentsCSV()} className="text-xs px-3 py-2">Export Assignments (CSV)</Button>
                            <div>
                              <Button variant="secondary" onClick={() => document.getElementById('import-assignments-input').click()} className="text-xs px-3 py-2">Import Assignments (CSV)</Button>
                              <input id="import-assignments-input" type="file" accept=".csv" className="hidden" onChange={(e) => importAssignmentsCSV(e)} />
                            </div>
                          </div>
                          <p className="text-sm text-gray-600 bg-blue-50 p-3 rounded-md">
                             <strong>Tip:</strong> Assign teachers to subjects, then click "Auto-Fill Periods" to automatically distribute periods evenly. You can manually adjust the numbers afterward.
                          </p>
                          {classes.length > 0 && subjects.length > 0 ? (
                            <div className="space-y-6">
                              {classes.map(cls => (
                                <div key={cls} className="space-y-3">
                                  <h3 className="text-lg font-bold text-white bg-gradient-to-r from-blue-600 to-indigo-600 px-4 py-2 rounded-lg shadow-sm">{cls}</h3>
                                  <div className="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                                    <table className="min-w-full text-sm">
                                      <thead className="bg-gradient-to-r from-blue-50 to-indigo-50">
                                        <tr>
                                          <th className="px-4 py-3 text-left font-bold text-gray-800 border-r border-gray-200">Subject</th>
                                          <th className="px-4 py-3 text-center font-bold text-blue-700 border-r border-gray-200">Teacher</th>
                                          <th className="px-4 py-3 text-center font-bold text-green-700">Periods/Week</th>
                                        </tr>
                                      </thead>
                                      <tbody className="bg-white divide-y divide-gray-100">
                                        {subjects.map(subject => (
                                          <tr key={subject} className="hover:bg-blue-50/30 transition-colors">
                                            <td className="px-4 py-3 font-semibold text-gray-900 border-r border-gray-200">{subject}</td>
                                            <td className="px-3 py-3 border-r border-gray-200">
                                              <Select
                                                value={assignments[cls]?.[subject] || ''}
                                                onChange={(e) => handleAssignmentChange(cls, subject, e.target.value)}
                                                options={[{ value: '', label: '-- Select Teacher --' }, ...teachers.map(t => ({ value: t, label: t })) ]}
                                                className="w-full text-sm hover:border-blue-400 focus:border-blue-500 transition-colors"
                                              />
                                            </td>
                                            <td className="px-3 py-3">
                                              <Input
                                                type="number"
                                                value={subjectPeriodsPerWeek[cls]?.[subject] || 0}
                                                onChange={(e) => handleSubjectPeriodsPerWeekChange(cls, subject, e.target.value)}
                                                placeholder="0"
                                                className="w-full text-sm text-center font-semibold hover:border-green-400 focus:border-green-500 transition-colors"
                                                min="0"
                                              />
                                            </td>
                                          </tr>
                                        ))}
                                        {/* Total Lectures Row */}
                                        <tr className="bg-gradient-to-r from-green-100 to-emerald-50 border-t-2 border-green-400">
                                          <td colSpan="2" className="px-4 py-3 text-right font-bold text-gray-900 text-base">
                                            Total Lectures in Week:
                                          </td>
                                          <td className="px-3 py-3">
                                            {(() => {
                                              // compute weekly capacity for this class (exclude lunch only)
                                              let capacity = 0;
                                              workingDayLabels.forEach(day => {
                                                const pForDay = halfDays.includes(day) ? halfDayPeriods : periodsPerDay;
                                                if (pForDay > 0) {
                                                  const lunch = (lunchBreakPeriod > 0 && lunchBreakPeriod <= pForDay) ? 1 : 0;
                                                  capacity += (pForDay - lunch);
                                                }
                                              });
                                              const requested = subjects.reduce((total, subject) => total + (parseInt(subjectPeriodsPerWeek[cls]?.[subject]) || 0), 0);
                                              const over = requested > capacity;
                                              return (
                                                <div className={`text-center font-extrabold text-xl ${over ? 'text-red-700 border-red-400' : 'text-green-700 border-green-400'} bg-white px-4 py-2 rounded-md shadow-sm border-2`}>
                                                  {requested} / {capacity}
                                                </div>
                                              );
                                            })()}
                                          </td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>
                                </div>
                              ))}
                            </div>
                          ) : (
                            <div className="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                              <AlertCircleIcon className="w-12 h-12 text-gray-400 mx-auto mb-2" />
                              <p className="text-gray-500 italic">Please add classes and subjects in the settings to make assignments.</p>
                            </div>
                          )}
                          
                          {/* Teacher Start Period Constraint */}
                          <div className="pt-6 border-t">
                              <h2 className="text-xl sm:text-2xl font-bold text-blue-800 mb-3">Teacher Start Time (Late Arrival)</h2>
                              <p className="text-sm text-gray-500 mb-4">Select the earliest period a teacher can start working.</p>
                              <div className="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                                <table className="min-w-full text-sm">
                                  <thead className="bg-gradient-to-r from-purple-50 to-pink-50">
                                    <tr>
                                      <th className="px-4 py-3 text-left font-bold text-gray-800 border-r-2 border-purple-200">Teacher</th>
                                      <th className="px-4 py-3 text-center font-bold text-purple-700">Start Period</th>
                                    </tr>
                                  </thead>
                                  <tbody className="bg-white divide-y divide-gray-100">
                                    {teachers.map(teacher => (
                                      <tr key={teacher} className="hover:bg-purple-50/30 transition-colors">
                                        <td className="px-4 py-3 font-semibold text-gray-900 border-r border-gray-200">{teacher}</td>
                                        <td className="px-3 py-3" style={{minWidth: '180px'}}>
                                          <Select
                                            value={teacherStartPeriod[teacher] || 1}
                                            onChange={(e) => handleTeacherStartPeriodChange(teacher, e.target.value)}
                                            options={[{ value: 1, label: 'Period 1 (Default)' }, ...periodOptions]}
                                            className="w-full text-sm hover:border-purple-400 focus:border-purple-500 transition-colors"
                                          />
                                        </td>
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>
                              </div>
                          </div>
                      </Card>
                      )}
                      {/* Settings Card 3: Fixed Lectures & Restrictions */}
                      {settingsTab === 'constraints' && (
                      <Card className="space-y-6">
                        <h2 className="text-xl sm:text-2xl font-bold text-blue-800">Fixed Constraints & Events</h2>
                        {/* Import/Export for Constraints */}
                        <div className="flex flex-wrap gap-2">
                          <Button variant="secondary" onClick={() => exportConstraintsCSV()} className="text-xs px-3 py-2">Export Constraints (CSV)</Button>
                          <div>
                            <Button variant="secondary" onClick={() => document.getElementById('import-constraints-input').click()} className="text-xs px-3 py-2">Import Constraints (CSV)</Button>
                            <input id="import-constraints-input" type="file" accept=".csv" className="hidden" onChange={(e) => importConstraintsCSV(e)} />
                          </div>
                        </div>

                        {/* Last Period Subject Restriction */}
                        <div className="space-y-3 border-b pb-4">
                            <h3 className="font-semibold text-lg">Last Period Subject Restriction</h3>
                            <p className="text-sm text-gray-500 mb-3">Check subjects that CANNOT be scheduled in the last period for each class.</p>
                            
                            <div className="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                              <table className="min-w-full text-sm">
                                <thead className="bg-gradient-to-r from-red-50 to-orange-50">
                                  <tr>
                                    <th className="px-4 py-3 text-left font-bold text-gray-800 border-r-2 border-red-200 sticky left-0 bg-gradient-to-r from-red-50 to-orange-50 z-10">Class</th>
                                    {subjects.map(subject => (
                                      <th key={subject} className="px-4 py-3 text-center font-bold text-red-700 border-r border-gray-200">
                                        {subject}
                                      </th>
                                    ))}
                                  </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-100">
                                  {classes.map(cls => (
                                    <tr key={cls} className="hover:bg-red-50/30 transition-colors">
                                      <td className="px-4 py-3 font-bold text-gray-900 border-r-2 border-red-200 sticky left-0 bg-gradient-to-r from-red-100 to-red-50 z-10 shadow-sm">{cls}</td>
                                      {subjects.map(subject => (
                                        <td key={subject} className="px-3 py-2 text-center border-r border-gray-100">
                                          <input
                                            type="checkbox"
                                            id={`${cls}-${subject}-last-restrict`}
                                            checked={lastPeriodSubjectRestrictions.some(r => r.className === cls && r.subject === subject)}
                                            onChange={(e) => handleLastPeriodSubjectRestriction(cls, subject, e.target.checked)}
                                            className="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-2 focus:ring-red-500 cursor-pointer transition-all hover:scale-110"
                                          />
                                        </td>
                                      ))}
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                        </div>

                        {/* Fixed First Period Assignment */}
                        <div className="space-y-4 border-b pb-4">
                            <h3 className="font-semibold text-lg">Fixed First Period (Period 1)</h3>
                            <p className="text-sm text-gray-500 mb-3">Fix a specific Subject/Teacher for Period 1 on certain days.</p>

                            {/* Apply to All Classes */}
                            <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg flex flex-col sm:flex-row gap-2 items-stretch sm:items-end">
                              <div className="flex-1">
                                <label className="block text-xs font-semibold text-blue-900 mb-1">Day</label>
                                <Select
                                  value={bulkFirstPeriodDay}
                                  onChange={(e) => setBulkFirstPeriodDay(e.target.value)}
                                  options={[{ value: '', label: 'Select Day' }, ...workingDayLabels.map(d => ({ value: d, label: d })) ]}
                                  className="w-full text-sm"
                                />
                              </div>
                              <div className="flex-1">
                                <label className="block text-xs font-semibold text-blue-900 mb-1">Subject</label>
                                <Select
                                  value={bulkFirstPeriodSubject}
                                  onChange={(e) => setBulkFirstPeriodSubject(e.target.value)}
                                  options={[{ value: '', label: 'Select Subject' }, ...subjects.map(s => ({ value: s, label: s })) ]}
                                  className="w-full text-sm"
                                />
                              </div>
                              <div className="flex-none">
                                <Button onClick={applyFirstPeriodToAllClasses} className="w-full">Apply to All Classes</Button>
                              </div>
                            </div>
                            
                            {/* Clear All First Period Assignments */}
                            <div className="p-3 bg-red-50 border border-red-200 rounded-lg">
                              <div className="flex items-center justify-between">
                                <div>
                                  <h4 className="font-semibold text-red-900">Clear All First Period Assignments</h4>
                                  <p className="text-xs text-red-600">Remove all existing Period 1 assignments to start fresh</p>
                                </div>
                                <Button 
                                  variant="secondary"
                                  onClick={() => {
                                    if (confirm('Are you sure you want to clear ALL first period assignments? This cannot be undone.')) {
                                      setFirstPeriodAssignments({});
                                      alert('All first period assignments have been cleared.');
                                    }
                                  }}
                                  className="bg-red-100 text-red-700 hover:bg-red-200"
                                >
                                  Clear All
                                </Button>
                              </div>
                            </div>
                            
                            {classes.map(cls => (
                              <div key={cls} className="space-y-2">
                                <h4 className="text-md font-bold text-white bg-gradient-to-r from-green-600 to-teal-600 px-4 py-2 rounded-lg shadow-sm">{cls}</h4>
                                {/* Auto-distribute Period 1 by Teacher */}
                                <div className={`flex flex-col sm:flex-row gap-2 items-stretch sm:items-end p-2 border rounded-md ${
                                  selectedAutoDistributeTeacher[cls] 
                                    ? 'bg-green-50 border-green-300' 
                                    : 'bg-teal-50 border-teal-200'
                                }`}>
                                  <div className="flex-1">
                                    <label className="block text-xs font-semibold text-teal-900 mb-1">
                                      Auto-distribute Period 1 by Teacher
                                      {selectedAutoDistributeTeacher[cls] && (
                                        <span className="ml-2 text-green-600 font-bold"> {selectedAutoDistributeTeacher[cls]} selected</span>
                                      )}
                                    </label>
                                    <div className="flex gap-2">
                                    <Select
                                        value={selectedAutoDistributeTeacher[cls] || ''}
                                        onChange={(e) => {
                                          const teacher = e.target.value;
                                          setSelectedAutoDistributeTeacher(prev => ({ ...prev, [cls]: teacher }));
                                          if (teacher) {
                                            autoDistributeFirstPeriodsByTeacher(cls, teacher);
                                          }
                                        }}
                                      options={[{ value: '', label: '-- Select Teacher --' }, ...teachers.map(t => ({ value: t, label: t })) ]}
                                        className="flex-1 text-sm"
                                      />
                                      {selectedAutoDistributeTeacher[cls] && (
                                        <Button
                                          variant="secondary"
                                          onClick={() => {
                                            setSelectedAutoDistributeTeacher(prev => ({ ...prev, [cls]: '' }));
                                          }}
                                          className="text-xs px-2 py-1"
                                        >
                                          Reset
                                        </Button>
                                      )}
                                  </div>
                                  </div>
                                  <div className="text-xs text-gray-600 sm:pb-2">
                                    {selectedAutoDistributeTeacher[cls] 
                                      ? ` Teacher selected - Period 1 will be distributed across their subjects for ${cls}`
                                      : `Evenly assigns Period 1 across this teacher's subjects for ${cls}, proportional to requested counts.`
                                    }
                                    <div className="mt-1 text-xs text-blue-600">
                                       Bulk assignments (applied to all classes) are automatically protected
                                    </div>
                                  </div>
                                </div>
                                <div className="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                                  <table className="min-w-full text-sm">
                                    <thead className="bg-gradient-to-r from-green-50 to-teal-50">
                                      <tr>
                                        <th className="px-4 py-3 text-left font-bold text-gray-800 border-r border-gray-200">Day</th>
                                        <th className="px-4 py-3 text-center font-bold text-green-700 border-r border-gray-200">Subject</th>
                                        <th className="px-4 py-3 text-center font-bold text-teal-700">Teacher</th>
                                      </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-100">
                                      {workingDayLabels.map(day => {
                                        // Check if this day has a bulk assignment
                                        const assignment = firstPeriodAssignments[cls]?.[day];
                                        const isBulkAssignment = assignment && classes.every(c => {
                                          const classAssignment = firstPeriodAssignments[c]?.[day];
                                          return classAssignment && classAssignment.subject === assignment.subject;
                                        });
                                        
                                        return (
                                        <tr key={day} className={`hover:bg-green-50/30 transition-colors ${isBulkAssignment ? 'bg-blue-50 border-l-4 border-blue-400' : ''}`}>
                                          <td className="px-4 py-3 font-semibold text-gray-900 border-r border-gray-200">
                                            {day}
                                            {isBulkAssignment && (
                                              <span className="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                                                 BULK
                                              </span>
                                            )}
                                          </td>
                                          <td className="px-3 py-3 border-r border-gray-200">
                                            <Select
                                              value={firstPeriodAssignments[cls]?.[day]?.subject || ''}
                                              onChange={(e) => {
                                                const subject = e.target.value;
                                                
                                                // Check if max lectures reached for this subject
                                                if (subject) {
                                                  // Count current assignments for this subject in first periods
                                                  let currentCount = 0;
                                                  workingDayLabels.forEach(d => {
                                                    if (firstPeriodAssignments[cls]?.[d]?.subject === subject && d !== day) {
                                                      currentCount++;
                                                    }
                                                  });
                                                  
                                                  // Get max allowed periods for this subject
                                                  const maxPeriods = parseInt(subjectPeriodsPerWeek[cls]?.[subject]) || 0;
                                                  
                                                  // Check if we're exceeding the limit
                                                  if (currentCount >= maxPeriods) {
                                                    alert(` MAX LECTURE REACHED!\n\n${subject} is already assigned ${currentCount} time(s).\nMaximum allowed: ${maxPeriods} lectures per week.`);
                                                    return; // Don't proceed with the change
                                                  }
                                                }
                                                
                                                const teacher = assignments[cls]?.[subject] ?? ''; 
                                                handleFirstPeriodChange(cls, day, 'subject', subject);
                                                handleFirstPeriodChange(cls, day, 'teacher', teacher);
                                              }}
                                              options={[{ value: '', label: '-- None --' }, ...subjects.map(s => ({ value: s, label: s })) ]}
                                              className="w-full text-sm hover:border-green-400 focus:border-green-500 transition-colors"
                                            />
                                          </td>
                                          <td className="px-3 py-3 text-center text-sm text-gray-700 font-medium">
                                            {firstPeriodAssignments[cls]?.[day]?.teacher || '-'}
                                          </td>
                                        </tr>
                                        );
                                      })}
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            ))}
                        </div>
                        
                        {/* Test Day / Event Option */}
                        <div className="space-y-4">
                            <h3 className="font-semibold text-lg">Test Day / Event Blocker</h3>
                            <p className="text-sm text-gray-500">Block a specific period for an event or test for a class.</p>
                            <form onSubmit={addEvent} className="space-y-2">
                                <div className="grid grid-cols-2 gap-2">
                                    <Select name="className" options={[{ value: '', label: 'Select Class' }, ...classes.map(c => ({ value: c, label: c })) ]} />
                                    <Select name="day" options={[{ value: '', label: 'Select Day' }, ...workingDayLabels.map(d => ({ value: d, label: d })) ]} />
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <Select name="period" options={[{ value: '', label: 'Select Period' }, ...periodOptions]} />
                                    <Input name="label" placeholder="Event/Test Label" type="text" />
                                </div>
                                <Button type="submit" variant="success" className="w-full">Add Event</Button>
                            </form>

                            {events.length > 0 && (
                                <div className="space-y-2 max-h-40 overflow-y-auto mt-4 p-2 bg-gray-50 rounded-md">
                                    {events.map((event, index) => (
                                        <div key={index} className="flex justify-between items-center bg-white p-2 rounded-md shadow-sm">
                                            <span className="text-sm">{event.className} - {event.day}, P{event.period}: {event.label}</span>
                                            <button onClick={() => removeEvent(index)} className="text-red-500 hover:text-red-700 p-1 rounded-full">
                                                <TrashIcon className="w-4 h-4" />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Absent Teachers Section */}
                        <div className="space-y-4 pt-6 border-t">
                            <h3 className="text-xl sm:text-2xl font-bold text-red-800">Absent Teachers</h3>
                            <p className="text-sm text-gray-500 mb-3">Check teachers who are currently absent. Their classes will be marked as 'ABSENT' in the timetable.</p>
                            
                            <div className="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                              <table className="min-w-full text-sm">
                                <thead className="bg-gradient-to-r from-red-50 to-pink-50">
                                  <tr>
                                    <th className="px-4 py-3 text-left font-bold text-gray-800 border-r-2 border-red-200">Teacher</th>
                                    <th className="px-4 py-3 text-center font-bold text-red-700">Mark Absent</th>
                                  </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-100">
                                  {teachers.map(teacher => (
                                    <tr key={teacher} className={`hover:bg-red-50/30 transition-colors ${absentTeachers.includes(teacher) ? 'bg-red-50' : ''}`}>
                                      <td className="px-4 py-3 font-semibold text-gray-900 border-r border-gray-200">
                                        <span className="flex items-center gap-2">
                                          <UserIcon className="w-4 h-4 text-gray-600" />
                                          {teacher}
                                          {absentTeachers.includes(teacher) && <span className="ml-2 px-2 py-0.5 text-xs font-bold text-red-700 bg-red-100 rounded-full">ABSENT</span>}
                                        </span>
                                      </td>
                                      <td className="px-3 py-2 text-center">
                                        <input
                                          type="checkbox"
                                          id={`absent-teacher-${teacher}`}
                                          checked={absentTeachers.includes(teacher)}
                                          onChange={(e) => handleAbsentTeacherToggle(teacher, e.target.checked)}
                                          className="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-2 focus:ring-red-500 cursor-pointer transition-all hover:scale-110"
                                        />
                                      </td>
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                        </div>

                        {/* Proxy Teachers Section */}
                        <div className="space-y-4 pt-6 border-t">
                            <h3 className="text-xl sm:text-2xl font-bold text-purple-800">Proxy Teachers</h3>
                            <p className="text-sm text-gray-500">Add teachers who can be assigned as proxies for absent teachers.</p>
                            <div className="space-y-2">
                                <Input
                                  placeholder="Add new proxy teacher"
                                  onKeyDown={(e) => {
                                    if (e.key === 'Enter') {
                                      handleAddProxyTeacher(e.target.value);
                                      e.target.value = '';
                                    }
                                  }}
                                />
                                <div className="flex flex-wrap gap-2 pt-2">
                                  {proxyTeachers.map(proxyTeacher => (
                                    <span key={proxyTeacher} className="bg-purple-100 text-purple-800 px-3 py-1 rounded-full flex items-center space-x-1 text-sm">
                                      <span>{proxyTeacher}</span>
                                      <button onClick={() => handleRemoveProxyTeacher(proxyTeacher)} className="text-purple-500 hover:text-purple-700 font-bold ml-1">
                                        &times;
                                      </button>
                                    </span>
                                  ))}
                                </div>
                            </div>
                        </div>
                      </Card>
                      )}
                    </div>
                  )}
                </div>

                {/* Generate Buttons */}
                <div className="flex flex-col items-center justify-center pt-6 space-y-4">
                  {isGenerating && (
                    <div className="w-full max-w-2xl bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 p-6 rounded-xl shadow-2xl border-2 border-blue-300 animate-fadeIn">
                      <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center space-x-3">
                          <div className="relative">
                            <LoadingSpinner />
                            <div className="absolute inset-0 bg-blue-400 rounded-full blur-md opacity-30 animate-pulse"></div>
                          </div>
                          <div>
                            <div className="text-lg font-bold text-gray-800">
                              {generatingProgress < 100 ? 'Generating Timetable...' : ' Complete!'}
                            </div>
                            <div className="text-xs text-gray-600 animate-pulse">
                              {generatingProgress < 30 && " Analyzing constraints..."}
                              {generatingProgress >= 30 && generatingProgress < 60 && " Placing periods..."}
                              {generatingProgress >= 60 && generatingProgress < 90 && " Optimizing schedule..."}
                              {generatingProgress >= 90 && generatingProgress < 100 && " Finalizing..."}
                              {generatingProgress === 100 && " Timetable ready!"}
                            </div>
                            <div className="text-xs text-gray-700 mt-1">
                              Attempts: {generatingProgress?.current || 0} / {generatingProgress?.total || 0}
                              {generatingProgress?.total > 0 && (
                                <span> ({Math.min(100, Math.floor(((generatingProgress.current || 0) / generatingProgress.total) * 100))}%)</span>
                              )}
                            </div>
                          </div>
                        </div>
                        <div className="flex flex-col items-center">
                          <div className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 animate-pulse">
                            {estimatedTimeLeft}
                          </div>
                          <div className="text-xs text-gray-600 font-semibold">seconds</div>
                        </div>
                      </div>
                      
                      {/* Progress Bar */}
                      <div className="relative w-full h-6 bg-gray-300 rounded-full overflow-hidden shadow-inner">
                        <div 
                          className="absolute top-0 left-0 h-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 transition-all duration-500 ease-out rounded-full shadow-lg"
                          style={{ width: `${generatingProgress}%` }}
                        >
                          {/* Animated shimmer effect */}
                          <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-40 animate-shimmer"></div>
                          {/* Pulse effect */}
                          <div className="absolute inset-0 bg-white opacity-10 animate-pulse"></div>
                        </div>
                        {/* Progress percentage inside bar */}
                        <div className="absolute inset-0 flex items-center justify-center">
                          <span className="text-xs font-bold text-white drop-shadow-lg">{generatingProgress}%</span>
                        </div>
                      </div>
                      
                      <div className="mt-4 text-center">
                        <div className="inline-flex items-center space-x-2 bg-white/60 backdrop-blur-sm px-4 py-2 rounded-full shadow-sm">
                          <div className="flex space-x-1">
                            <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style={{animationDelay: '0ms'}}></div>
                            <div className="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style={{animationDelay: '150ms'}}></div>
                            <div className="w-2 h-2 bg-pink-500 rounded-full animate-bounce" style={{animationDelay: '300ms'}}></div>
                          </div>
                          <span className="text-xs text-gray-700 font-medium">
                            Please wait, this may take a moment...
                          </span>
                        </div>
                        <div className="mt-2 text-[10px] text-gray-500">
                          Trying different outcomes to find the best schedule...
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {!isGenerating && (
                    <div className="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                      <Button 
                        onClick={() => generateTimetable(true)} 
                        className="px-8 py-4 text-lg font-bold bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 w-full sm:w-auto shadow-lg hover:shadow-xl transition-all transform hover:scale-105" 
                        disabled={isGenerating}
                      >
                        <span className="flex items-center justify-center space-x-2">
                          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                          </svg>
                          <span>Generate (Allow Double Periods)</span>
                        </span>
                      </Button>
                      <Button 
                        onClick={() => generateTimetable(false)} 
                        className="px-8 py-4 text-lg font-bold bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 w-full sm:w-auto shadow-lg hover:shadow-xl transition-all transform hover:scale-105" 
                        disabled={isGenerating}
                      >
                        <span className="flex items-center justify-center space-x-2">
                          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                          </svg>
                          <span>Generate (No Double Periods)</span>
                        </span>
                      </Button>
                    </div>
                  )}
                  {timetable && (
                    <div className="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                      <Button
                        variant="secondary"
                        onClick={handleExportAllCSV}
                        className="px-4 py-3 text-sm flex items-center justify-center space-x-2"
                      >
                        <FileTextIcon className="w-4 h-4" />
                        <span>Export All (CSV)</span>
                      </Button>
                      <Button
                        variant="secondary"
                        onClick={handleExportAllHTML}
                        className="px-4 py-3 text-sm flex items-center justify-center space-x-2"
                      >
                        <FileTextIcon className="w-4 h-4" />
                        <span>Export All (HTML)</span>
                      </Button>
                      <Button
                        variant="secondary"
                        onClick={handleExportAll}
                        disabled={isExportingAll || Object.values(isExporting.class).some(Boolean) || Object.values(isExporting.teacher).some(Boolean)}
                        className="px-4 py-3 text-sm flex items-center justify-center space-x-2"
                      >
                        <DownloadIcon className="w-4 h-4" />
                        <span>{isExportingAll ? 'Exporting...' : 'Export All (PDF)'}</span>
                      </Button>
                    </div>
                  )}
                </div>

                {/* Timetable Display Navigation */}
                <div className="pt-8">
                  {redirectNotice && (
                    <div className="mb-4 px-4 py-3 rounded-md bg-blue-50 border border-blue-200 text-blue-800 flex items-start justify-between">
                      <span className="text-sm sm:text-base font-medium">{redirectNotice}</span>
                      <button
                        className="ml-4 text-blue-600 hover:text-blue-800 font-semibold"
                        onClick={() => setRedirectNotice('')}
                      >
                        Dismiss
                      </button>
                    </div>
                  )}
                  {timetable ? (
                    <>
                      <div className="flex flex-col sm:flex-row justify-center flex-wrap gap-2 mb-6">
                        <Button
                          variant={currentView === 'class' ? 'default' : 'secondary'}
                          onClick={() => setCurrentView('class')}
                          className={`w-full sm:w-auto ${currentView === 'class' ? '' : 'text-gray-700'}`}
                        >
                          Class Timetables
                        </Button>
                        <Button
                          variant={currentView === 'allClasses' ? 'default' : 'secondary'}
                          onClick={() => setCurrentView('allClasses')}
                          className={`w-full sm:w-auto ${currentView === 'allClasses' ? '' : 'text-gray-700'}`}
                        >
                          All Classes View
                        </Button>
                        <Button
                          variant={currentView === 'teacher' ? 'default' : 'secondary'}
                          onClick={() => setCurrentView('teacher')}
                          className={`w-full sm:w-auto ${currentView === 'teacher' ? '' : 'text-gray-700'}`}
                        >
                          Teacher Timetables
                        </Button>
                        <Button
                          variant={currentView === 'allTeachers' ? 'default' : 'secondary'}
                          onClick={() => setCurrentView('allTeachers')}
                          className={`w-full sm:w-auto ${currentView === 'allTeachers' ? '' : 'text-gray-700'}`}
                        >
                          All Teachers View
                        </Button>
                        <Button
                          variant={currentView === 'proxy' ? 'default' : 'secondary'}
                          onClick={() => setCurrentView('proxy')}
                          className={`w-full sm:w-auto ${currentView === 'proxy' ? '' : 'text-gray-700'}`}
                        >
                          Proxy Management
                        </Button>
                        <Button
                          variant={currentView === 'analytics' ? 'default' : 'secondary'}
                          onClick={() => setCurrentView('analytics')}
                          className={`w-full sm:w-auto ${currentView === 'analytics' ? '' : 'text-gray-700'}`}
                        >
                          Analytics
                        </Button>
                      </div>

                      {/* View Renderer */}
                      {currentView === 'class' && (
                        <div className="space-y-8">
                          <div className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                            <h2 className="text-xl sm:text-3xl font-bold text-gray-900">Generated Class Timetables</h2>
                            <Button
                              variant={showLectureStats ? 'default' : 'secondary'}
                              onClick={() => setShowLectureStats(!showLectureStats)}
                              className="flex items-center space-x-2 px-4 py-2"
                            >
                              {showLectureStats ? <ToggleRightIcon className="w-5 h-5" /> : <ToggleLeftIcon className="w-5 h-5" />}
                              <span>{showLectureStats ? 'Hide Statistics' : 'Show Statistics'}</span>
                            </Button>
                            {selectedClassFilter && (
                              <Button
                                variant="secondary"
                                onClick={() => setSelectedClassFilter(null)}
                                className="px-4 py-2"
                              >
                                Show All Classes
                              </Button>
                            )}
                          </div>
                            {(selectedClassFilter ? classes.filter(c => c === selectedClassFilter) : classes).map(cls => (
                            <Card key={cls} id={`timetable-class-${makeIdSafe(cls)}`} className="space-y-4 overflow-x-auto">
                              <ClassTimetableTable
                                className={cls}
                                timetableData={timetable}
                                workingDayLabels={workingDayLabels}
                                periodsPerDay={periodsPerDay}
                                onExport={(name) => exportTimetableToPDF(name, 'class')}
                                onExportCSV={exportToCSV}
                                onExportHTML={exportToHTML}
                                isExporting={isExporting.class[cls]}
                                halfDayPeriods={halfDayPeriods}
                                halfDays={halfDays}
                                lunchBreakPeriod={lunchBreakPeriod}
                                breakLabel={breakLabel}
                                absentTeachers={absentTeachers}
                                proxyAssignments={proxyAssignments}
                                onCellClick={openProxyAssignmentModal}
                                originalTimetable={originalTimetable}
                                freeClassReasons={freeClassReasons}
                                subjectPeriodsPerWeek={subjectPeriodsPerWeek}
                                showLectureStats={showLectureStats}
                              />
                            </Card>
                          ))}
                        </div>
                      )}

                      {currentView === 'teacher' && (
                        <div className="space-y-8">
                          <h2 className="text-xl sm:text-3xl font-bold text-center text-gray-900 mb-6">Teacher Timetables</h2>
                          {teacherTimetable ? (
                            <>
                              {selectedTeacherFilter && (
                                <div className="flex justify-end mb-4">
                                  <Button
                                    variant="secondary"
                                    onClick={() => setSelectedTeacherFilter(null)}
                                    className="px-4 py-2"
                                  >
                                    Show All Teachers
                                  </Button>
                                </div>
                              )}
                              <TeacherWorkloadSummary
                                teachers={teachers}
                                teacherTimetable={teacherTimetable}
                                workingDayLabels={workingDayLabels}
                                periodsPerDay={periodsPerDay}
                                halfDayPeriods={halfDayPeriods}
                                halfDays={halfDays}
                                lunchBreakPeriod={lunchBreakPeriod}
                                absentTeachers={absentTeachers}
                                proxyAssignments={proxyAssignments}
                                originalTimetable={originalTimetable}
                              />
                              {(selectedTeacherFilter ? teachers.filter(t => t === selectedTeacherFilter) : teachers).map(teacher => (
                              <Card key={teacher} id={`timetable-teacher-${makeIdSafe(teacher)}`} className="space-y-4 overflow-x-auto">
                                <TeacherTimetableTable
                                  teacherName={teacher}
                                  timetableData={teacherTimetable}
                                  workingDayLabels={workingDayLabels}
                                  periodsPerDay={periodsPerDay}
                                  onExport={(name) => exportTimetableToPDF(name, 'teacher')}
                                  onExportCSV={exportToCSV}
                                  onExportHTML={exportToHTML}
                                  isExporting={isExporting.teacher[teacher]}
                                  halfDayPeriods={halfDayPeriods}
                                  halfDays={halfDays}
                                  lunchBreakPeriod={lunchBreakPeriod}
                                  breakLabel={breakLabel}
                                  absentTeachers={absentTeachers}
                                  proxyAssignments={proxyAssignments}
                                  onCellClick={openProxyAssignmentModal}
                                  originalTimetable={originalTimetable}
                                />
                              </Card>
                            ))}
                            </>
                          ) : (
                            <Card className="text-center p-8 mt-8">
                              <p className="text-2xl font-bold text-red-600">Teacher Timetable Data Missing</p>
                              <p className="mt-2 text-gray-600">Please click one of the 'Generate Timetable' buttons above to generate the teacher data.</p>
                            </Card>
                          )}
                        </div>
                      )}
                      
                      {currentView === 'proxy' && (
                          <ProxyManagementView
                            teachers={teachers}
                            teacherTimetable={teacherTimetable}
                            workingDayLabels={workingDayLabels}
                            periodsPerDay={periodsPerDay}
                            halfDayPeriods={halfDayPeriods}
                            halfDays={halfDays}
                            lunchBreakPeriod={lunchBreakPeriod}
                            breakLabel={breakLabel}
                            absentTeachers={absentTeachers}
                            proxyTeachers={proxyTeachers}
                            proxyAssignments={proxyAssignments}
                            onAssignProxy={handleAssignProxy}
                            onRemoveProxy={handleRemoveProxyAssignment}
                            originalTimetable={originalTimetable}
                            getAvailableProxyTeachersForPeriod={getAvailableProxyTeachersForPeriod}
                            onExportPDF={() => exportConsolidatedViewToPDF('proxy-management-view', 'Proxy_Management', 'proxyManagement')}
                            onExportCSV={() => exportConsolidatedViewToCSV('proxyManagement')}
                            onExportHTML={() => exportConsolidatedViewToHTML('Proxy_Management', 'proxy-management-view')}
                            isExporting={consolidatedExporting.proxyManagement}
                          />
                      )}

                      {currentView === 'allClasses' && (
                        <AllClassesConsolidatedView
                          classes={classes}
                          timetable={timetable}
                          workingDayLabels={workingDayLabels}
                          periodsPerDay={periodsPerDay}
                          halfDayPeriods={halfDayPeriods}
                          halfDays={halfDays}
                          lunchBreakPeriod={lunchBreakPeriod}
                          breakLabel={breakLabel}
                          absentTeachers={absentTeachers}
                          proxyAssignments={proxyAssignments}
                          originalTimetable={originalTimetable}
                          freeClassReasons={freeClassReasons}
                          onExportPDF={() => exportConsolidatedViewToPDF('all-classes-consolidated', 'All_Classes', 'allClasses')}
                          onExportCSV={() => exportConsolidatedViewToCSV('allClasses')}
                          onExportHTML={() => exportConsolidatedViewToHTML('All_Classes', 'all-classes-consolidated')}
                          isExporting={consolidatedExporting.allClasses}
                        />
                      )}

                      {currentView === 'allTeachers' && (
                        <AllTeachersConsolidatedView
                          teachers={teachers}
                          teacherTimetable={teacherTimetable}
                          workingDayLabels={workingDayLabels}
                          periodsPerDay={periodsPerDay}
                          halfDayPeriods={halfDayPeriods}
                          halfDays={halfDays}
                          lunchBreakPeriod={lunchBreakPeriod}
                          breakLabel={breakLabel}
                          absentTeachers={absentTeachers}
                          proxyAssignments={proxyAssignments}
                          originalTimetable={originalTimetable}
                          onExportPDF={() => exportConsolidatedViewToPDF('all-teachers-consolidated', 'All_Teachers', 'allTeachers')}
                          onExportCSV={() => exportConsolidatedViewToCSV('allTeachers')}
                          onExportHTML={() => exportConsolidatedViewToHTML('All_Teachers', 'all-teachers-consolidated')}
                          isExporting={consolidatedExporting.allTeachers}
                        />
                      )}

                      {currentView === 'analytics' && (
                        <AnalyticsView
                          teachers={teachers}
                          classes={classes}
                          timetable={timetable}
                          teacherTimetable={teacherTimetable}
                          workingDayLabels={workingDayLabels}
                          periodsPerDay={periodsPerDay}
                          halfDayPeriods={halfDayPeriods}
                          halfDays={halfDays}
                          lunchBreakPeriod={lunchBreakPeriod}
                          absentTeachers={absentTeachers}
                          proxyAssignments={proxyAssignments}
                          originalTimetable={originalTimetable}
                          freeClassReasons={freeClassReasons}
                        />
                      )}
                    </>
                  ) : (
                    <div className="pt-8">
                      <Card className="text-center p-8">
                        <h2 className="text-2xl font-bold text-gray-900">No Timetable Generated</h2>
                        <p className="mt-2 text-gray-600">Please set up your constraints in the settings and click one of the 'Generate Timetable' buttons above.</p>
                        <p className="mt-4 text-sm text-blue-600 font-medium">Your previous settings have been loaded from local storage! You can generate a timetable immediately.</p>
                      </Card>
                    </div>
                  )}
                </div>
              </div>
              <ProxyAssignmentModal
                isOpen={isProxyModalOpen}
                onClose={() => setIsProxyModalOpen(false)}
                availableTeachers={proxyModalInfo ? getAvailableProxyTeachersForPeriod(proxyModalInfo.day, proxyModalInfo.periodIndex) : []}
                onAssignProxy={handleAssignProxy}
                onRemoveProxy={handleRemoveProxyAssignment}
                periodInfo={proxyModalInfo}
              />
              <ManualPlacementModal
                isOpen={isManualOpen}
                onClose={() => setIsManualOpen(false)}
                classes={classes}
                subjects={subjects}
                teachers={teachers}
                workingDayLabels={workingDayLabels}
                periodsPerDay={periodsPerDay}
                onApply={applyManualPlacement}
                onClear={clearManualPlacement}
                timetable={timetable}
                subjectPeriodsPerWeek={subjectPeriodsPerWeek}
                assignments={assignments}
                halfDayPeriods={halfDayPeriods}
                halfDays={halfDays}
                lunchBreakPeriod={lunchBreakPeriod}
                teacherStartPeriod={teacherStartPeriod}
                lastPeriodSubjectRestrictions={lastPeriodSubjectRestrictions}
                ensureTeacherFreePeriod={ensureTeacherFreePeriod}
              />
            </div>
          );
        };

        // SECTION CSV EXPORT/IMPORT HELPERS
        const exportSchoolDetailsCSV = () => {
          const rows = [];
          rows.push(['Teachers', teachers.join(';')]);
          rows.push(['Classes', classes.join(';')]);
          rows.push(['Subjects', subjects.join(';')]);
          rows.push(['PeriodsPerDay', periodsPerDay]);
          rows.push(['HalfDayPeriods', halfDayPeriods]);
          rows.push(['WorkingDays', workingDays]);
          rows.push(['OffDays', offDays.join(';')]);
          rows.push(['HalfDays', halfDays.join(';')]);
          rows.push(['LunchBreakPeriod', lunchBreakPeriod]);
          rows.push(['BreakLabel', breakLabel]);
          rows.push(['EnsureTeacherFreePeriod', ensureTeacherFreePeriod]);
          const csv = 'Setting,Value\n' + rows.map(r => `${r[0]},"${String(r[1]).replace(/"/g,'""')}"`).join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'school-details.csv';
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        const importSchoolDetailsCSV = (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const textRaw = String(ev.target.result||'');
              const text = textRaw.replace(/^\ufeff/, '');
              const lines = text.split(/\r?\n/).map(l => l.trim());
              const nonEmpty = lines.filter(Boolean);

              // Matrix header detection
              const idxHeader = nonEmpty.findIndex(l => /^,?Teachers,Classes,Subjects,PeriodsPerDay,HalfDayPeriods,WorkingDays,OffDays,HalfDays,LunchBreakPeriod,BreakLabel,EnsureTeacherFreePeriod(,|$)/i.test(l));
              if (idxHeader !== -1 && nonEmpty[idxHeader+1]) {
                const parts = nonEmpty[idxHeader+1].split(',').map(s => s.replace(/^"|"$/g,'').trim());
                const get = (i) => parts[i] || '';
                setTeachers(get(1).split(';').filter(Boolean));
                setClasses(get(2).split(';').filter(Boolean));
                setSubjects(get(3).split(';').filter(Boolean));
                setPeriodsPerDay(Math.max(1, parseInt(get(4))||1));
                setHalfDayPeriods(Math.max(0, parseInt(get(5))||0));
                setWorkingDays(Math.max(1, parseInt(get(6))||1));
                setOffDays(get(7).split(';').filter(Boolean));
                setHalfDays(get(8).split(';').filter(Boolean));
                setLunchBreakPeriod(Math.max(0, parseInt(get(9))||0));
                setBreakLabel(get(10));
                setEnsureTeacherFreePeriod(String(get(11)).toLowerCase()==='true' || get(11)==='1');
                alert('School details imported');
              } else {
                // Legacy key,value rows (with optional header)
                const start = nonEmpty[0] && /setting\s*,\s*value/i.test(nonEmpty[0]) ? 1 : 0;
                const map = {};
                nonEmpty.slice(start).forEach(line => {
                  const m = line.match(/^([^,]+),(.+)$/);
                  if (!m) return;
                  const key = m[1].trim();
                  const val = m[2].trim().replace(/^"|"$/g,'');
                  map[key] = val;
                });
                if (map.Teachers) setTeachers(map.Teachers.split(';').filter(Boolean));
                if (map.Classes) setClasses(map.Classes.split(';').filter(Boolean));
                if (map.Subjects) setSubjects(map.Subjects.split(';').filter(Boolean));
                if (map.PeriodsPerDay) setPeriodsPerDay(Math.max(1, parseInt(map.PeriodsPerDay)||1));
                if (map.HalfDayPeriods) setHalfDayPeriods(Math.max(0, parseInt(map.HalfDayPeriods)||0));
                if (map.WorkingDays) setWorkingDays(Math.max(1, Math.min(7, parseInt(map.WorkingDays)||1)));
                if (map.OffDays) setOffDays(map.OffDays.split(';').filter(Boolean));
                if (map.HalfDays) setHalfDays(map.HalfDays.split(';').filter(Boolean));
                if (map.LunchBreakPeriod!==undefined) setLunchBreakPeriod(Math.max(0, parseInt(map.LunchBreakPeriod)||0));
                if (map.BreakLabel!==undefined) setBreakLabel(map.BreakLabel);
                if (map.EnsureTeacherFreePeriod!==undefined) setEnsureTeacherFreePeriod(map.EnsureTeacherFreePeriod==='true');
                alert('School details imported');
              }
            } catch(err){
              alert('Failed to import School Details CSV');
            } finally {
              e.target.value = '';
            }
          };
          reader.readAsText(file);
        };

        const exportAssignmentsCSV = () => {
          // Build header: blank, Class, subjects..., Total
          const header = ['','Class', ...subjects, 'Total'];
          const rows = [header];
          classes.forEach((cls, idx) => {
            const teacherRow = [String(idx + 1), cls];
            subjects.forEach(sub => {
              teacherRow.push(assignments?.[cls]?.[sub] || '');
            });
            teacherRow.push('');
            rows.push(teacherRow);

            const periodsRow = ['', ''];
            let total = 0;
            subjects.forEach(sub => {
              const periods = Math.max(0, parseInt(subjectPeriodsPerWeek?.[cls]?.[sub]) || 0);
              periodsRow.push(String(periods));
              total += periods;
            });
            periodsRow.push(String(total));
            rows.push(periodsRow);
          });

          const escapeCell = (v) => `"${String(v ?? '').replace(/\"/g,'\"\"')}"`;
          const csv = rows.map(r => r.map(escapeCell).join(',')).join('\r\n');
          const bom = '\ufeff';
          const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='Assignments_Matrix.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        const importAssignmentsCSV = (e) => {
          const file = e.target.files?.[0]; if(!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const textRaw = String(ev.target.result||'');
              const text = textRaw.replace(/^\ufeff/, '');
              const lines = text.split(/\r?\n/).map(l=>l.trim());
              const nonEmpty = lines.filter(Boolean);

              const newAssignments = {};
              const newPeriods = {};

              // Detect matrix header: blank,Class,subjects...,Total
              const header = nonEmpty[0] || '';
              const headerParts = header.split(',').map(s => s.replace(/^"|"$/g,''));
              const isMatrix = headerParts.length >= 3 && headerParts[1] === 'Class';
              if (isMatrix) {
                const subjectsFromHeader = headerParts.slice(2, -1);
                for (let i = 1; i < nonEmpty.length; i += 2) {
                  const teacherRow = (nonEmpty[i] || '').split(',').map(s => s.replace(/^"|"$/g,''));
                  const periodsRow = (nonEmpty[i+1] || '').split(',').map(s => s.replace(/^"|"$/g,''));
                  if (teacherRow.length < 2) continue;
                  const cls = teacherRow[1];
                  if (!cls) continue;
                  if (!newAssignments[cls]) newAssignments[cls] = {};
                  if (!newPeriods[cls]) newPeriods[cls] = {};
                  subjectsFromHeader.forEach((sub, idx) => {
                    const teacher = teacherRow[2 + idx] || '';
                    const periods = Math.max(0, parseInt(periodsRow[2 + idx])||0);
                    if (sub) {
                      newAssignments[cls][sub] = teacher;
                      newPeriods[cls][sub] = periods;
                    }
                  });
                }
              } else {
                // Legacy: Class,Subject,Teacher,PeriodsPerWeek
                if (!header.toLowerCase().includes('class,subject,teacher')) throw new Error('Invalid header');
                nonEmpty.slice(1).forEach(line => {
                  const parts = line.split(',');
                  if (parts.length < 4) return;
                  const cls = parts[0].trim();
                  const sub = parts[1].trim();
                  const teacher = parts[2].trim().replace(/^"|"$/g,'');
                  const periods = Math.max(0, parseInt(parts[3])||0);
                  if (!newAssignments[cls]) newAssignments[cls] = {};
                  if (!newPeriods[cls]) newPeriods[cls] = {};
                  newAssignments[cls][sub] = teacher;
                  newPeriods[cls][sub] = periods;
                });
              }

              setAssignments(newAssignments);
              setSubjectPeriodsPerWeek(newPeriods);
              alert('Assignments imported');
            } catch(err){ alert('Failed to import Assignments CSV'); }
            finally { e.target.value=''; }
          };
          reader.readAsText(file);
        };

        const exportConstraintsCSV = () => {
          let csv = 'Type,Col1,Col2,Col3\n';
          // firstPeriodAssignments
          Object.keys(firstPeriodAssignments||{}).forEach(cls => {
            Object.keys(firstPeriodAssignments[cls]||{}).forEach(day => {
              const fp = firstPeriodAssignments[cls][day];
              if (fp && (fp.subject||fp.teacher)) csv += `FirstPeriod,${cls},${day},${fp.subject}|${fp.teacher||''}\n`;
            });
          });
          // lastPeriodSubjectRestrictions
          (lastPeriodSubjectRestrictions||[]).forEach(r => {
            csv += `LastPeriodRestriction,${r.className},${r.subject},-\n`;
          });
          // events
          (events||[]).forEach(ev => {
            csv += `Event,${ev.className},${ev.day},P${ev.period}\n`;
          });
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='constraints.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        const importConstraintsCSV = (e) => {
          const file = e.target.files?.[0]; if(!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const textRaw = String(ev.target.result||'');
              const text = textRaw.replace(/^\ufeff/, '');
              const lines = text.split(/\r?\n/).map(l=>l.trim());
              const nonEmpty = lines.filter(l=>l.length>0);

              const fpNew = {};
              const restrNew = [];
              const eventsNew = [];

              let i = 0;
              // FirstPeriod Assignments
              const title1 = nonEmpty[i]||'';
              if (/^,?FirstPeriod Assignments/i.test(title1)) {
                i += 1; // skip title
                const header = (nonEmpty[i++]||'').split(',').map(s=>s.replace(/^"|"$/g,''));
                const days = header.slice(2);
                while (i < nonEmpty.length && nonEmpty[i] && !/^,?LastPeriod Restrictions/i.test(nonEmpty[i])) {
                  const parts = nonEmpty[i++].split(',').map(s=>s.replace(/^"|"$/g,''));
                  const cls = parts[1];
                  days.forEach((day, idx) => {
                    const cell = parts[2+idx]||'';
                    const m = cell.match(/^(.*?)\s*\((.*?)\)$/);
                    const subject = m ? m[1] : (cell||'');
                    const teacher = m ? m[2] : '';
                    if (subject || teacher) {
                      if (!fpNew[cls]) fpNew[cls] = {};
                      fpNew[cls][day] = { subject, teacher };
                    }
                  });
                }
              }

              // LastPeriod Restrictions
              while (i < nonEmpty.length && nonEmpty[i] === '') i++;
              if (/^,?LastPeriod Restrictions/i.test(nonEmpty[i]||'')) {
                i += 2; // skip title + header
                while (i < nonEmpty.length && nonEmpty[i] && !/^,?Events/i.test(nonEmpty[i])) {
                  const parts = nonEmpty[i++].split(',').map(s=>s.replace(/^"|"$/g,''));
                  if (parts.length >= 3) restrNew.push({ className: parts[1], subject: parts[2] });
                }
              }

              // Events
              while (i < nonEmpty.length && nonEmpty[i] === '') i++;
              if (/^,?Events/i.test(nonEmpty[i]||'')) {
                i += 2; // skip title + header
                while (i < nonEmpty.length && nonEmpty[i]) {
                  const parts = nonEmpty[i++].split(',').map(s=>s.replace(/^"|"$/g,''));
                  if (parts.length >= 5) {
                    const p = parseInt((parts[3]||'').replace(/^P/,''))||0;
                    eventsNew.push({ className: parts[1], day: parts[2], periodIndex: Math.max(0, p-1), label: parts[4]||'Event' });
                  } else break;
                }
              }

              setFirstPeriodAssignments(fpNew);
              setLastPeriodSubjectRestrictions(restrNew);
              setEvents(eventsNew);
              alert('Constraints imported');
            } catch(err){ alert('Failed to import Constraints CSV'); }
            finally { e.target.value=''; }
          };
          reader.readAsText(file);
        };
        // The main App component that handles navigation
        const App = () => {
          const [currentPage, setCurrentPage] = useState(loadState() ? 'app' : 'landing'); // Start on app if state is loaded
          const [isSidebarOpen, setIsSidebarOpen] = useState(false);
          const sidebarRef = useRef(null);

          const renderPage = () => {
            switch (currentPage) {
              case 'app':
                return <TimetableApp />;
              default:
                return <LandingPage onNavigate={handleNavigate} />;
            }
          };

          const handleNavigate = (page) => {
            setCurrentPage(page);
            setIsSidebarOpen(false); // Close sidebar on navigation
          };

          useEffect(() => {
            const handleResize = () => {
              if (window.innerWidth >= 768) { // md breakpoint in Tailwind
                setIsSidebarOpen(true);
              } else {
                setIsSidebarOpen(false);
              }
            };
            window.addEventListener('resize', handleResize);
            handleResize(); // Set initial state
            return () => window.removeEventListener('resize', handleResize);
          }, []);

          // Close sidebar on outside click
          useEffect(() => {
            const handleClickOutside = (event) => {
              if (sidebarRef.current && !sidebarRef.current.contains(event.target)) {
                if (window.innerWidth < 768) {
                    setIsSidebarOpen(false);
                }
              }
            };
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
          }, [isSidebarOpen]);

          const isLandingPage = currentPage === 'landing';

          // Read saved teachers/classes for App-level search (TimetableApp owns the state)
          const appSavedState = loadState() || {};
          const appTeachers = Array.isArray(appSavedState.teachers) ? appSavedState.teachers : [];
          const appClasses = Array.isArray(appSavedState.classes) ? appSavedState.classes : [];

          return (
            <div className="flex flex-col md:flex-row min-h-screen bg-gray-50 font-sans text-gray-800">
              {/* Mobile Header and Sidebar Toggle */}
              {!isLandingPage && (
                <div className="md:hidden flex items-center justify-between p-4 bg-white shadow-lg sticky top-0 z-50">
                  <span className="text-xl font-bold text-blue-600">Ayaan-G time table maker.</span>
                  <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    {isSidebarOpen ? <XIcon /> : <MenuIcon />}
                  </button>
                </div>
              )}

              {/* Sidebar */}
              <aside
                ref={sidebarRef}
                className={`fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-xl transform transition-transform duration-300 ease-in-out md:static md:translate-x-0 md:w-64 md:border-r md:shadow-none p-4 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} ${isLandingPage ? 'hidden' : ''}`}
              >
                <div className="flex flex-col h-full">
                  <div className="flex items-center justify-between md:justify-center mb-6">
                    <span className="text-2xl font-bold text-blue-600">Ayaan-G time table maker.</span>
                    <button onClick={() => setIsSidebarOpen(false)} className="p-2 rounded-md hover:bg-gray-200 focus:outline-none md:hidden">
                      <XIcon />
                    </button>
                  </div>
                  <nav className="flex-1 space-y-2">
                    <Button
                      variant="outline"
                      className={`flex items-center justify-start w-full space-x-3 text-lg py-3 ${currentPage === 'landing' ? 'bg-gray-100' : ''}`}
                      onClick={() => handleNavigate('landing')}
                    >
                      <HomeIcon className="w-5 h-5" />
                      <span>Home</span>
                    </Button>
                    <Button
                      variant="outline"
                      className={`flex items-center justify-start w-full space-x-3 text-lg py-3 ${currentPage === 'app' ? 'bg-gray-100' : ''}`}
                      onClick={() => handleNavigate('app')}
                    >
                      <CalendarIcon className="w-5 h-5" />
                      <span>Timetable App</span>
                    </Button>
                    

                  </nav>
                </div>
              </aside>

              {/* Main Content Area */}
              <main className="flex-1 overflow-y-auto">
                {/* Landing-page Search section removed; using ribbon Find above */}
                
                {isLandingPage ? (
                  renderPage()
                ) : (
                  <div className="max-w-7xl mx-auto p-4 md:p-6">
                    {renderPage()}
                  </div>
                )}
              </main>

              {/* Overlay for mobile view when sidebar is open */}
              {isSidebarOpen && (
                <div onClick={() => setIsSidebarOpen(false)} className="fixed inset-0 bg-black/50 z-40 md:hidden"></div>
              )}
            </div>
          );
        };


        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
